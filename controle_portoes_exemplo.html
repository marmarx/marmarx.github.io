<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="author" content="Marco Martins">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Port천es</title>
<style>
  body { margin: 0; padding: 0; display: flex; flex-direction: column; width: 100vw }

  h1 {
    min-inline-size: fit-content; margin: auto;
    font-size: clamp(1.8rem, 5vw + 1rem, 5rem)
  }
  h1, h2 { text-wrap: balance }
  h2, p { font-size: clamp(1.2rem, 1vw + .5rem, 3rem); line-height: clamp(1.4rem, 1vw +.7rem, 3.2rem)}
  h2 { font-weight: bold }
  p { min-inline-size: fit-content; text-wrap: pretty }
  
  #gates {
    width: clamp(250px, 80%, 1200px);
    margin: auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: clamp(1rem, 10vw, 2rem);
    place-items: center;
  }
  .gate {
    display: grid;
    grid-template-rows: subgrid;
    grid-row: span 5;
    gap: 0;
    padding: clamp(.5rem, 5vw, 1rem);
    border: 1px solid #ccc;
    border-radius: 6px;
    background-position: 0 0;
    background-size: 200% 100%;
    background-image: linear-gradient(
      to right, #ff6347 0%, #ff6347 50%, #4682b4 50%, #4682b4 100%
    );
  }
  .gate.fechado  { background-position: 0 0 }
  .gate.aberto   { background-position: -100% 0 }
  .gate.abrindo  { animation: slideBg 2s linear forwards; }
  .gate.fechando { animation: slideBg 2s linear reverse forwards; }

  @keyframes slideBg {
    from { background-position: 0 0; }
    to { background-position: -100% 0; }
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  
<h1>Controle de Port천es</h1>
<div id="gates"></div>

<script>
const gates = [
  { id: 1, local: "Frente A", condominio: "Residencial Sol", estado:'fechado', conflitos: [2] },
  { id: 2, local: "Frente B", condominio: "Residencial Sol", estado:'fechado', conflitos: [1] },
  { id: 3, local: "Fundos", condominio: "Residencial Sol", estado:'fechado', conflitos: [] }
];

const getGate = (id) => gates.find(g => g.id === id);

/* retorna nomes dos port천es em conflito */
const getConflicts = (g) => (g.conflitos || []).map(cid => {
  const c = getGate(cid);
  return c ? c.local : `(id ${cid} n찾o encontrado)`;
});

/* true se existir conflito aberto */
const hasOpenConflict = (g) => (g.conflitos || []).some(cid => {
    const c = getGate(cid);
    return c && !(c.estado === 'fechado');
  });

const canOpen = (gate) => !hasOpenConflict(gate);

const newStatus = (g, status) => {
  g.estado = status;
  syncUI(g);
}

function toggleGate(id) {
  const g = getGate(id);
  if (!g) return;

  if (g.estado === "fechado") {
    if (hasOpenConflict(g)) return alert("Conflito ativo");
    newStatus(g, "abrindo...");
    setTimeout(() => newStatus(g, "aberto"), 2000);

  } else if (g.estado === "aberto") {
    newStatus(g, "fechando...");
    setTimeout(() => newStatus(g, "fechado"), 2000);
  }
}


function syncUI(g) {
  const el = document.querySelector(`.gate[data-id="${g.id}"]`);
  if (!el) return
  
  el.querySelector(".title").textContent = g.condominio;
  el.querySelector(".local").textContent = g.local;
  el.querySelector(".status").textContent = g.estado;
  el.querySelector(".conflicts").textContent = getConflicts(g).join(", ") || "Nenhum";

  const state = g.estado.replace(/\./g, '')
  el.classList.remove('fechado', 'abrindo', 'aberto', 'fechando');
  el.offsetHeight; // reflow force
  el.classList.add(state);
  
  const btn = el.querySelector("button");
  const closing = g.estado === "fechado" || g.estado === "fechando...";
  btn.textContent = closing ? "Abrir" : "Fechar";
  btn.onclick = () => toggleGate(g.id);

  gates.forEach(gate => {
    const elem = document.querySelector(`.gate[data-id="${gate.id}"]`);
    if(!elem) return
    
    const conflictOpen = hasOpenConflict(gate);
    const busy = gate.estado === "abrindo..." || gate.estado === "fechando...";

    const button = elem.querySelector("button");
    button.disabled = busy || (gate.estado === "fechado" && hasOpenConflict(gate));
  });
}

function renderInitial() {
  const container = document.getElementById("gates");
  container.innerHTML = "";

  gates.forEach(g => {
    const div = document.createElement("div");
    div.className = "gate fechado";
    div.dataset.id = g.id;

    div.innerHTML = `
      <h2 class="title"></h2>
      <p><b>Local:</b> <span class="local"></span></p>
      <p><b>Status:</b> <span class="status"></span></p>
      <p><b>Conflitos:</b> <span class="conflicts"></span></p>
      <button></button>
    `;

    container.appendChild(div);
  });
  
  gates.forEach(g => syncUI(g));
}

renderInitial();

</script>

</body>
</html>
