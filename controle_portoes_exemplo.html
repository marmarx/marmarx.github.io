<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="author" content="Marco Martins">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Port천es</title>
<style>
  body { font-family: Arial; padding: 20px }
  #gates {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  .gate {
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 6px;
    background-position: 0 0;
    background-size: 200% 100%;
    background-image: linear-gradient(
      to right, #ff6347 0%, #ff6347 50%, #4682b4 50%, #4682b4 100%
    );
  }
  .gate.aberto { background-position: -100% 0 }
  .gate.fechado { background-position: 0 0 }

  .gate.abrindo { animation: slideBg 2s linear forwards; }
  .gate.fechando { animation: slideBg 2s linear reverse forwards; }

  @keyframes slideBg {
    from { background-position: 0 0; }
    to { background-position: -100% 0; }
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<h2>Controle de Port천es</h2>
<div id="gates"></div>

<script>
const gates = [
  { id: 1, local: "Frente A", condominio: "Residencial Sol", estado:'fechado', conflitos: [2] },
  { id: 2, local: "Frente B", condominio: "Residencial Sol", estado:'fechado', conflitos: [1] },
  { id: 3, local: "Fundos",  condominio: "Residencial Sol", estado:'fechado', conflitos: [] }
];

const getGate = (id) => gates.find(g => g.id === id);

/* retorna nomes dos port천es em conflito */
const getConflicts = (g) => (g.conflitos || []).map(cid => {
  const c = getGate(cid);
  return c ? c.local : `(id ${cid} n찾o encontrado)`;
});

/* true se existir conflito aberto */
const hasOpenConflict = (g) => (g.conflitos || []).some(cid => {
    const c = getGate(cid);
    return c && !(c.estado === 'fechado');
  });

const canOpen = (gate) => !hasOpenConflict(gate);

function toggleGate(id) {
  const g = getGate(id);
  if (!g) return;

  if (g.estado === "fechado") {
    if (hasOpenConflict(g)) return alert("Conflito ativo");
    g.estado = "abrindo...";
    syncUI(g);

    setTimeout(() => {
      g.estado = "aberto";
      syncUI(g);
    }, 2000);

  } else if (g.estado === "aberto") {
    g.estado = "fechando...";
    syncUI(g);

    setTimeout(() => {
      g.estado = "fechado";
      syncUI(g);
    }, 2000);
  }
}


function syncUI(g) {
    const el = document.querySelector(`.gate[data-id="${g.id}"]`);
    const btn = el.querySelector("button");

    const conflictOpen = hasOpenConflict(g);

    el.querySelector(".title").textContent = g.condominio;
    el.querySelector(".local").textContent = g.local;
    el.querySelector(".status").textContent = g.estado;
    el.querySelector(".conflicts").textContent = getConflicts(g).join(", ") || "Nenhum";

    const busy = g.estado === "abrindo..." || g.estado === "fechando...";
    const closing = g.estado === "fechado" || g.estado === "fechando...";

    btn.textContent = closing ? "Abrir" : "Fechar";
    btn.disabled = busy || (g.estado === "fechado" && hasOpenConflict(g));
    btn.onclick = () => toggleGate(g.id);

    //const state = g.estado.replace(/\.+$/, '')
    const state = g.estado.replace(/\./g, '')
  
    el.classList.remove('fechado', 'abrindo', 'aberto', 'fechando');
    el.offsetHeight; // reflow force
    el.classList.add(state);
}

function renderInitial() {
  const container = document.getElementById("gates");
  container.innerHTML = "";

  gates.forEach(g => {
    const div = document.createElement("div");
    div.className = "gate fechado";
    div.dataset.id = g.id;

    div.innerHTML = `
      <strong class="title"></strong><br>
      Local: <span class="local"></span><br>
      Status: <span class="status"></span><br>
      Conflitos: <span class="conflicts"></span><br><br>
      <button></button>
    `;

    container.appendChild(div);
    syncUI(g);
  });
}

renderInitial();

</script>

</body>
</html>
