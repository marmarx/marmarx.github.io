<!DOCTYPE html>
<html>
<head>
<title>Ficha T20 Mobile - v0.9</title>
<meta name="author" content="Marco Martins">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#b72a2b">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="icon" type="image/png" href="src/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@500;600&family=Open+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="src/css.css">
<script type="text/javascript" src="db/skills.txt"></script>
<script type="text/javascript" src="db/conditions.txt"></script>
<script type="text/javascript" src="db/spells.txt"></script>
<script type="text/javascript" src="db/feats.txt"></script>
<script type="text/javascript" src="db/geral.txt"></script>

<style>
@font-face{font-family:'tormenta20';src:url('src/Tormenta20.ttf') format('truetype');font-weight:normal;font-style:normal}
:root{--t20:#b72a2b;--black:#292929;--white:#fff;--transwhite:#ffffff80;--drawer:#dbdbdb;--diceroller:#e9e9e9;--overlay:#e8e8e8;--menu:#b72a2b;--bright:brightness(1.1);--t20white:#fff;--t20weight:400;--yellow:#f0dc82;--green:#2ecb57;--pv:#FF4466;--pm:#4BC7CF;--menulen:900%}

*,*:before,*:after{margin:0;padding:0;transition:all .7s ease-in-out,display 0s;font-family:'Open Sans', sans-serif;word-wrap:normal;word-break:keep-all;box-sizing:border-box}
html,body{overflow-x:hidden;width:100vw;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#bbb}::-webkit-scrollbar-thumb:hover{background:#999}
::-webkit-scrollbar:horizontal,::-webkit-scrollbar-thumb:horizontal{display:none}
body::-webkit-scrollbar{display:none}
br{content:'';display:block;margin:6px 0;line-height:2.2em}
div[onclick]{cursor:pointer}
input[type="number"],input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;-moz-appearance:textfield}

.row{display:grid;position:relative;width:100%}
.container{margin:auto;width:85%;display:inline-flex;max-width:600px}
.half,.third{float:left;width:100%}

table{margin:auto;width:80%}
td,th{text-align:center;padding:5px}
tr:nth-child(even){background-color:rgba(0,0,0,.1)}

.divider{width:70%;max-width:500px;height:2px;margin:2.5em auto;background:rgba(32,32,32,.2)}
.t20box{margin:15px auto;border:30px solid transparent;padding:0 40px;background-color:var(--menu);color:var(--t20white);background-clip:padding-box;border-image:var(--backborder);max-width:600px}

h1,h2{text-align:center;margin:0 0 .6em;letter-spacing:4px;font-family:'tormenta20';color:var(--menu);font-size:3em;font-weight:500;filter:var(--bright)}
h1{font-size:2.6em}h2{font-size:1.8em}
p,li{line-height:1.8em;letter-spacing:.8px;text-align:justify;font-size:1.2em;font-weight:500;margin:.5em 0;color:currentColor}
ul{margin:2em}b,.bold{font-weight:bold}i,.italic{font-style:italic}
.t20box *{font-weight:var(--t20weight)!important}.t20box h2{color:var(--yellow);font-weight:400!important}

#sections{width:var(--menulen);position:relative;display:flex}
.sec{width:100%;min-height:100%;float:left;padding:35px 25px 125px 25px;background:url("src/paper.png") no-repeat 0/cover fixed;background-position:center}

#dice_roller,#drawer{border-top-left-radius:25px;border-top-right-radius:25px}
#dice_roller{position:fixed;width:100%;height:105px;background:var(--diceroller);bottom:0}
#drawer{width:100%;height:35px;padding:15px 30%;background:var(--drawer)}.drew{height:90%!important}
#drawer div{width:100%;max-width:500px;height:100%;margin:auto;background:var(--white);border-radius:5px}
#dice{position:relative;padding:0 25px;width:100%;bottom:0}
#dice-input{position:absolute;bottom:0;padding:1.1em 1.3em;background:#ffffffd9}
#dice-input:after{content:'';animation:blink 1s step-end infinite;border-left:2px solid #000}@keyframes blink{from,to{border-color:transparent}50%{border-color:#000}}
#allrolls{bottom:60.06px;height:calc(100% - 60.06px);overflow-x:hidden;overflow-y:scroll;position:relative;top:0}
#results{position:relative;width:100%;padding:5px 25px}#results p:empty{height:5px}
#diceholder{position:relative;height:calc(100% - 105px);overflow:hidden}.diceholder{height:calc(100% - 242px)!important}
.rot{color:#ef1313}
.grun{color:#35a90f}
.magic{display:inline-block;position:absolute;padding:4px 0 0 4px}
.strike{text-decoration:line-through}

#keyboard,#keyboard2{width:100%;height:206px;padding:3px;background:#403f3f;position:fixed;bottom:-206px}.keyboard{width:100%;max-width:500px}.boardshow{bottom:0!important}.keybar{float:left}
.key{vertical-align:top;justify-content:center;align-items:center;display:inline-flex;cursor:pointer;border-radius:4px;margin:3px;max-width:120px;position:relative;padding:0;color:#fff;font-size:1.4em}
.dkey:after{content:'';top:10px;right:10px;position:absolute;width:8px;height:8px;background:rgba(0,0,0,0.4);border-radius:50%}.nkey:after{background:#08ff00}
.keybar:nth-child(1){width:75%}.keybar:nth-child(2){width:25%}.hkey{display:none}
.skey,.lkey{height:44px;width:calc(33.33% - 6px);background:rgba(255,255,255,0.2)}.xkey{width:calc(100% - 6px);height:44px;background:rgba(255,255,255,.1)}
.keyext .keybar:nth-child(1){width:60%}.keyext .keybar:nth-child(2){width:40%}.keyext .hkey{display:inline-flex}
.keyext .xkey{width:calc(50% - 6px);height:34px;font-size:1.1em}
.enter{box-sizing:border-box;position:relative;display:block;width:22px;height:22px}
.enter::after,.enter::before{content:"";display:block;box-sizing:border-box;position:absolute;left:3px}
.enter::after{width:8px;height:8px;border-bottom:2px solid;border-left:2px solid;transform:rotate(45deg);bottom:3px}
.enter::before{width:16px;height:12px;border-bottom-right-radius:4px;border-bottom:2px solid;border-right:2px solid;bottom:6px}
.backspace{box-sizing:border-box;position:relative;display:block;width:14px;height:14px;border:2px solid;border-left:0;border-top-right-radius:2px;border-bottom-right-radius:2px;transform:scale(1.1);left:3px}
.backspace::after,.backspace::before{content:"";display:block;box-sizing:border-box;position:absolute;left:1px}
.backspace::before{background:linear-gradient(to left,currentColor 18px,transparent 0) no-repeat center center/10px 2px;border-right:3px solid transparent;box-shadow:inset 0 0 0 2px;right:2px;bottom:1px;width:8px;height:8px;border-left:3px solid transparent;transform:rotate(45deg)}
.backspace::after{width:10px;height:10px;border-top:2px solid;border-left:2px solid;border-top-left-radius:1px;transform:rotate(-45deg);top:0;left:-5px}

nav{position:fixed;left:0;bottom:0;height:70px;width:100%;background:var(--white);border-top:1px solid #EBEBEB;overflow-x:scroll;overflow-y:hidden;display:grid}
#menu{display:inline-flex;width:100%;max-width:1000px;margin:auto} /*width:160%*/
.menubtn{width:16.6666%;max-width:150px;height:70px;float:left;display:inline-flex;cursor:pointer}.menubi{margin:auto} /*width:20%*/
.menuicon{color:#b0b0b0;width:fit-content;margin:auto}
.menuicon svg{display:block;height:24px;width:24px;overflow:visible;fill:currentcolor}
.menuicon path{color:#b0b0b0}.menuselicon path{color:var(--menu);filter:var(--bright)}
.menutext{font-size:.625em;font-weight:600;color:#717171;margin-top:.2em;padding:.1em 0 .5em}.menuseltext{font-weight:700}

#spells_list,#powers_list{display:block}
.spell,.power{cursor:pointer;border:1px solid transparent;border-radius:10px}
.more_info{border-color:rgba(32,32,32,.4);margin:.5em 0}
.item_subtitle{margin:0;font-size:.8em}.item_title{margin:auto 0;font-size:1em;font-weight:500;display:inline-flex}
.item_action{margin-right:0}.item_action div{margin:auto}
.hid{visibility:hidden;margin:0;max-height:0;overflow:hidden}
.nowrap{word-break:break-word;margin:0;font-size:1em}

.input{position:relative;width:100%;margin:18px 0;color:var(--black)}
.fakeinput,input,select,textarea{border:1px solid #b0b0b0;border-radius:5px;font-size:1.1em;line-height:1.2em;-webkit-appearance:none;padding:1.6em 1.3em .5em;background:var(--transwhite);color:currentColor}
.fakeinput,input,select,label,textarea{width:100%}textarea{min-height:500px;line-height:1,3em;font-size:1em;padding:1.2em 1em}
label{position:absolute;left:0;top:0;pointer-events:none;color:#717171;padding:1.3em 1.6em}
input:focus ~ label,input:not(:focus):valid ~ label,select:focus ~ label,select:not(:focus):valid ~ label,.fakeinput:focus ~ label,.fakeinput:not(:empty) ~ label{font-size:.7em;padding:.4em 2.1em;margin:.3em 0;left:2px}
.select{padding:.8em;margin:0}
input[type="file"]{display:none}
label[for="file"]{position:relative;pointer-events:all}
.fakeinput{height:60.06px;cursor:text;white-space:nowrap;overflow:hidden}.fakeinput:focus{outline:1px auto #141414}
.t20box .fakeinput,.t20box input,.t20box select{background:#ffffff40;border:1px solid currentColor}.t20box label,.t20box input::placeholder,.t20box .input{color:currentColor}
.t20box input:focus,.t20box select:focus{outline:1px solid currentColor}
option{color:var(--black)!important}
input[type=color]{padding:0;width:60px;height:37px;margin:9px 0}
.hab,#spell_hab{padding:1em .8em}
input,select,.fakeinput{min-width:70px}

button,label[for="file"]{padding:14px 26px;text-align:center;text-decoration:none;display:inline-block;font-size:100%;margin:10px 0;cursor:pointer;border-radius:5px; width:100%;background:transparent;border:2px solid var(--black);color:var(--black);font-weight:600}
button:hover,button:focus,label[for="file"]:hover,label[for="file"]:focus{background:var(--black);color:#e8e8e8}
.delete{border:2px solid var(--menu);color:var(--menu);filter:var(--bright)}.delete:hover{background:var(--menu);color:var(--white);filter:var(--bright)}
button:disabled,button:hover:disabled{border:2px solid #b0b0b0;color:#b0b0b0;background:var(--transwhite);cursor:no-drop}

a{color:currentColor;padding:12px 30px;text-decoration:none;display:block}
a:hover{background-color:#1e90ff;color:var(--white)}
.dropdown{position:absolute;background-color:var(--white);border:1px solid #000;z-index:1;width:100%;top:60px;max-height:250px;overflow-y:scroll}
.dn{display:none!important;border:0}.w0{width:0;visibility:hidden}

#char_spells{margin:25px auto}
.backdrop,.overlay{width:100%;left:0;top:0;inherit!important}
.backdrop{height:100%;position:fixed;top:0;background:hsl(0 0% 10%/.3)}
.overlay{height:100%;position:absolute;background:var(--overlay);margin-top:100px;overflow-x:hidden;overflow-y:scroll;padding:50px 25px 150px;bottom:0;box-shadow:0 0 20px rgb(0 0 0 / 10%)}
.invisible{opacity:0;visibility:hidden;pointer-events:none;top:100%}
#spell_overlay{height:200%}
.spell_lvl:empty{opacity:0;visibility:hidden}
.spell_lvl_head{margin:1em 0 0;font-weight:700;padding:.5em 1em;cursor:pointer;display:inline-flex;width:100%}.spell_lvl_head > p{font-weight:700;margin:0}
.arrow-down{width:8px;height:8px;border-bottom:2px solid;border-left:2px solid;transform:rotate(-45deg);margin:auto}.arrow-up{transform:rotate(135deg)}
.spell_details,.power_details{padding:.3em 1em;border-radius:10px}
.spell_add,.spell_delete{width:60%;margin:20px 20%}
.spell_add{border-color:var(--green);color:var(--green)}
.spell_add:hover,.spell_add:focus{background:var(--green);color:#fff}
#all_spells .spell_delete,#char_spells .spell_add,#all_powers .spell_delete,#char_powers .spell_add{display:none}

#habilidades .input{margin:8px 0}
.hab_label{transform:rotate(180deg);margin:auto;writing-mode:vertical-lr}
.dice{width:50%;margin:auto}
.t20box svg,.t20box g{fill:currentColor;color:currentColor;width:100%;height:100%}

.skills{margin-bottom:1em}
#char_skills svg,#char_crafts svg,#char_combat svg{width:72%;height:72%}
.skills.t20box{margin:0 auto 30px;width:70%;padding:0 20px}.skills.t20box .w10{margin:1% 0}
.m0a{margin:0 auto}.ma0{margin:auto 0}.z1{z-index:1}
.p_skill{font-size:1em;margin:auto 0;width:100%}.p_skill,.skill_input{padding:.8em;font-size:1em}
.skills.t20box:after{top:-15px;left:26%;margin-left:-4px;border-width:8px;border-style:solid;border-color:transparent transparent var(--menu) transparent;content:"";position:absolute}
.skill_info{max-height:500px}.skill_hide{max-height:0;opacity:0;visibility:hidden}
.skills .dice{margin-right:0}

#char_ac,#char_rd{background:rgba(0,0,0,.3);position:relative;margin:10px auto 25px}
#char_ac:before,#char_rd:before{top:-16px;left:25px;border-width:8px;border-style:solid;border-color:transparent transparent rgba(0,0,0,.3) transparent;content:"";position:absolute}
.def_info{max-height:500px;padding:30px 10px}.def_hide{margin:0 auto!important;max-height:0;opacity:0;visibility:hidden;padding:0 10px}
.def_info .w10{margin:1% 0}.pr{position:relative}
.def_input{text-align:center;padding:1.6em .8em .5em;font-size:1em}
#char_ac input{font-size:1em}
#char_ac label{margin:.3em 0;padding:0;width:100%;text-align:center;left:0}

.checkbox{position:relative;margin:auto;width:25px;height:25px;border:2px solid #dbdbdb;border-radius:4px}
.markedbox:after{width:8px;height:13px;border:1px solid var(--menu);border-width:0 2px 2px 0;transform-origin:bottom left;transform:rotate(45deg);position:absolute;top:-3px;left:3px;content:"";display:block}

.switch{position:relative;display:inline-block;width:60px;height:20px;pointer-events:all}
.switch input{opacity:0;width:0;height:0;margin:0;padding:0}
.slider{position:absolute;cursor:pointer;top:calc(50% - 14px);left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:24px;width:24px;left:4px;bottom:5.5px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}
input:checked+.slider{background-color:var(--menu);filter:var(--bright)}
input:focus+.slider{box-shadow:0 0 1px var(--menu);filter:var(--bright)}
input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}

.w10,.w9,.w8,.w7,.w6,.w5,.w4,.w3,.w2,.w1{display:block;float:left}.mw400{max-width:400px}
.w10{width:100%}.w9{width:90%}.w8{width:80%}.w7{width:70%}.w6{width:60%}.w5{width:50%}.w4{width:40%}.w3{width:30%}.w2{width:20%}.w1{width:10%}
.dif{display:inline-flex}.db{display:block}.ma{margin:auto}.mo,.m0{margin:0}.ms{margin-top:.4em!important}.ha{height:auto}.mt0{margin-top:0}.tal{text-align:left}.tc,.tac{text-align:center!important}.tac{padding-left:0!important;padding-right:0!important}.ml{margin-left:2em}
.invert,.hpinvert:after{filter:invert(1)}

.cont_bar{position:relative;z-index:2;margin:.5em 0}
.hpbar{display:flex}
.php{width:100%;text-align:center;margin-bottom:.5em}
.hpbar::after{content:"";width:85%;position:absolute;top:0;left:0;height:100%;z-index:-1;margin-left:7.5%}
.hp::after{background-color:#f76d6de3}.mp::after{background-color:#6dadf7e3}.sp::after{background-color:#6ff76de3}.ep::after{background-color:#f7e76de3}.xp::after{background-color:#c26df7e3}
.hp_input{position:relative;width:50%;height:unset!important;padding:1em 1.3em .5em;border:none!important;background:none!important;min-height:47.5px}.hp_input:nth-child(1){text-align:right}
.slash{border-bottom:1px solid white;transform:rotate(-75deg);width:6%;height:100%;margin-top:30px}

.condition{position:relative;padding:.3em 1em .3em 50px;height:unset;text-indent:0;margin:5px 0}
.condition:before{top:9px}.condition:after{transform:rotate(45deg);position:absolute;top:7px;left:13px}
.cond-hide{max-height:0;opacity:0}.cond-show{max-height:unset;opacity:1}

@media (min-width:991px){
.half{width:39.99999%;margin:0 5%}
.third{width:33.33333%}
.overlay{max-width:800px;left:50%;margin-left:-400px;height:calc(100% - 200px)}
.m0{margin:18px 0}
#sections{width:calc(var(--menulen)/2)} /* 450%*/
#dice_roller{width:60%;margin:0 20%}
#keyboard{background:#403f3fdb}
}
</style>
</head>

<body>
<div id="sections">
 <div id="sec_char" class="sec">
  <h1>Personagem</h1>
  <div class="row"><div class="container db">
   <div class="half">
    <div class="input mt0">
     <input id="char" class="drop" type="text" onkeyup="char_list(this);filter(this)" onclick="char_list(this)" autocomplete="off" autocomplete="chrome-off" required>
     <label>Personagem</label>
     <div class="dropdown dn"></div>
    </div>
   </div><div class="half">
    <div class="input mt0"><input id="jogador" type="text" onchange="data_add(this)" autocomplete="off" autocomplete="chrome-off" required><label>Jogador</label></div>
   </div>
  </div></div>

  <div id="habilidades" class="row"><div class="container t20box db"><div class="half"></div><div class="half"></div></div></div>

  <div class="row"><div class="container db">
   <div class="half">
    <div class="input"><select id="raça" onchange="data_add(this)" required></select><label>Raça</label></div>
    <div class="input"><select id="origem" onchange="data_add(this)" required></select><label>Origem</label></div>
    <div class="input"><select id="tamanho" onchange="data_add(this)" required></select><label>Tamanho</label></div>
    <div class="input m0"><div id="deslocamento" class="fakeinput drop" onclick="show_list(this)" inner="1"></div><label>Deslocamento</label><div class="dropdown dn"></div></div>
   </div>
   <div class="half">
    <div class="row dif">
     <div class="w10 input"><select id="classe" onchange="data_add(this)" required></select><label>Classe</label></div>
     <div class="w1"></div>
     <div class="w3 input"><select id="nível" class="tc" onchange="data_add(this);calc()" required></select><label class="tac">Nível</label></div>
    </div>
    <div class="input mt0"><input id="distincao" onchange="data_add(this)" required><label>Distinção de classe</label></div>
    <div class="input mt0"><div id="divindade" class="fakeinput drop" onclick="show_list(this)" inner="1"></div><label>Divindade</label><div class="dropdown dn"></div></div>
    <div class="input"><input id="xp" type="number" onchange="data_add(this)" required><label>Experiência</label></div>
   </div>
  </div></div>

  <div class="divider"></div>

  <div class="row"><div class="container db mw400">
   <label for="file"><input id="file" type="file" onchange="import_char(event)">Importar</input></label>
   <button onclick="export_char()">Exportar</button>
   <button id="chardel" class="delete" onclick="char_remove()" disabled>Deletar</button>
  </div></div>

 </div>

 <div id="sec_combat" class="sec">
  <h1>Combate</h1>
  <div class="row t20box">
   <div class="container dif z1" onclick="defense_info('char_ac')">
    <div class="w8"><p>Defesa</p></div>
    <div class="w3"><p id="ac" class="tac">10</p></div>
   </div>
   <div id="char_ac" class="container db def_info def_hide">
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab" class="select tc" onchange="def_set(this);calc()">
      <option disabled=""></option><option value="1">for</option><option value="2" selected>des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Habilidade</p>
    </div></div>
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab2" class="select tc" onchange="def_set(this);calc()">
      <option selected></option><option value="1">for</option><option value="2">des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Hab secundária</p>
    </div></div>
    <div class="w10 dif">
     <div class="w3 m0a dif"><input id="def_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"></div>
     <div class="w6 m0a dif"><p class="p_skill">Outro</p></div>
    </div>
    <div class="w10 dif">
     <div class="w3 m0a dif"><p id="def_cond" class="p_skill tac">+0</p></div>
     <div class="w6 m0a dif"><p class="p_skill">Condições</p></div>
    </div>
    <div class="w10 dif"><p class="p_skill tac">Armadura e Escudo</p></div>
    <div class="w10 dif">
     <div class="w5 m0a pr"><input id="armor" type="text" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label>Armadura</label></div>
     <div class="w2 m0a pr"><input id="armor_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label class="def_label">Bônus</label></div>
     <div class="w2 m0a pr"><input id="armor_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label class="def_label">Penalidade</label></div>
    </div>
    <div class="w10 dif">
     <div class="w5 m0a pr"><input id="shield" type="text" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label>Escudo</label></div>
     <div class="w2 m0a pr"><input id="shield_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label class="def_label">Bônus</label></div>
     <div class="w2 m0a pr"><input id="shield_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off" autocomplete="chrome-off"><label class="def_label">Penalidade</label></div>
    </div>
    <div id="armor_penal" sign="1" style="height:50px"></div><div id="shield_penal" sign="1"></div>
   </div>
   <div class="container dif z1">
    <div class="w8" onclick="defense_info('char_rd')"><p>Redução de Dano</p></div>
    <div class="w3"><input id="rd" class="skill_input tac" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this)" autocomplete="off" autocomplete="chrome-off"></div>
   </div>
   <div id="char_rd" class="container db def_info def_hide"></div>
  </div>

  <div class="row"><div class="container dif z1">
   
  <div id="char_atack"></div>
  </div></div>
 </div>

 <div id="sec_skills" class="sec">
  <h1 style="margin-bottom:45px">Perícias</h1>
  <div class="row"><div id="char_skills" class="container db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado&#9;‡penalidade de armadura</p></div></div>
  <h1 style="margin:2em 0 45px">Ofícios</h1>
  <div class="row"><div id="char_crafts" class="container db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado</p></div></div>
 </div>

 <div id="sec_feat" class="sec">
  <h1>Poderes</h1>
  <div class="row"><div id="char_powers" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_power')">Buscar poderes</button>
  </div></div>
 </div>

 <div id="sec_spell" class="sec">
  <h1>Magias</h1>
  <div class="row t20box">
   <div class="container">
    <div class="w8"><p>Atributo chave</p></div>
    <div class="w3"><select id="spell_hab" class="select tc" onchange="data_add(this);calc()"></select></div>
   </div><div class="container">
    <div class="w8"><p class="tal">Teste de resistência</p></div>
    <div class="w3 dif"><p id="spell_res" class="ma" inner="1">10</p></div>
   </div>
  </div>
  <div class="row"><div id="char_spells" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_spell')">Buscar magias</button>
  </div></div>
 </div>

 <div id="sec_condition" class="sec">
  <h1>Condições</h1>
  <div class="row t20box">
   <div id="hpbar" class="cont_bar">
    <div class="container hpbar hp">
     <div class="fakeinput hp_input" id="hp" onclick="open_key2(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="hpmax" onclick="open_key2(this)" inner="1">0</div>
    </div>
    <div class="container w10"><p class="item_subtitle php">Pontos de Vida</p></div>
   </div>
   <div id="mpbar" class="cont_bar">
    <div class="container hpbar mp">
     <div class="fakeinput hp_input" id="mp" onclick="open_key2(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="mpmax" onclick="open_key2(this)" inner="1">0</div>
    </div>
    <div class="container w10"><p class="item_subtitle php">Pontos de Mana</p></div>
   </div>
   <div id="spbar" class="cont_bar dn">
    <div class="container hpbar sp">
     <div class="fakeinput hp_input" id="sp" onclick="open_key2(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="spmax" onclick="open_key2(this)" inner="1">0</div>
    </div>
    <div class="container w10"><p class="item_subtitle php">Marcador Extra</p></div>
   </div>
   <div id="epbar" class="cont_bar dn">
    <div class="container hpbar ep">
     <div class="fakeinput hp_input" id="ep" onclick="open_key2(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="epmax" onclick="open_key2(this)" inner="1">0</div>
    </div>
    <div class="container w10"><p class="item_subtitle php">Marcador Extra</p></div>
   </div>
   <div id="xpbar" class="cont_bar dn">
    <div class="container hpbar xp">
     <div class="fakeinput hp_input" id="xp" onclick="open_key2(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="xpmax" onclick="open_key2(this)" inner="1">0</div>
    </div>
    <div class="container w10"><p class="item_subtitle php">Marcador Extra</p></div>
   </div>
  </div>
  <div class="row"><div id="conditions" class="container db">
  </div></div>
 </div>

 <div id="sec_notes" class="sec">
  <h1>Anotações</h1>
  <div class="row"><div class="container db">
   <textarea id="anot" onchange="data_add(this)"></textarea>
  </div></div>
 </div>

 <div id="sec_config" class="sec">
  <h1>Configurações</h1>

  <div class="row"><div class="container">
   <div class="w8"><p>Teclado avançado de dados</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_keyboard" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Exibir marcadores extras</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_marker" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo tela cheia</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_fullscreen" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo noturno</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_nocturnal" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Vibrar</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_vibrate" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>

  <div class="row"><div class="container">
   <div class="w8"><p>Esconder Combate (para conjuradores)</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_combat" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Esconder Magias (para guerreiros)</p></div>
   <div class="w2 ma ml"><label class="switch"><input id="c_magic" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>

  <div class="row"><div class="container">
   <div class="w8"><p>Cor customizada</p></div>
   <div class="w2 ma ml"><input id="c_color" type="color" value="#b72a2b" onchange="data_array(this);config()"></div>
  </div></div>
  <div class="divider"></div>

  <div class="row"><div class="container db">
   <p>Essa ferramenta é desenvolvida de forma independente para fins recreativos apenas.</p>
  </div></div>
  <div class="row"><div class="container t20box db">
   <p>Direitos referentes ao conteúdo Tormenta 20 reservados à seus criadores e à Editora Jambo.</p>
  </div></div>
  <div class="row"><div class="container">
   <p>Seus dados são armazenados <b>apenas</b> localmente, ou seja, nada é armazenado online. Use as opções de <b>importar</b> e <b>exportar</b> para transferir seu personagem entre dispositivos.</p>
  </div>
  <div class="container">
   <p>Caso deseje exluir todos os dados, por favor, utilize o botão a seguir. Eles <b>não</b> poderão ser recuperados.</p>
  </div><div class="container mw400">
   <button class="delete" onclick="reset()">Excluir todos os dados</button>
  </div></div>
 </div>

</div>

<div id="dice_roller">
 <div id="drawer" onclick="openroller(this)"><div></div></div>
  <div id="diceholder">
   <div id="allrolls"><div id="results"><p><i>(toque na barra acima para abrir e fechar)</i></p><p><b>Exemplos de rolagens:</b></p></div></div>
   <div id="dice-input" class="fakeinput" onclick="open_key()"></div>
  </div>
</div>

<nav>
 <div id="menu">
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon menuselicon"></div><div class="menutext menuseltext">Personagem</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Combate</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Perícias</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Poderes</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Magias</div></div></div>
  <!-- <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Equipamento</div></div></div> -->
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Condições</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Anotações</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Configurações</div></div></div>
 </div>
</nav>

<div id="keyboard" class="row"><div class="container keyboard"></div></div>
<div id="keyboard2" class="row"><div class="container keyboard"></div></div>

</div></div>

<div id="backdrop_power" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="power_name" type="text" onkeyup="filter_powers_name(this)" autocomplete="off" autocomplete="chrome-off" required><label>Nome</label></div>
   <div class="input"><div id="power_type" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Tipo</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="power_cat" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Raça, classe, categoria</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_powers" class="container db"></div></div>
 </div>
</div>

<div id="backdrop_spell" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="spell_name" type="text" onkeyup="filter_s if(key=='skills'||key=='crafts')pell_name(this)" autocomplete="off" autocomplete="chrome-off" required><label>Nome</label></div>
   <div class="input"><div id="spell_class" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Classificação</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_level" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Nível</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_school" class="fakeinput drop" onclick="show_list(this)" tabindex="3"></div><label>Escola</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_spells" class="container db"></div></div>
 </div>
</div>

</body>

<script>
const load = 1;var title = '';var chars = [];var loaded = 0;
const data_ini = {'c_color':'#b72a2b','c_keyboard':0,'c_marker':0,'c_fullscreen':0,'c_nocturnal':0,'c_vibrate':0,'magias':[],'powers':[],'conditions':{'def':0},'skills':skills,'crafts':crafts,'nível':0,'hab_for_val':10,'hab_for':0,'hab_des_val':10,'hab_des':0,'hab_con_val':10,'hab_con':0,'hab_int_val':10,'hab_int':0,'hab_sab_val':10,'hab_sab':0,'hab_car_val':10,'hab_car':0,'spell_hab':1,'defense':{'def_hab':2,'armor_bonus':0,'shield_bonus':0,'armor_penal':0,'shield_penal':0,'def_out':0}}
var data = data_ini;


//-------------------------DICE ROLLER FUNCTIONS------------------------//

const keyels = ['d','+','-','!','eh','el','kh','kl'];
var roll=[];

function getIndicesOf(str){
 var index, indices = [];
 str = str.toLowerCase();
 for(i=0;i<keyels.length;i++){
  var startIndex = 0;
  while ((index = str.indexOf(keyels[i],startIndex)) > -1){
   indices.push([index,keyels[i].length]);
   startIndex = index + keyels[i].length;
  }
 }
 return indices;
}

function roll_dice(num,max,exp){
 var roll = [];
 var rolled = '';
 for(k=0;k<num;k++){
  rolled = Math.floor(Math.random()*max)+1;
  roll.push(rolled);
  while(rolled>=exp){
   rolled = Math.floor(Math.random()*max)+1;
   roll.push(rolled);
  }
 }
 return roll;
}

function diceroll(str){
 str += ' ';
 var repeat = 1;
 if(str.includes("#")){
  repeat = str.slice(0,str.indexOf('#'));
  str = str.slice(str.indexOf('#')+1,-1) + ' ';
 }

 var indexes = [];
 indexes = getIndicesOf(str);
 indexes.sort(function sortFunction(a,b){if(a[0]===b[0]){return 0}else{return (a[0]<b[0])?-1:1}});
 if(indexes[0]){indexes.splice(0,0,[0,0])}
 indexes.push([-1,1]);

 var subkeys = [];
 var subarrays = [];
 for(i=0;i<indexes.length-1;i++){
  if(i){subkeys.push(str.slice(indexes[i][0],indexes[i][0]+indexes[i][1]))}
  subarrays.push(str.slice(indexes[i][0]+indexes[i][1],indexes[i+1][0]));
 }

 for(i=0;i<subarrays.length;i++){
  if(subarrays[i]==''){
   if(subkeys[i]=='d'){subarrays[i]='1'}
   if(subkeys[i-1]=='!'){subarrays[i]=subarrays[i-1]}
   if(subkeys[i-1]=='eh'||subkeys[i-1]=='el'||subkeys[i-1]=='kh'||subkeys[i-1]=='kl'){subarrays[i]='1'}
  }
 }
 if(!indexes[0]){subarrays.splice(0,0,'1')}

 for(var reroll=0;reroll<repeat;reroll++){
 var soma = 0;
 roll=[];
 var dices=[];
 var sum=[];
 var alg='+';
 var print=' ⟵';

 for(i=0;i<subkeys.length;i++){
  if(subkeys[i]=='d'){
   if(subkeys[i+1]=='!'){
    roll.push(roll_dice(subarrays[i],subarrays[i+1],subarrays[i+2]));
    dices = subarrays[i]+'d'+subarrays[i+1]+'!'+subarrays[i+2];
   }else{
    roll.push(roll_dice(subarrays[i],subarrays[i+1],subarrays[i+1]+1))
    dices = subarrays[i]+'d'+subarrays[i+1];
   }
   roll[roll.length-1] = roll[roll.length-1].sort(function(a,b){return b-a});

   if(subkeys[i+1]=='eh'||subkeys[i+1]=='el'||subkeys[i+1]=='kh'||subkeys[i+1]=='kl'){
    if(subkeys[i+1]=='eh'){
     var start = subarrays[i+2];
     var end = roll[roll.length-1].length;
    }
    if(subkeys[i+1]=='el'){
     var start = 0;
     var end = roll[roll.length-1].length-subarrays[i+2];
    }
    if(subkeys[i+1]=='kh'){
     var start = 0;
     var end = subarrays[i+2];
    }
    if(subkeys[i+1]=='kl'){
     var start = roll[roll.length-1].length-subarrays[i+2];
     var end = roll[roll.length-1].length;
    }
    dices += subkeys[i+1] + subarrays[i+2];

   }else if(subkeys[i+2]=='eh'||subkeys[i+2]=='el'||subkeys[i+2]=='kh'||subkeys[i+2]=='kl'){
    if(subkeys[i+2]=='eh'){
     var start = subarrays[i+3];
     var end = roll[roll.length-1].length;
    }
    if(subkeys[i+2]=='el'){
     var start = 0;
     var end = roll[roll.length-1].length-subarrays[i+3];
    }
    if(subkeys[i+2]=='kh'){
     var start = 0;
     var end = subarrays[i+3];
    }
    if(subkeys[i+2]=='kl'){
     var start = roll[roll.length-1].length-subarrays[i+3];
     var end = roll[roll.length-1].length;
    }
    dices += subkeys[i+2] + subarrays[i+3];

   } else {
    var start = 0;
    var end = roll[roll.length-1].length;
   }

   for(j=start;j<end;j++){
    if(alg=='+'){sum.push(roll[roll.length-1][j])}
    if(alg=='-'){sum.push(-roll[roll.length-1][j])}
   }
   for(j=0;j<roll[roll.length-1].length;j++){
    var classe = '';
    if(j){print += ', '}
    else{print += ' ['}
    if(j<start||j>end-1){classe+=' strike'}
    if(roll[roll.length-1][j]==subarrays[i+1]){classe+=' bold grun'}
    if(roll[roll.length-1][j]==1){classe+=' bold rot'}
    print += '<span class="'+classe+'">'+roll[roll.length-1][j]+'</span>';
   }
   print += '] ' + dices;
  } else if(subkeys[i]=='+'||subkeys[i]=='-'){
   if(subkeys[i+1]=='+'||subkeys[i+1]=='-'||i==subkeys.length-1){
    if(subkeys[i]=='+'){sum.push(JSON.parse(subarrays[i+1]))}
    if(subkeys[i]=='-'){sum.push(-JSON.parse(subarrays[i+1]))}
    print+=' '+subkeys[i]+' '+subarrays[i+1];
   } else {alg=subkeys[i];print+=' '+subkeys[i]+' '}
  }
 }

 for(j=0;j<sum.length;j++){soma+=sum[j]}
 print = '<span class="bold">'+soma+'</span>'+print;
 print_out(print);
 }
}

function scroll_down(e){setTimeout(function(){e=document.getElementById(e);e.scroll({top:e.scrollHeight,behavior:"smooth"})},700)}
function print_out(print){
 var card = document.createElement('p');
 card.innerHTML = print;
 document.getElementById("results").appendChild(card);
 scroll_down('allrolls');
}

function startroll(e){
 value = document.getElementById(e).innerHTML;
 if(e.includes('hab')){print_out('Teste de '+habis[habs.indexOf(e.replace('hab_',''))])}
 if(e.includes('total')){print_out('Teste de '+e.slice(0,-6))}
 if(e.includes('dice')){print_out(value);diceroll(value)}
 else{diceroll('d20'+value);openroller(document.getElementById('drawer'))}
 print_out('');
}

print_out('d20+2');diceroll('d20+2');print_out('');
print_out('2d20-2');diceroll('2d20-2');print_out('');
print_out('2#d12+1');diceroll('2#d12+1');print_out('');
print_out('2d10+2d8-2');diceroll('2d10+2d8-2');print_out('');
print_out('3d8! (explosão)');diceroll('3d8!');print_out('');
print_out('3d8!5 (explosão em 5+)');diceroll('3d8!5');print_out('');
print_out('4d6kh3 (keep higher 3)');diceroll('4d6kh3');print_out('');
print_out('4d6el (eliminate lower)');diceroll('4d6el');print_out('');
print_out('5d4!kl2 (keep lower 2)');diceroll('5d4!kl2');print_out('');
print_out('5d4!3eh2 (eliminate higher 2)');diceroll('5d4!3eh2');print_out('');

//-------------------------DICE KEYBOARD FUNCTIONS------------------------//

const keys = [[7,8,9,4,5,6,1,2,3,'AC',0,'dx'],
['d10','d20','d100','d6','d8','d12','d2','d3','d4','AC','d','123']];
const xkeys = ['kh','eh','kl','el','+','-','#','!','backspace','enter'];

var skeys;
function set_keyboard(){
 e = document.getElementById('keyboard').children[0];

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<keys[0].length;i++){
  if(keys[0][i]=='dx'){content += '<div class="key skey dkey" onclick="keyshift(this)">dx</div>'}
  else if(keys[0][i]=='AC'){content += '<div class="key skey" onclick="keyac()">AC</div>'}
  else{content += '<div class="key skey" onclick="keyprint(this)">'+keys[0][i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);
 skeys = document.getElementsByClassName('skey');

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<xkeys.length;i++){
  if(xkeys[i]=='backspace'){content += '<div class="key xkey" onclick="keydel()"><div class="backspace"></div></div>'}
  else if(xkeys[i]=='enter'){content += '<div class="key xkey" onclick="keysend()"><div class="enter"></div></div>'}
  else if(xkeys[i]=='+'||xkeys[i]=='-'){content += '<div class="key xkey" onclick="keyprint(this)">'+xkeys[i]+'</div>'}
  else{content += '<div class="key xkey hkey" onclick="keyprint(this)">'+xkeys[i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);
}

function keyshift(e){
 e.classList.toggle('nkey');
 for (var i=0;i<skeys.length;i++){skeys[i].innerHTML = keys[Number(e.classList.contains('nkey'))][i]}
}

var printed_keys = [];
function keyac(){document.getElementById('dice-input').innerHTML = '';printed_keys = []}
function keyprint(e){
 document.getElementById('dice-input').innerHTML += e.innerHTML;
 printed_keys.push(e.innerHTML);
}
function keydel(){
 if(printed_keys.length>0){
  var size = printed_keys[printed_keys.length-1].length;
  var text = document.getElementById('dice-input').innerHTML;
  text = text.slice(0,text.length-size);
  document.getElementById('dice-input').innerHTML = text;
  printed_keys.splice(printed_keys.length-1,1);
 }
}

function keysend(){startroll('dice-input');keyac()}

function open_key(){
 document.getElementById('keyboard').classList.toggle('boardshow');
 document.getElementById('diceholder').classList.toggle('diceholder');
 scroll_down('allrolls');
}

function openroller(e){
 e.parentNode.classList.toggle('drew');
 document.getElementById('keyboard').classList.remove('boardshow');
 document.getElementById('diceholder').classList.remove('diceholder');
}


//-------------------------HP KEYBOARD FUNCTIONS------------------------//

const key2 = document.getElementById('keyboard2');
const keys2 = [7,8,9,4,5,6,1,2,3,'AC',0,'max'];
const xkeys2 = ['+','-','backspace','enter'];

function set_keyboard2(){
 e = key2.children[0];

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<keys2.length;i++){
  if(keys2[i]=='AC'){content += '<div class="key lkey" onclick="keyac2()">AC</div>'}
  else if(keys2[i]=='max'){content += '<div class="key lkey" onclick="max_hp()">max</div>'}
  else{content += '<div class="key lkey" onclick="keyprint2(this)">'+keys2[i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<xkeys2.length;i++){
  if(xkeys2[i]=='backspace'){content += '<div class="key xkey" onclick="keydel2()"><div class="backspace"></div></div>'}
  else if(xkeys2[i]=='enter'){content += '<div class="key xkey" onclick="keysend2()"><div class="enter"></div></div>'}
  else{content += '<div class="key xkey" onclick="keyprint2(this)">'+xkeys2[i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);
}

var printed_keys2 = '', marker = '', m_value = '';
function keyprint2(e){
 printed_keys2 += e.innerHTML;
 marker.innerHTML = printed_keys2;
}

function keydel2(){
 printed_keys2 = printed_keys2.slice(0,-1);
 if(printed_keys2){marker.innerHTML = printed_keys2}
 else{marker.innerHTML = m_value}
}

function keyac2(){marker.innerHTML = m_value;printed_keys2 = ''}

function keysend2(){
 if(printed_keys2){
  var result2 = '';
  if(m_value==''){m_value=0}
  if(printed_keys2[0]=='+'){result2 = JSON.parse(m_value) + JSON.parse(printed_keys2.slice(1))}
  else if(printed_keys2[0]=='-'){result2 = JSON.parse(m_value) - JSON.parse(printed_keys2.slice(1))}
  else{result2 = JSON.parse(printed_keys2)}
  m_value = result2;
  data[marker.id] = m_value;
  keyac2()
 } else {open_key2(marker)}
}

function max_hp(){
 if(marker.id.indexOf('max')==-1){
  m_value = document.getElementById(marker.id + 'max').innerHTML;
  data[marker.id] = JSON.parse(m_value);
  keyac2()
 }
}

function open_key2(e){
 if(printed_keys2.length>0){keysend2();printed_keys2=''}
 if(marker==e||marker==''){key2.classList.toggle('boardshow')}
 if(key2.classList.contains('boardshow')){marker = e;m_value = e.innerHTML} else {marker=''}
}

//-------------------------DEFENSE FUNCTIONS------------------------//

function defense_info(e){document.getElementById(e).classList.toggle('def_hide')}
function def_set(e){e.value==''?data.defense[e.id]=0:(data.defense[e.id]=!isNaN(e.value)?JSON.parse(e.value):e.value)}
function def_calc(){document.getElementById('ac').innerHTML = 10+data.defense.armor_bonus+data.defense.shield_bonus+data.defense.def_out+data.conditions.def+data['hab_'+habs[data.defense.def_hab]] + (data.defense.def_hab2>0?data['hab_'+habs[data.defense.def_hab2]]:0)}

function list_rd(){
 for (var i=0;i<rd.length;i++){
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  div.innerHTML = '<div class="w3 m0a dif"><input id="rd_'+rd[i]+'" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this)" autocomplete="off" autocomplete="chrome-off"></div><div class="w6 m0a dif"><p class="p_skill">'+rd[i]+'</p></div></div>';
  document.getElementById('char_rd').appendChild(div);
 }
}




//-------------------------SKILLS FUNCTIONS------------------------//

function regex(e){e.value=/^[-]?\d*$/gm.test(e.value)?e.value:e.value.slice(0,-1)}
function regex2(e){e.value=/^[1-9][0-9]*$/.test(e.value)?e.value:e.value.slice(0,-1)}

function skill_info(e){e.parentNode.parentNode.parentNode.children[1].classList.toggle('skill_hide')}

function train2(i,k){
 var t = data.nível;
 t = t<7?2:t<14?4:6;
 document.getElementById(data[k][i][0]+'_train').innerHTML = '+'+data[k][i][4] * t;
}

function train(e,i,k){
 console.log(k);
 data[k][i][4] = +!data[k][i][4];
 if(data[k][i][4]){e.children[0].classList.add('markedbox')}
 if(!data[k][i][4]){e.children[0].classList.remove('markedbox')}
 e = e.parentNode.parentNode.parentNode.id;
 calc_skills(k);
}

function skill_outro(e,k){
 if(e.value.indexOf('+')>-1){e.value=e.value.slice(1)}
 data[k][e.getAttribute('skill')][5]=JSON.parse(e.value);
 e.value = add_plus_sign(e.value);
}

var skill_habs = '<option disabled selected></option>';
for(var i=1;i<habs.length;i++){skill_habs += '<option value="'+i+'">'+habs[i]+'</option>'}

function skill_hab(e,k){data[k][e.getAttribute('skill')][e.getAttribute('index')]=JSON.parse(e.value)}

function list_skills(e,i,k){ //k='skills' or 'crafts'
for (var i=0;i<e.length;i++){
 var div = document.createElement('div');
 div.setAttribute('id',e[i][0]);
 div.setAttribute('index',i);
 div.setAttribute('class','row');

 var content2 = '<div class="row"><div class="skills t20box">';
 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><select id="'+e[i][0]+'_hab" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="1">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Habilidade</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><select id="'+e[i][0]+'_hab2" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="2">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Hab secundária</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><p class="p_skill tac skill_lvl">+0</p></div><div class="w5 m0a dif"><p class="p_skill">1/2 do nível</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><p id="'+e[i][0]+'_train" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="4">Treinamento</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><input id="'+e[i][0]+'_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="skill_outro(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="5" autocomplete="off" autocomplete="chrome-off"></input></div><div class="w5 m0a dif"><p class="p_skill">Outro</p></div></div>';

 content2 += '<div class="w10 dif">';
 if(e[i][6]){content2 += '<div class="w3 m0a dif"><p id="'+e[i][0]+'_penal" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="6">Penalidade</p></div>'}
 content2 += '</div>';

 content2 += '<div class="w10 dif"><div class="w3 m0a dif"><p id="'+e[i][0]+'_cond" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill">Condições</p></div></div>';
 content2 += '</div></div>';

 var content = '<div class="row"><div class="container skills">';
 content += '<div class="w2 dif" onclick="train(this,'+i+',\''+k+'\')"><div class="checkbox"></div></div>';
 content += '<div class="w4 dif" onclick="skill_info(this)"><p class="item_title">'+e[i][0];
 content += e[i][3]?'*':'';
 content += e[i][6]?'‡':'';
 content += '</p></div>';
 content += '<div class="w2 dif" onclick="startroll(\''+e[i][0]+'_total\')"><div class="dice dif" data-dice="d20"></div></div>';
 content += '<div class="w2 dif" onclick="startroll(\''+e[i][0]+'_total\')"><p id="'+e[i][0]+'_total" class="item_title skill_tot">+0</p></div>';
 content += '</div></div><div class="skill_info skill_hide">'+content2+'</div>';
 div.innerHTML = content;
 document.getElementById('char_'+k).appendChild(div);

 div.children[1].children[0].children[0].children[0].children[0].children[0].value = data[k][i][1];
}}

const skill_lvl = document.getElementsByClassName('skill_lvl');
function calc_skills(k){
 for(var i=0;i<skill_lvl.length;i++){skill_lvl[i].innerHTML = '+'+Math.floor(JSON.parse(data.nível)/2)}
 for(var i=0;i<data[k].length;i++){
  var e = document.getElementById(data[k][i][0]).children[0].children[0];
  if(data[k][i][3]&&!data[k][i][4]){e.children[2].classList.add('dn');e.children[3].classList.add('dn')}
  else{e.children[2].classList.remove('dn');e.children[3].classList.remove('dn')}
  var total = data['hab_'+habs[data[k][i][1]]] + (data[k][i][2]>0?data['hab_'+habs[data[k][i][2]]]:0) + Math.floor(data.nível/2) + JSON.parse(data[k][i][4])*(data.nível<7?2:data.nível<14?4:6) + JSON.parse(data[k][i][5]) + JSON.parse(data[k][i][6])*(data.defense.armor_penal + data.defense.shield_penal);
  document.getElementById(data[k][i][0]+'_total').innerHTML = add_plus_sign(total);
  if(data[k][i][6]){document.getElementById(data[k][i][0]+"_penal").innerHTML = add_plus_sign(data.defense.armor_penal + data.defense.shield_penal)}
  e = e.children[0].children[0];
  if(data[k][i][4]&&!e.classList.contains('markedbox')){e.classList.add('markedbox')}
  train2(i,k);
  document.getElementById(data[k][i][0]+"_hab").value = data[k][i][1];
  document.getElementById(data[k][i][0]+"_hab2").value = data[k][i][2];
  document.getElementById(data[k][i][0]+"_out").value = add_plus_sign(data[k][i][5]);
 }
}


//-------------------------CONDITIONS FUNCTIONS------------------------//

function list_conditions(e,i){
 var div = document.createElement('div');
 div.setAttribute('id','condition_'+i);
 div.setAttribute('index',i);
 div.setAttribute('class','condition checkmark w10');
 div.setAttribute('onclick','toggle_condition(this)');
 var q = conditions[i][1]?' · '+conditions[i][1]:'';
 var content = '<div class="w10"><p class="item_title">'+conditions[i][0]+q+'</p><p class="item_subtitle"></p></div>';
 div.innerHTML = content;
 document.getElementById(e).appendChild(div);
}

function toggle_condition(e){
 var i = e.getAttribute('index');
 data.conditions[i] =! data.conditions[i];
 cond_info(e,i);
}

function cond_info(e,i){
 e.classList.toggle('checkmarked');
 e = e.children[0].children[1];
 e.innerHTML = data.conditions[i]?conditions[i][2]:'';
}

//-------------------------CALCULATION FUNCTIONS------------------------//

function add_plus_sign(v){v=v<0?v:'+'+v;return v}
function calc_hab(e){
 var value = Math.floor((e.value-10)/2);
 value = add_plus_sign(value);
 e = e.parentNode.parentNode.parentNode.children[3].children[0];
 e.innerHTML = value;
 data_inner(e);
 calc();
}
function calc_spell_res(){
 document.getElementById('spell_res').innerHTML = 10 + Math.floor(JSON.parse(data.nível)/2) + JSON.parse(data['hab_'+habs[data.spell_hab]]);
 data_inner(document.getElementById('spell_res'));
}
function calc(){def_calc();calc_skills('skills');calc_skills('crafts');calc_spell_res()}


//-------------------------POWERS FUNCTIONS------------------------//

data['powers'] = [];
var powers_viz = [];

function list_powers(e,i){
 var div = document.createElement('div');
 div.setAttribute('id','power_'+i);
 div.setAttribute('class','power w10 h70');
 div.setAttribute('onclick','power_info(this)');
 div.setAttribute('index',i);
 var p = powers[i][2]?' · '+powers[i][2]:'';
 var q = powers[i][4]?' · '+powers[i][4]:'';
 var m = powers[i][5]==1?'<div class="magic">'+magic+'</div>':'';
 var content = '<div class="spell_details"><div class="w10 dif"><div class="w9"><p class="item_title">'+powers[i][0]+'</p>'+m+'<p class="item_subtitle">'+powers[i][1]+p+q+'</p></div><div class="item_action w1 ma">';
 if(spell_action.includes(powers[i][3])){content += '<div class="ac_'+powers[i][3]+'"></div>'}
 content += '</div></div><div class="item_subtitle w10 ms"></div></div>';
 div.innerHTML = content;
 document.getElementById(e).appendChild(div);
 powers_viz.push([1,1,1,0]);
}

function power_info(e){
 var i = e.getAttribute('index');
 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(powers_viz[i][3]){
  powers_viz[i][3] = 0;
  e.innerHTML = '';
 } else {
  powers_viz[i][3] = 1;
  var content = '<p class="nowrap">'+powers[i][7]+'</p>';
  content += '<p class="nowrap"><i>Publicação:</i> '+powers[i][6]+'</p>';
  content += '</div></div><button class="spell_add" onclick="add_power(this)">Adicionar poder</div><button class="delete spell_delete" onclick="remove_power(this)">Remover poder</div>';
  e.innerHTML = content;
 }
}

function add_power(e){
 e = e.parentNode;
 e.innerHTML = '';
 e = e.parentNode.parentNode.cloneNode(true);
 e.id = '';
 e.classList.remove('more_info');
 document.getElementById('char_powers').appendChild(e);
 data['powers'][Object.keys(data['powers']).length] = JSON.parse(e.getAttribute('index'));
}

function remove_power(e){
 e = e.parentNode.parentNode.parentNode;
 data['powers'].splice(data['powers'].indexOf(e.getAttribute('index')),1);
 e.remove();
}

function filter_powers(){
 for (var i=0;i<powers.length;i++){
  var e = document.getElementById('power_'+i);
  if(powers_viz[i][0]&&powers_viz[i][1]&&powers_viz[i][2]){e.style.display=""}
  else{e.style.display="none"}
 }
}

function filter_powers_other(e){
 var k = e.getAttribute('tabindex');
 var filter = e.innerHTML;
 if(!filter){filter=JSON.stringify(power_inputs[k-1])}
 for (var i=0;i<powers.length;i++){
  if(filter.indexOf(powers[i][k])>-1){powers_viz[i][k]=1}
  else{powers_viz[i][k]=0}
 }
 filter_powers();
}

function filter_powers_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<powers.length;i++){
  var powername = powers[i][0].toUpperCase();
  if(powername.indexOf(filter)>-1){powers_viz[i][0]=1}
  else{powers_viz[i][0]=0}
 }
 filter_powers();
}

function clear_powers_filters(){
 for (var i=0;i<powers.length;i++){if(powers_viz[i][3]){
   var e = document.getElementById('powers_'+i);
   e.classList.remove('more_info');
   e.children[0].children[1].innerHTML = '';
   powers_viz[i][3] = 0;
 }}
 for (var i=0;i<powers.length;i++){powers_viz[i]=[1,1,1,0]}
 cpower_type=[],cpower_cat=[];

 e = document.getElementById('power_type');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('power_cat');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 var e = document.getElementById('power_name');e.value='';
 filter_powers_name(e);
}


//-------------------------SPELLS FUNCTIONS------------------------//

data['magias'] = [];
var spell_viz = [];
function list_spells(e,i){
 var div = document.createElement('div');
 div.setAttribute('id','spell_'+i);
 div.setAttribute('class','spell w10 h70');
 div.setAttribute('onclick','spell_info(this)');
 div.setAttribute('index',i);
 var content = '<div class="spell_details"><div class="w10 dif"><div class="w9"><p class="item_title">'+spells[i][0]+'</p><p class="item_subtitle">'+spell_pm_cost[spells[i][2]-1]+' PM · '+spells[i][1]+' · '+spells[i][3]+' '+spells[i][2]+'</p></div><div class="item_action w1 ma">';
 if(spell_action.includes(spells[i][4])){content += '<div class="ac_'+spells[i][4]+'"></div>'}
 content += '</div></div><div class="item_subtitle w10 ms"></div></div>';
 div.innerHTML = content;
 document.getElementById(e).appendChild(div);
 spell_viz.push([1,1,1,1,0]);
}

function spell_info(e){
 var i = e.getAttribute('index');
 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(spell_viz[i][4]){
  spell_viz[i][4] = 0;
  e.innerHTML = '';
 } else {
  spell_viz[i][4] = 1;
  var content = '';

  if(spells[i][4]){content += '<p class="nowrap"><b>Ação:</b> '+spells[i][4]+'</p>'} //!spell_action.includes(spells[i][4])
  if(spells[i][5]){content += '<p class="nowrap"><b>Alcance:</b> '+spells[i][5]+'</p>'}
  if(spells[i][7]){content += '<p class="nowrap"><b>Alvo:</b> '+spells[i][7]+'</p>'}
  if(spells[i][8]){content += '<p class="nowrap"><b>Área:</b> '+spells[i][8]+'</p>'}
  if(spells[i][10]){content += '<p class="nowrap"><b>Efeito:</b> '+spells[i][10]+'</p>'}
  if(spells[i][6]){content += '<p class="nowrap"><b>Duração:</b> '+spells[i][6]+'</p>'}
  if(spells[i][9]){content += '<p class="nowrap"><b>Resistência:</b> '+spells[i][9]+'</p>'}

  content += '<p class="nowrap ms">'+spells[i][11]+'</p>';
  var length = spells[i].length;
  for (var j=13;j<length;j+=2){
   content += '<p class="nowrap ms"><b>';
   content += Number.isInteger(spells[i][j])?('+'+spells[i][j]+' PM'):spells[i][j];
   content += ': </b><span>'+spells[i][j+1]+'</span></p>';
  }
  if(spells[i][12]){content += '<p class="nowrap"><i>Publicação:</i> '+spells[i][12]+'</p>'}
  content += '</div></div><button class="spell_add" onclick="add_spell(this)">Adicionar magia</div><button class="delete spell_delete" onclick="remove_spell(this)">Remover magia</div>';
  e.innerHTML = content;
 }
}

function filter_spells(){
 for (var i=0;i<spells.length;i++){
  var e = document.getElementById('spell_'+i);
  if(spell_viz[i][0]&&spell_viz[i][1]&&spell_viz[i][2]&&spell_viz[i][3]){e.style.display=""}
  else{e.style.display="none"}
 }
}

function filter_spell_other(e){
 var k = e.getAttribute('tabindex');
 var filter = e.innerHTML;
 if(!filter){filter=JSON.stringify(spell_inputs[k-1])}
 for (var i=0;i<spells.length;i++){
  if(filter.indexOf(spells[i][k])>-1){spell_viz[i][k]=1}
  else{spell_viz[i][k]=0}
 }
 filter_spells();
}

function filter_spell_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<spells.length;i++){
  var spellname = spells[i][0].toUpperCase();
  if(spellname.indexOf(filter)>-1){spell_viz[i][0]=1}
  else{spell_viz[i][0]=0}
 }
 filter_spells();
}

function clear_spell_filters(){
 for (var i=0;i<spells.length;i++){if(spell_viz[i][4]){
  var e = document.getElementById('spell_'+i);
  e.classList.remove('more_info');
  e.children[0].children[1].innerHTML = '';
  spell_viz[i][4] = 0;
 }}
 for (var i=0;i<spells.length;i++){spell_viz[i]=[1,1,1,1,0]}
 cspell_level=[],cspell_class=[],cspell_school=[];

 e = document.getElementById('spell_level');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_class');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_school');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 var e = document.getElementById('spell_name');e.value='';
 filter_spell_name(e);
}

function add_spell(e){
 e = e.parentNode;
 e.innerHTML = '';
 e = e.parentNode.parentNode.cloneNode(true);
 e.id = '';
 e.classList.remove('more_info');
 document.getElementById('char_spells').appendChild(e);
 data['magias'][Object.keys(data['magias']).length] = JSON.parse(e.getAttribute('index'));
}

function remove_spell(e){
 e = e.parentNode.parentNode.parentNode;
 data['magias'].splice(data['magias'].indexOf(e.getAttribute('index')),1);
 e.remove();
}



//-------------------------CONFIG FUNCTIONS------------------------//

function invert(color){return (Number(`0x1${color}`)^0xFFFFFF).toString(16).substr(1).toUpperCase()}
function menucolor(color){
 document.querySelector('meta[name="theme-color"]').setAttribute('content',color);
 document.querySelector(':root').style.setProperty('--t20white',data.c_nocturnal?'#000':'#fff');
 document.querySelector(':root').style.setProperty('--t20weight',data.c_nocturnal?'600':'400');
 document.querySelector(':root').style.setProperty('--bright',data.c_nocturnal?'brightness(.9)':'brightness(1.1)');
 color = data.c_nocturnal?invert(color.replace('#','')):color.replace('#','');
 document.querySelector(':root').style.setProperty('--menu','#'+color);
 color = 'url(\''+backborder.replace('backborder',color)+'\') 4% repeat';
 document.querySelector(':root').style.setProperty('--backborder',color);
}

function fullscreen(e){
 if(data.c_fullscreen&&document.fullscreenElement==null){
  if(e.requestFullscreen){e.requestFullscreen()}
  else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}
  else if(e.msRequestFullscreen){e.msRequestFullscreen()}
 }
 if(!data.c_fullscreen&&document.fullscreenElement){
  if(document.exitFullscreen){document.exitFullscreen()}
  else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}
  else if(document.msExitFullscreen){document.msExitFullscreen()}
 }
}

function config(){
 const e = document.documentElement;
 const key = document.getElementById('keyboard');
 const key2 = document.getElementById('keyboard2');
 const colorpicker = document.getElementById('c_color');
 data.c_keyboard?key.classList.add('keyext'):key.classList.remove('keyext');
 if(data.c_nocturnal){
  e.classList.add('invert');colorpicker.classList.add('invert');key.classList.add('invert');key2.classList.add('invert');
  var l = document.getElementsByClassName('hpbar');for (let i of l){i.classList.add('hpinvert')}
  var l = document.getElementsByClassName('slash');for (let i of l){i.classList.add('invert')}
 }else{
  e.classList.remove('invert');colorpicker.classList.remove('invert');key.classList.remove('invert');key2.classList.remove('invert');
  var l = document.getElementsByClassName('hpbar');for (let i of l){i.classList.remove('hpinvert')}
  var l = document.getElementsByClassName('slash');for (let i of l){i.classList.remove('invert')}
 }
 if(data.c_marker){
  document.getElementById('spbar').classList.add('dn');
  document.getElementById('epbar').classList.add('dn');
  document.getElementById('xpbar').classList.add('dn')
 }else{
  document.getElementById('spbar').classList.remove('dn');
  document.getElementById('epbar').classList.remove('dn');
  document.getElementById('xpbar').classList.remove('dn')
 }

 if(data.c_combat){
  allmenubtn[1].classList.add('dn');
  sections[1].classList.add('dn');
  if(menubtn[1]==1){menubtn.splice(1,1)}
 }else{
  allmenubtn[1].classList.remove('dn');
  sections[1].classList.remove('dn');
  if(menubtn[1]!=1){menubtn.splice(1,0,1)}
 }

 if(data.c_magic){
  allmenubtn[4].classList.add('dn');
  sections[4].classList.add('dn');
  if(menubtn.indexOf(4)>0){menubtn.splice(menubtn.indexOf(4),1)}
 }else{
  allmenubtn[4].classList.remove('dn');
  sections[4].classList.remove('dn');
  if(menubtn.indexOf(4)<0){menubtn.splice(menubtn.indexOf(5),0,4)}
 }

 menucolor(data.c_color);
 fullscreen(e);
 if(loaded){navig(allmenubtn[0])}else{navig(allmenubtn[allmenubtn.length-1])}
}

//-------------------------NAVIGATION FUNCTIONS------------------------//

const sections = document.getElementsByClassName('sec');
const allmenubtn = document.getElementsByClassName('menubtn');
var menubtn = [];
for(var i=0;i<allmenubtn.length;i++){menubtn.push(i)};
document.documentElement.style.setProperty("--menulen",allmenubtn.length*100+"%");

function navig(e){
 for(var i=0;i<allmenubtn.length;i++){
  allmenubtn[i].children[0].children[0].classList.remove('menuselicon');
  allmenubtn[i].children[0].children[1].classList.remove('menuseltext');
 }
 e.children[0].children[0].classList.add('menuselicon');
 e.children[0].children[1].classList.add('menuseltext');

 var x = Array.prototype.indexOf.call(allmenubtn,e);
 x = menubtn.indexOf(x);
 x = window.innerWidth>990&&x==menubtn.length-1?x-1:x;

 document.documentElement.style.setProperty("--menulen",menubtn.length*100+"%");
 document.getElementById('sections').style.transform='translate(-'+x*100/menubtn.length+'%,0)';
 window.scrollTo({top:0,behavior:'smooth'});
}

let touchstartX = 0;
let touchendX = 0;
function deltaX(){var deltaX = touchstartX-touchendX;if(deltaX>200&&x<8){navig(menubtn[x+1])}if(deltaX<-200&&x>0){navig(menubtn[x-1])}}
document.getElementById('sections').addEventListener('touchstart',e=>{touchstartX=e.changedTouches[0].screenX},{passive:true})
document.getElementById('sections').addEventListener('touchend',e=>{touchendX=e.changedTouches[0].screenX;deltaX()},{passive:true})

function hide(e,el){if(el==e.target){el.classList.toggle('invisible');if(el.id=="backdrop_spell"){clear_spell_filters()};if(el.id=="backdrop_power"){clear_powers_filters()}}}
function show(el){document.getElementById(el).classList.toggle('invisible')}

function filter(el){
 var filter = el.value.toUpperCase();
 var a = el.parentNode.children[2].getElementsByTagName("a");
 for (var i=1;i<a.length;i++){
  txtValue = a[i].textContent || a[i].innerText;
  if(txtValue.toUpperCase().indexOf(filter)>-1){a[i].style.display=""}
  else{a[i].style.display="none"}
 }
}

function show_list(e){
 e.focus();
 e = e.parentNode.children[2].classList.remove('dn');
}

var cspell_level=[],cspell_class=[],cspell_school=[],cdivindade=[],cdeslocamento=[],cpower_type=[],cpower_cat=[];
function set_check(e,array){
 e.classList.toggle('checkmarked');
 e.setAttribute('value',e.getAttribute('value')==1?0:1)

 if(e.getAttribute('value')==1){array.push(e.innerHTML)}else{array.splice(array.indexOf(e.innerHTML),1)}
 array.sort();
 e = e.parentNode.parentNode.children[0];
 e.innerHTML = array.join(', ');

 var c = e.parentNode.parentNode.parentNode.parentNode.parentNode.id;
 if(e.getAttribute('inner')){data_inner(e)}
 else if(c=="backdrop_power"){filter_powers_other(e)}
 else if(c=="backdrop_spell"){filter_spell_other(e)}
}

window.addEventListener('click',function(e){
 var el = document.getElementsByClassName('dropdown');
 for (i=0;i<el.length;i++){
  if(!el[i].parentNode.contains(e.target)){el[i].parentNode.children[2].classList.add("dn")}
 }
 window.focus();
});
document.addEventListener('touchstart',e=>{if(data.c_vibrate){navigator.vibrate(75)}})


//-------------------------CHARACTERS FUNCTIONS------------------------//

function char_create(e){
 if(e.title){
  e.parentNode.classList.add('dn');
  clear();
  title = e.title;
  chars.push(title);
  data.char=title;
  document.getElementById('char').value=title;
  document.getElementById('chardel').disabled = false;
  document.title = title + ' - T20';
  console.log('Character '+title+' was created');
 }
}

function char_set(el){
 if(title){save_data()}
 el.parentNode.classList.add('dn');
 clear();
 title = el.innerHTML;
 data_load();
 document.title = title + ' - T20';
 document.getElementById('chardel').disabled = false;
 data_set();
 console.log('Character '+title+' was loaded');
}

function char_remove(){
 if(title){
  console.log('Character '+title+' was removed');
  chars.splice(chars.indexOf(title),1);
  localStorage.removeItem(title+'_data');
  clear();
  document.title = 'Ficha T20 Mobile - v0.9';
  document.getElementById('chardel').disabled = true;
 }
}

function char_list(el){
 var value = el.value;
 el = el.parentNode.children[2];
 if(value||chars.length){el.classList.remove('dn')}
 if(!value&&!chars.length){el.classList.add('dn')}
 el.innerHTML = '';
 if(value){el.innerHTML = '<a onclick="char_create(this)" title="'+value+'">Clique para criar '+value+'</a>'}
 for(var i=0;i<chars.length;i++){el.innerHTML += '<a onclick="char_set(this)">'+chars[i]+'</a>'}
}



//-------------------------STARTER FUNCTIONS------------------------//

function create_select(array){
 for (j=0;j<array.length;j++){
  var div = document.createElement('option');
  if(j){div.setAttribute('value',j);div.innerHTML = array[j]}
  else{div.setAttribute('disabled','');div.setAttribute('selected','')}
  document.getElementById(array[0]).appendChild(div);
 }
}

function create_checkbox(array){
 for(var j=1;j<array.length;j++){document.getElementById(array[0]).parentNode.children[2].innerHTML += '<a class="checkmark" onclick="set_check(this,c'+array[0]+')" value="0">'+array[j]+'</a>'}
}

function create_habs(){
 var e = document.getElementById('habilidades').children[0].children[0];
 for (var i=1;i<habs.length;i++){
  if(i>=habs.length/2){e = e.parentNode.children[1]}
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  var content = '<div class="w2 dif"><div class="hab_label">'+habs[i].toUpperCase()+'</div></div>';
  content += '<div class="w4"><div class="input"><input id="hab_'+habs[i]+'_val" class="tc hab" inputmode="numeric" onkeyup="regex2(this)" onchange="data_add(this);calc_hab(this)" required></div></div>';
  content += '<div class="w2 dif" onclick="startroll(\'hab_'+habs[i]+'\')"><div class="dice" data-dice="d20"></div></div>';
  content += '<div class="w2 dif"><p id="hab_'+habs[i]+'" class="ma0" sign="1">+0</p></div>';
  div.innerHTML = content;
  e.appendChild(div);
 }
}

function start_up(){
 menucolor('#b72a2b');
 create_habs();
 const menuicon = document.getElementsByClassName('menuicon');
 for (var i=0;i<menuicon.length;i++){menuicon[i].innerHTML = icons[i]}
 for (var i=0;i<inputs.length;i++){create_select(inputs[i])}
 create_checkbox(divindade);
 create_checkbox(deslocamento);
 for (var i=0;i<spell_inputs.length;i++){create_checkbox(spell_inputs[i])}
 for (var i=0;i<power_inputs.length;i++){create_checkbox(power_inputs[i])}
 for (var i=0;i<spells.length;i++){list_spells('all_spells',i)}
 for (var i=0;i<powers.length;i++){list_powers('all_powers',i)}
 for (var i=0;i<conditions.length;i++){list_conditions('conditions',i)}
 list_skills(skills,i,'skills');
 list_skills(crafts,i,'crafts');
 list_rd();
 set_keyboard();set_keyboard2();
 dice = document.getElementsByClassName('dice');
 for (var i=0;i<dice.length;i++){dice[i].innerHTML = dices[dice[i].getAttribute("data-dice")]}
}


//-------------------------DATA MANAGEMENT FUNCTIONS------------------------//

function data_add(e){data[e.id]=e.value}
function data_array(e){data[e.id]=e.value}
function data_check(e){data[e.id]=e.checked;loaded=0}
function data_inner(e){var value = e.innerHTML.replace('+','');data[e.id]=JSON.parse(value)}


function data_set(){
 for (const key in data){
  if(key=='magias'){
   for (var i=0;i<data.magias.length;i++){list_spells('char_spells',data.magias[i])}
  }else if(key=='powers'){
   for (var i=0;i<data.powers.length;i++){list_powers('char_powers',data.powers[i])}
  }else if(key=='conditions'){
   for (var i=0;i<data.conditions.length;i++){if(data.conditions[i]){cond_info(document.getElementById('condition_'+i),i)}}
  }else if(key=='defense'){
   for (let i in data.defense){document.getElementById(i).value=data.defense[i]}


  }else if(key=='skills'||key=='crafts'){ //do nothing
  }else{
   var e=document.getElementById(key);
   if(e.getAttribute('sign')){e.innerHTML=add_plus_sign(data[key])}
   else if(e.getAttribute('inner')){e.innerHTML=data[key]}
   else if(e.type=='checkbox'){e.checked=data[key]}
   else{e.value=data[key]}
  }
 }
 title=data['char'];
 document.title = title + ' - T20';
 document.getElementById('chardel').disabled = false;
 document.getElementById('sections').style.transform='';
 config();
 calc()
}

window.onload = function(){
 start_up();
 if(localStorage.getItem('chars')){chars = JSON.parse(localStorage.getItem('chars'))}
}

window.addEventListener('beforeunload',save_data);
function save_data(){
 localStorage.setItem('chars',JSON.stringify(chars));
 if(title){localStorage.setItem(title+'_data',JSON.stringify(data))}
}
function data_load(){
 if(localStorage.getItem(title+'_data')){
  data = JSON.parse(localStorage.getItem(title+'_data'));
  if(!data.magias){data.magias=[]}
  if(!data.powers){data.powers=[]}
  if(!data.skills){data.skills=skills}
  if(!data.crafts){data.crafts=crafts}
  if(!data.defense){data.defense=data_ini.defense}
  loaded=1;
 }
}

function clear(){
 var input = document.getElementsByTagName("input");
 for (var i=0;i<input.length;i++){input[i].value=''}
 var select = document.getElementsByTagName("select");
 for (var i=0;i<select.length;i++){option = select[i].options;option[0].selected = true}
 var fakeinput = document.getElementsByClassName('fakeinput');
 for (var i=0;i<fakeinput.length;i++){fakeinput[i].innerHTML=''}
 document.getElementById('char_spells').innerHTML = '';
 title='';
 data = data_ini;
}

function import_char(evt){
 data = data_ini;
 if(!window.FileReader) return; // Browser is not compatible
 var reader = new FileReader();
  reader.onload = function(evt) {
   if(evt.target.readyState!=2) return;
   if(evt.target.error){alert('Error while reading file');return}
   data = JSON.parse(evt.target.result);
   if(!data.magias){data.magias=[]}
   if(!data.powers){data.powers=[]}
   if(!data.skills){data.skills=skills}
   if(!data.crafts){data.crafts=crafts}
   if(!data.defense){data.defense=data_ini.defense}
   chars.push(data['char']);
   data_set();
   console.log('Character '+data['char']+' data imported');
  };
 reader.readAsText(evt.target.files[0]);
 loaded=1;
}

function export_char(){
 var filename = title?'char_'+title:'unnamed_char' +'.txt';
 var filedata = JSON.stringify(data);
 var file = new Blob([filedata], {type:'text/plain'});
 if (window.navigator.msSaveOrOpenBlob) // IE10+
     window.navigator.msSaveOrOpenBlob(file, filename);
 else{
  var a = document.createElement("a"),url = URL.createObjectURL(file);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(function() {
   document.body.removeChild(a);
   window.URL.revokeObjectURL(url);
  }, 0);
 }
 console.log('Character '+title+' data exported');
}

function reset(){localStorage.clear();chars=[];data={};title='';location.reload()}
 alert('Comece criando ou carregando um personagem digitando um nome de personagem, quaisquer edições feitas antes disso serão perdidas.');
</script>
</html>
