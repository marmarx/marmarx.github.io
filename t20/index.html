<!DOCTYPE html>
<html lang="pt-BR">
<head>
<title>Ficha T20 Mobile - v1.5</title>
<meta name="author" content="Marco Martins">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<meta name="theme-color" content="#b72a2b">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="icon" type="image/png" href="src/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="src/css.css">
<script type="text/javascript" src="db/icons.js"></script>
<script type="text/javascript" src="db/geral.js"></script>
<script type="text/javascript" src="db/spells.js"></script>
<script type="text/javascript" src="db/feats.js"></script>
<script type="text/javascript" src="db/skills.js"></script>
<script type="text/javascript" src="db/equips.js"></script>
<script type="text/javascript" src="db/conditions.js"></script>

<style>
@font-face{font-family:'tormenta20';src:url('src/Tormenta20.ttf') format('truetype');font-weight:normal;font-style:normal}
:root{--t20:#b72a2b;--black:#292929;--white:#fff;--transwhite:#ffffff80;--transblack:rgba(0,0,0,.8);--drawer:#dbdbdb;--diceroller:#e9e9e9;--overlay:#e8e8e8;--menu:#b72a2b;--bright:brightness(1.1);--t20white:#fff;--t20weight:400;--yellow:#f0dc82;--green:#2ecb57;--pv:#FF4466;--pm:#4BC7CF;--menulen:900%;--drh:90%;--hph:120px;--drb:calc(var(--hph) + 105px);--pvw:100%,--pmw:100%;--rot:#ef1313;--grun:#35a90f;--opc:0.93}

*,*:before,*:after{margin:0;padding:0;transition:all .6s ease-in-out,display 0s;font-family:'Open Sans', sans-serif;word-wrap:normal;word-break:keep-all;box-sizing:border-box}
html,body{overflow-x:hidden;width:100vw;min-height:100vh}
body:before{content:'';width:100vw;height:100vh;position:fixed;background-repeat:repeat;background-blend-mode:lighten;background-attachment:fixed;background-image:url("src/back.jpg");background-color:rgba(255,255,255,var(--opc));background-size:20em}

::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent;background:#f1f1f1}::-webkit-scrollbar-thumb{background:#bbb}::-webkit-scrollbar-thumb:hover{background:#999}::-webkit-scrollbar:horizontal,::-webkit-scrollbar-thumb:horizontal{display:}
body::-webkit-scrollbar{display:none}
br{content:'';display:block;margin:6px 0;line-height:2.2em}
div[onclick]{cursor:pointer}
input[type="number"],input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;-moz-appearance:textfield}

.row{display:grid;position:relative;width:100%}
.container{margin:auto;width:90%;display:inline-flex;max-width:600px}
.half,.third{float:left}.half{width:100%}.third{width:33.3333%}
.third .trash:before,.third .trash:after{transform:translateX(-2.8px)}

table{margin:auto;width:80%}
td,th{text-align:center;padding:5px}
tr:nth-child(even){background-color:rgba(0,0,0,.1)}

.divider{width:70%;max-width:500px;height:2px;margin:2.5em auto;background:rgba(32,32,32,.2)}
.t20box{margin:15px auto;border:30px solid transparent;padding:1em;background-color:var(--menu);color:var(--t20white);background-clip:padding-box;border-image:var(--backborder);max-width:600px;width:100%}
.t20box h2{color:var(--yellow);font-weight:400!important}

h1,h2{text-align:center;margin:0 0 .6em;letter-spacing:4px;font-family:'tormenta20';color:var(--menu);font-size:3em;font-weight:500;filter:var(--bright)}
h1{font-size:2.6em}h2{font-size:1.8em}
p,li{line-height:1.8em;letter-spacing:.8px;text-align:justify;font-size:1.2em;font-weight:500;margin:.5em 0;color:currentColor}
ul{margin:2em}b,.bold{font-weight:bold!important}i,.italic{font-style:italic!important}

#sections{width:var(--menulen);position:relative;display:flex}
.sec{width:100%;max-width:100%;min-height:100%;float:left;padding:35px 15px 125px 15px}

#dice_roller,#drawer{border-top-left-radius:25px;border-top-right-radius:25px;z-index:98}
#dice_roller{position:fixed;width:100%;height:105px;background:var(--diceroller);bottom:0}
#drawer{width:100%;height:35px;padding:15px 30%;background:var(--drawer)}.drew{height:var(--drh)!important}
#drawer div{width:100%;max-width:500px;height:100%;margin:auto;background:var(--white);border-radius:5px}
#dice{position:relative;padding:0 25px;width:100%;bottom:0}
#dice-input{position:absolute;bottom:0;padding:1.1em 1.3em;background:#ffffffd9}
#allrolls{bottom:60.06px;height:calc(100% - 60.06px);overflow-x:hidden;overflow-y:scroll;position:relative;top:0}
#results{position:relative;width:100%;padding:5px 25px}#results p:empty{height:5px}
#diceholder{position:relative;width:100%;height:calc(100% - var(--hph) - 105px);overflow:hidden}.diceholder{height:calc(100% - var(--hph) - 137px - 105px)!important}
.rot{color:var(--rot)}.grun{color:var(--grun)}
.magic{display:inline-block;position:absolute;padding:4px 0 0 4px}
.strike{opacity:.5}

.fakefocus{outline:1px auto #141414}
.fakefocus:after{content:'';animation:blink 1s step-end infinite;border-left:2px solid #000}
@keyframes blink{from,to{border-color:transparent}50%{border-color:#000}}

#keyboard{width:100%;height:206px;padding:3px;background:#403f3f;position:fixed;bottom:-206px;user-select:none;z-index:99}.keyboard{width:100%;max-width:500px}.boardshow{bottom:0!important}.keybar{float:left}
.key{vertical-align:top;justify-content:center;align-items:center;display:inline-flex;cursor:pointer;border-radius:4px;margin:3px;max-width:120px;position:relative;padding:0;color:#fff;font-size:1.4em}
.dkey:after{content:'';top:10px;right:10px;position:absolute;width:8px;height:8px;background:rgba(0,0,0,0.4);border-radius:50%}.nkey:after{background:#08ff00}
.keybar:nth-child(1){width:75%}.keybar:nth-child(2){width:25%}.hkey{display:none}
.skey,.lkey{height:44px;width:calc(33.33% - 6px);background:rgba(255,255,255,0.2)}.xkey{width:calc(100% - 6px);height:44px;background:rgba(255,255,255,.1)}
.keyext .keybar:nth-child(1){width:60%}.keyext .keybar:nth-child(2){width:40%}.keyext .hkey{display:inline-flex}
.keyext .xkey{width:calc(50% - 6px);height:27.4px;font-size:1.1em}
.enter{box-sizing:border-box;position:relative;display:block;width:22px;height:22px}
.enter::after,.enter::before{content:"";display:block;box-sizing:border-box;position:absolute;left:3px}
.enter::after{width:8px;height:8px;border-bottom:2px solid;border-left:2px solid;transform:rotate(45deg);bottom:3px}
.enter::before{width:16px;height:12px;border-bottom-right-radius:4px;border-bottom:2px solid;border-right:2px solid;bottom:6px}
.backspace{box-sizing:border-box;position:relative;display:block;width:14px;height:14px;border:2px solid;border-left:0;border-top-right-radius:2px;border-bottom-right-radius:2px;transform:scale(1.1);left:3px}
.backspace::after,.backspace::before{content:"";display:block;box-sizing:border-box;position:absolute;left:1px}
.backspace::before{background:linear-gradient(to left,currentColor 18px,transparent 0) no-repeat center center/10px 2px;border-right:3px solid transparent;box-shadow:inset 0 0 0 2px;right:2px;bottom:1px;width:8px;height:8px;border-left:3px solid transparent;transform:rotate(45deg)}
.backspace::after{width:10px;height:10px;border-top:2px solid;border-left:2px solid;border-top-left-radius:1px;transform:rotate(-45deg);top:0;left:-5px}
.keyhide:before{opacity:0}.keyhide:after{transform:rotate(-45deg);top:calc(50% - 5px);left:calc(50% - 5px)}

nav{position:fixed;left:0;bottom:0;height:70px;width:100%;background:var(--white);border-top:1px solid #EBEBEB;overflow-x:scroll;overflow-y:hidden;display:grid;z-index:99}
#menu{display:inline-flex;width:100%;max-width:1050px;margin:auto} /*width:160%*/
.menubtn{width:100%;min-width:80px;max-width:150px;height:70px;float:left;display:inline-flex;cursor:pointer}.menubi{margin:auto}
.menuicon{color:#b0b0b0;width:fit-content;margin:auto}
.menuicon svg{display:block;height:24px;width:24px;overflow:visible;fill:currentcolor}
.menuicon path{color:#b0b0b0}.menuselicon path{color:var(--menu);filter:var(--bright)}
.menutext{font-size:.625em;font-weight:600;color:#717171;margin-top:.2em;padding:.1em 0 .5em}.menuseltext{font-weight:700}

#spells_list,#powers_list{display:block}
.spells,.powers,.user_powers{cursor:pointer;border:1px solid transparent;border-radius:10px}
.more_info{margin:.5em 0;padding-top:10px;position:relative}/*border-color:rgba(32,32,32,.4);padding:15px 10px 20px*/
.item_subtitle{margin:0;font-size:.8em}.item_title{margin:auto 0;font-size:1em;font-weight:500;display:inline-flex}
.item_action{margin-right:0}.item_action div{margin:auto}
.hid{visibility:hidden;margin:0;max-height:0;overflow:hidden;opacity:0}
.nowrap{word-break:break-word;margin:0;font-size:1em}
.a_power{color:var(--white)!important;background:none!important}
.a_power:before{background:var(--white)}
.a_power:after{position:absolute;top:36px}

.input{position:relative;width:100%;margin:18px 0;color:var(--black)}
.fakeinput,input,select,textarea{border:1px solid #b0b0b0;border-radius:5px;font-size:1.1em;line-height:1.2em;-webkit-appearance:none;padding:1.6em 1.3em .5em;background:var(--transwhite);color:currentColor}
.fakeinput,input,select,label,textarea{width:100%}textarea{min-height:500px;line-height:1.3em;font-size:1em;padding:1.2em 1em}
label{position:absolute;left:0;top:0;pointer-events:none;color:#717171;padding:1.3em 1.6em}
input:focus ~ label,input:not(:focus):valid ~ label,select:focus ~ label,select:not(:focus):valid ~ label,.fakeinput:focus ~ label,.fakeinput:not(:empty) ~ label{font-size:.7em;padding:.4em 2.1em;margin:.3em 0;left:2px}
.select{padding:.8em;margin:0}
input[type="file"]{display:none}
label[for="file"]{position:relative;pointer-events:all}
.fakeinput{height:60.06px;cursor:text;white-space:nowrap;overflow:hidden}.fakeinput:focus{outline:1px auto #141414}
.t20box .fakeinput,.t20box input,.t20box select{background:#ffffff40;border:1px solid currentColor}.t20box label,.t20box input::placeholder,.t20box .input{color:currentColor}
.t20box input:focus,.t20box select:focus{outline:1px solid currentColor}
option{color:var(--black)!important}
input[type=color]{padding:0;width:60px;height:37px;margin:9px 0}
.hab,#spell_hab{padding:1em .8em}
input,select,.fakeinput{min-width:70px}

.fakebtn,button,label[for="file"]{padding:14px 26px;text-align:center;text-decoration:none;display:inline-block;font-size:100%;margin:10px 0;cursor:pointer;border-radius:5px; width:100%;background:var(--transwhite);border:2px solid var(--black);color:var(--black);font-weight:600}
.fakebtn:hover,button:hover,button:focus,label[for="file"]:hover,label[for="file"]:focus{background:var(--black);color:#e8e8e8}
.delete{border:2px solid var(--menu);color:var(--menu);filter:var(--bright)}.delete:hover{background:var(--menu);color:var(--white);filter:var(--bright)}
button:disabled,button:hover:disabled{border:2px solid #b0b0b0;color:#b0b0b0;background:var(--transwhite);cursor:no-drop}
.fakebtn{padding:0}

a{color:currentColor;padding:12px 30px;text-decoration:none;display:block;line-height:1.5em}
a:hover{background-color:#1e90ff;color:var(--white)!important}
.dropdown,.dropequip{position:absolute;background-color:var(--white);color:var(--black);border:1px solid #000;z-index:1;width:100%;top:60px;max-height:350px;overflow-y:scroll;z-index:2}
.dn{display:none!important;border:0}.w0{width:0;visibility:hidden}

#char_spells{margin:25px auto}
.backdrop,.overlay{width:100%;left:0;top:0;inherit!important}
.backdrop{height:100%;position:fixed;top:0;background:hsl(0 0% 10%/.3)}
.overlay{height:100%;position:absolute;background:var(--overlay);margin-top:100px;overflow-x:hidden;overflow-y:scroll;padding:50px 25px 150px;bottom:0;box-shadow:0 0 20px rgb(0 0 0 / 10%)}
.invisible{opacity:0;visibility:hidden;pointer-events:none;top:100%}
#spell_overlay{height:200%}
.spell_lvl:empty{opacity:0;visibility:hidden}
.spell_lvl_head{margin:1em 0 0;font-weight:700;padding:.5em 1em;cursor:pointer;display:inline-flex;width:100%}.spell_lvl_head > p{font-weight:700;margin:0}
.arrow-down{width:8px;height:8px;border-bottom:2px solid;border-left:2px solid;transform:rotate(-45deg);margin:auto}.arrow-up{transform:rotate(135deg)}
.spell_details,.power_details{padding:.3em 1em;border-radius:10px}
.spell_add,.spell_delete{width:60%;margin:20px 20%} /*width:fit-content;margin:10px;position:absolute;top:0;right:0*/
.spell_add{border-color:var(--green);color:var(--green);background:transparent}
.spell_add:hover,.spell_add:focus{background:var(--green);color:#fff}
#all_spells .spell_delete,#char_spells .spell_add,#all_powers .spell_delete,#powers .spell_add,#user_powers .spell_add{display:none}
.powe{}

#habilidades .input{margin:8px 0}
.hab_label{transform:rotate(180deg);margin:auto;writing-mode:vertical-lr}
.dice{width:50%;margin:auto;max-height:45px;transform:translateY(-1px)}
.t20box svg,.t20box g{fill:currentColor;color:currentColor;width:100%;height:100%;background:none!important}

.skills{margin-bottom:1em}
#char_skills svg,#char_crafts svg,#char_attack svg{width:72%;height:72%}
.skills.t20box{margin:0 auto 30px;width:70%;padding:0 20px}.skills.t20box .w10{margin:1% 0}
.p_skill,.skill_input{font-size:1em}
.p_skill{margin:auto 0;width:100%;padding:0 .8em}.skill_input{padding:.8em;max-height:55px}
.skills.t20box:after{top:-15px;left:26%;margin-left:-4px;border-width:8px;border-style:solid;border-color:transparent transparent var(--menu) transparent;content:"";position:absolute}
.skill_info{max-height:550px}.skill_hide{max-height:0;opacity:0;visibility:hidden}
.dice svg{height:fit-content;background:var(--transwhite)}

#char_skills select,#char_ac select,#char_rd select{max-height:55px;margin:auto}

.def_info{background:rgba(0,0,0,.3);margin:10px auto 25px;padding:30px 10px;position:relative;max-height:1000px}
.def_info:before,.attack_info:before{top:-16px;left:25px;border-width:8px;border-style:solid;border-color:transparent transparent var(--transblack) transparent;content:"";position:absolute}
.def_info:before{border-color:transparent transparent rgba(0,0,0,.3) transparent}
.def_hide{margin:0 auto!important;max-height:0;opacity:0;visibility:hidden;padding:0 10px!important}
.def_input{text-align:center;padding:1.6em .8em .5em;font-size:1em}
#char_attack input,#char_ac input{font-size:1em}#char_attack .w6{max-width:140px}
#char_ac label{margin:.3em 0;padding:0;width:100%;text-align:center;left:0}
.def_half,.def_quarter{float:left;padding:5px}.def_half{width:100%}.def_quarter{width:49.9999%}
.def_half label,.def_quarter label{top:5px}
.def_info .w10{margin:1% 0}
.def_half .dropequip{margin:2px 0}

.attack,.equip{margin:1em auto}
.attack .dice{width:45%;max-width:45px;justify-content:flex-end}.skills .dice{margin-right:0}
.attack_info{background:var(--transblack);margin:10px auto 0;padding:20px 25px;position:relative;color:var(--white)}
.attack_info input,.attack_info select,.attack_info textarea{color:var(--black);background:#ffffffe8}.attack_info .w10{margin:5px 0}.attack_info textarea{min-height:125px;field-sizing: content}
.w5at{width:100%;margin:auto;float:left}.w5at:nth-child(2){padding:10px}
@media (min-width:900px){.w5at{width:49.9999%}.w5at:nth-child(2){padding:0}.attack .dice{justify-content:unset;width:90%}}

.equip_btns{margin:auto;margin-left:2em;max-height:40px;max-width:120px;padding-top:5px}.equip_btns > div{max-width:40px}
.equip_btn{padding:0;min-width:33.3333%;width:33.3333%}
.equip_btn .trash{color:var(--black)}.equip_btn:hover .trash{color:var(--white)}
.equip_btn .trash,.equip_btn .trash:before,.equip_btn .trash:after{transition:all .5s}
.overloaded{color:#ef1313;font-weight:500!important}
.dropequip{top:calc(100% - 2px);width:calc(100% - .6em);margin:.1em .3em}

.skills.attack_info{width:90%;margin:0 auto 35px}.skills.attack_info:before{left:65px}

.checkbox{position:relative;margin:auto;width:25px;height:25px;border:2px solid #dbdbdb;border-radius:4px;background:var(--transwhite)}
.markedbox:after{width:8px;height:13px;border:1px solid var(--menu);border-width:0 2px 2px 0;transform-origin:bottom left;transform:rotate(45deg);position:absolute;top:-3px;left:3px;content:"";display:block}

.switch{position:relative;display:inline-block;width:60px;height:20px;pointer-events:all}
.switch input{opacity:0;width:0;height:0;margin:0;padding:0}
.slider{position:absolute;cursor:pointer;top:calc(50% - 14px);left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:24px;width:24px;left:4px;bottom:5.5px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}
input:checked+.slider{background-color:var(--menu);filter:var(--bright)}
input:focus+.slider{box-shadow:0 0 1px var(--menu);filter:var(--bright)}
input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}

.w10,.w9,.w8,.w7,.w6,.w5,.w4,.w3,.w2,.w1{display:block;float:left}.mw400{max-width:400px}.mw450{max-width:450px}
.w10{width:100%}.w9{width:90%}.w8{width:80%}.w7{width:70%}.w6{width:60%}.w5{width:50%}.w4{width:40%}.w3{width:30%}.w2{width:20%}.w1{width:10%}
.pr{position:relative}.z1{z-index:1}.mwu{min-width:40px}
.dif{display:inline-flex}.db{display:block}.df{display:flex}.dfw{display:flex;flex-wrap:wrap;flex-direction:row-reverse}.dg{display:grid}.mh51{min-height:51px}
.ma{margin:auto}.m0{margin:0}.m0a{margin:0 auto}.ma0{margin:auto 0}.ms{margin-top:.4em!important}.mt0{margin-top:0}.ml{margin-left:2em}.m3e{margin:.1em .3em}.mt{margin-top:1.5em!important}.mt1{margin-top:1em!important}.ma3{margin:auto .3em;min-height:47px}
.ha{height:auto}.tal{text-align:left}.tc,.tac{text-align:center!important}.tac{padding-left:0!important;padding-right:0!important}
.invert,.hpinvert{-webkit-filter:invert(1);-moz-filter:invert(1);-o-filter:invert(1);-ms-filter:invert(1);filter:invert(1)}.hpinvert{color:#fff}.hpinvert .slash{border-color:#fff}

.cont_bar{position:relative}
.hpbar{display:flex;min-height:45px}
#hpbar{background:#f76d6d9c}#mpbar{background:#6dadf79c}
.hpbar::after{content:"";position:absolute;top:0;left:0;height:100%;z-index:-1}
.hp::after{background:#f76d6d;width:var(--pvw)}.mp::after{background:#6dadf7;width:var(--pmw)}.sp::after{background:#6ff76de3}.ep::after{background:#f7e76de3}.xp::after{background:#c26df7e3}
.hp_input{position:relative;width:50%;height:unset!important;padding:1.1em 1.3em;border:none!important;background:none!important}.hp_input:nth-child(1){text-align:right}
.slash{border-bottom:1px solid var(--black);transform:rotate(-75deg);width:6%;height:100%;margin-top:30px}
.hpcont{height:var(--hph)}

.cond_user,.conditions{position:relative;padding:.3em 1em;height:unset;text-indent:0;margin:5px 0}
.cond_user:before,.conditions:before{top:9px}.cond_user:after,.conditions:after{transform:rotate(45deg);position:absolute;top:7px;left:13px}
.cond-hide{max-height:0;opacity:0}.cond-show{max-height:unset;opacity:1}
.condmark,.condmarked{position:relative;float:left;margin:13px auto;width:22px;height:22px;border:2px solid #dbdbdb;border-radius:4px;color:var(--black)!important;background:var(--transwhite)}
.condmarked::after{content:"";display:block;width:8px;height:13px;border:1px solid var(--menu);border-width:0 2px 2px 0;transform-origin:bottom left;transform:rotate(45deg) translate(-2.5px,-4px)}
.cond_info{margin-bottom:2em}.cond_info:before{left:70px}
.effect_add{background-color:#555555;color:white;border:2px solid #555555;font-weight:600;padding:5px 13px;text-align:center;text-decoration:none;display:inline-block;font-size:85%;margin-right:15px}.effect_add:hover{background-color: white;color:var(--black)}

.gray{color:#aaa}
.config{line-height:.4em;margin:.5em 0}
.hint,.hint:before{position:absolute}
.hint{background:var(--transblack);padding:1.2em 1.6em;width:70%;font-size:.9em;z-index:999;color:var(--white);text-align:justify}
.hint:before{content:'';border:8px solid transparent;border-color:transparent transparent var(--transblack) transparent}

.hint0{margin-top:-7px;left:10%}.hint0:before{left:10%;top:-16px}
.hint1{margin-top:11%;right:20%;width:60%}.hint1:before{right:25%;top:-16px}
.hint2,.hint3{width:43%}.hint2:before,.hint3:before{bottom:-16px;transform:rotate(180deg)}
.hint2{bottom:115px;right:5%}.hint2:before{right:10%}
.hint3{bottom:80px;left:5%}.hint3:before{left:10%}

@media (min-width:1300px){
.half{width:39.99999%;margin:0 5%}
.third{width:33.33333%}
.container{width:85%}
.overlay{max-width:800px;left:50%;margin-left:-400px;height:calc(100% - 200px)}
/* .m0{margin:18px 0} */
#sections{width:calc(var(--menulen)/2)} /* 450%*/
#dice_roller{width:60%;margin:0 20%}
#keyboard{background:#403f3fdb}
}
@media (min-width:520px){.def_half,.def_quarter{padding:0 5px}.def_half{width:49.9999%}.def_quarter{width:24.9999%}.def_half label,.def_quarter label{top:0}}
</style>
</head>

<body class="body1">
<div id="sections">
 <div id="sec_char" class="sec">
  <h1>Personagem</h1>
  <div class="row"><div class="container db">
   <div class="half">
    <div class="input mt0">
     <input id="char" class="drop" type="text" onclick="char_list(this)" onkeyup="regex_inj(this);char_list(this);filter(this)" autocomplete="off" required>
     <label>Personagem</label>
     <div class="dropdown dn"></div>
    </div>
   </div><div class="half">
    <div class="input mt0"><input id="jogador" type="text" onchange="data_array(this)" onkeyup="regex_inj(this)" required><label>Jogador</label></div>
   </div>
  </div></div>

  <div id="habilidades" class="row"><div class="container t20box db"><div class="half"></div><div class="half"></div></div></div>

  <div class="row"><div class="container db">
   <div class="half">
    <div class="input"><select id="raça" onchange="data_add(this);race(this)" required></select><label>Raça</label></div>
    <div class="input"><select id="origem" onchange="data_add(this)" required></select><label>Origem</label></div>
    <div class="input"><select id="tamanho" onchange="data_add(this)" required></select><label>Tamanho</label></div>
    <div class="input m0"><div id="deslocamento" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Deslocamento</label><div class="dropdown dn"></div><p class="item_subtitle m3e"></p></div>
   </div>
   <div class="half">
    <div class="row dif">
     <div class="w10 input"><div id="classe" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Classe</label><div class="dropdown dn"></div></div>
     <div class="w1"></div>
     <div class="w3 input"><select id="nível" class="tc" onchange="data_add(this);calc()" required></select><label class="tac">Nível</label></div>
    </div>
    <div class="input mt0"><input id="distincao" onchange="data_array(this)" onkeyup="regex_inj(this)" autocomplete="off" required><label>Distinção de classe</label></div>
    <div class="input mt0"><div id="divindade" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Divindade</label><div class="dropdown dn"></div></div>
    <div class="input"><input id="xp" type="number" onchange="data_add(this)" onkeyup="regex_inj(this)" autocomplete="off" required><label>Experiência</label></div>
   </div>
  </div></div>

  <div class="divider"></div>

  <div class="row"><div class="container db mw400">
   <button onclick="" disabled>Imprimir</button>
   <label for="file"><input id="file" type="file" onchange="import_char(event)">Importar</input></label>
   <button onclick="export_char()">Exportar</button>
   <button id="chardel" class="delete" onclick="char_remove()" disabled>Deletar</button>
  </div></div>

 </div>

 <div id="sec_combat" class="sec">
  <h1>Combate</h1>
  <div class="row t20box">
   <div class="container dif z1" onclick="defense_info('char_ac')">
    <div class="w8"><p>Defesa</p></div>
    <div class="w3"><p id="ac" class="tac">10</p></div>
   </div>
   <div id="char_ac" class="container db def_info mw400 def_hide">
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab" class="select tc" onchange="def_set(this);calc()">
      <option disabled=""></option><option value="1">for</option><option value="2" selected>des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Habilidade</p>
    </div></div>
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab2" class="select tc" onchange="def_set(this);calc()">
      <option selected></option><option value="1">for</option><option value="2">des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Hab secundária</p>
    </div></div>
    <div class="w10 dif">
     <div class="w3 m0a dif"><input id="def_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off"></div>
     <div class="w6 m0a dif"><p class="p_skill">Outro</p></div>
    </div>
    <div class="w10 dif">
     <div class="w3 m0a mh51 dif"><p class="p_skill tac skill_lvl">+0</p></div>
     <div class="w6 m0a dif"><p class="p_skill">1/2 do nível</p></div>
    </div>
    <div class="w10 dif">
     <div class="w3 m0a mh51 dif"><p id="def_cond" class="p_skill tac">+0</p></div>
     <div class="w6 m0a dif"><p class="p_skill">Condições</p></div>
    </div>
    <div class="w10 df"><div class="w8 ma mw400 df"><p class="p_skill tac">Armadura e Escudo</p></div></div>
    <div class="w10 df"><div class="w10 mw400 ma db">
     <div class="def_half pr"><input id="armor" type="text" onchange="def_set(this);calc()" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,armor_list)" autocomplete="off"><label>Armadura</label></div>
     <div class="def_quarter m0a pr"><input id="armor_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off"><label class="def_label">Bônus</label></div>
     <div class="def_quarter m0a pr"><input id="armor_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off"><label class="def_label">Penalidade</label></div>
    </div></div>
    <div class="w10 df"><div class="w10 mw400 ma db">
     <div class="def_half pr"><input id="shield" type="text" onchange="def_set(this);calc()" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,armor_list)" autocomplete="off"><label>Escudo</label></div>
     <div class="def_quarter pr"><input id="shield_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off"><label class="def_label">Bônus</label></div>
     <div class="def_quarter pr"><input id="shield_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc()" autocomplete="off"><label class="def_label">Penalidade</label></div>
    </div></div>
    <div id="armor_penal" sign="1" style="height:50px"></div><div id="shield_penal" sign="1"></div>
   </div>
   <div class="container dif z1">
    <div class="w8" onclick="defense_info('char_rd')"><p>Redução de Dano</p></div>
    <div class="w3"><input id="rd" class="skill_input tac" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);rd_calc()" autocomplete="off"></div>
   </div>
   <div id="char_rd" class="container db def_info mw400 def_hide"></div>
  </div>

  <div class="row"><div id="char_attack" class="container db z1">
  </div></div>
  <div class="row"><div class="container">
   <button onclick="attack_add()">Adicionar ataque</button>
  </div></div>
 </div>

 <div id="sec_skills" class="sec">
  <h1 style="margin-bottom:.6em">Perícias</h1>
  <div class="row"><div id="char_skills" class="db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado&#9;‡penalidade de armadura</p></div></div>
  <h1 style="margin:2em 0 .6em">Ofícios</h1>
  <div class="row"><div id="char_crafts" class="db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado</p></div></div>
 </div>

 <div id="sec_feat" class="sec">
  <h1>Poderes</h1>
  <div class="row"><div id="powers" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_power')">Buscar poderes</button>
  </div></div>
  <h1 style="margin:2em 0 .6em">Poderes Personalizados</h1>
  <div class="row"><div id="user_powers" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="user_power()">Adicionar poder personalizado</button>
  </div></div>
 </div>

 <div id="sec_spell" class="sec">
  <h1>Magias</h1>
  <div class="row t20box">
   <div class="container">
    <div class="w8"><p>Atributo chave</p></div>
    <div class="w3"><select id="spell_hab" class="select tc" onchange="data_add(this);calc()"></select></div>
   </div><div class="container">
    <div class="w8"><p class="tal">Teste de resistência</p></div>
    <div class="w3 dif"><p id="spell_res" class="ma" inner="1">10</p></div>
   </div>
  </div>
  <div class="row"><div id="char_spells" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_spell')">Buscar magias</button>
  </div></div>
 </div>

 <div id="sec_condition" class="sec">
  <h1>Condições</h1>
  <div class="row"><div id="conditions" class="container dg"></div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">As condições acima encontram-se descritas na página 394 do livro <i>Tormenta 20: Jogo do Ano</i>.</p>
  </div></div>

  <h1 style="margin:2em 0 .6em">Condições Personalizadas</h1>
  <div class="row"><div id="cond_user" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="cond_create()">Adicionar condição</button>
  </div></div>
 </div>

 <div id="sec_equip" class="sec">
  <h1>Equipamentos</h1>
  <div class="row"><div id="char_equip" class="container db"></div></div>
  <div class="row"><div class="container">
   <button id="equip_add" onclick="equip_add(1,'','','','','')">Adicionar equipamento</button>
  </div></div>


  <h1 style="margin:2em 0 .6em">Moedas</h1>
  <div class="row"><div class="container dif">
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">TO</p></div><div class="w5 dif"><input id="to" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">T$</p></div><div class="w5 dif"><input id="ts" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">TC</p></div><div class="w5 dif"><input id="tc" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">Cada mil moedas, independentemente do tipo, ocupam 1 espaço.</p>
  </div></div>

  <h1 style="margin:2em 0 .6em">Capacidade de Carga</h1>
  <div class="row"><div class="container mw450 dif">
   <div class="w5 dif">
    <div class="w5 dif"><p class="item_title ma">Atual</p></div>
    <div class="w3 dif"><p id="carga" class="item_title ma" style="font-weight:300">0</p></div>
   </div>
   <div class="w5 dif">
    <div class="w5 dif"><p class="item_title ma">Máximo</p></div>
    <div class="w3 dif"><input id="carga_cap" class="skill_input mwu tc" type="number" placeholder="10" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div>
   </div>
  </div></div>
  <div class="row"><div class="container df">
   <p class="item_subtitle ma ms tc">Você pode carregar 10 espaços +2 por ponto de Força (ou -1 por ponto de Força negativo). Se ultrapassar esse limite, fica <i>sobrecarregado</i> (veja Limites de Carga na página 141). Você não pode carregar mais do que o dobro do seu limite.</p>
  </div></div>
  <div class="row mt"><div class="container df">
   <p class="item_subtitle ma ms tc"><b>Observação:</b> ao criar um personagem você começa com um Traje do Viajante, uma Mochila, um Saco de Dormir, uma arma simples e, se tiver proficiência, uma arma marcial à sua escolha, e uma armadura leve (exceto <i>Arcanistas</i>) ou uma Brunea e/ou um escudo leve se tiver as respectivas proficiências, além de T$ 4d6 (veja Equipamento Inicial na página 140).</p>
  </div></div>
 </div>

 <div id="sec_notes" class="sec">
  <h1>Anotações</h1>
  <div class="row"><div class="container db">
   <textarea id="anot" onchange="data_array(this)"></textarea>
  </div></div>
 </div>

 <div id="sec_config" class="sec">
  <h1>Configurações</h1>

  <div class="row"><div class="container">
   <div class="w8"><p>Teclado avançado</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_keyboard" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8 config"><p class="m0">Esconder rolador de dados</p><p class="item_subtitle">(prefiro dados físicos!)</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_dice" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo tela cheia</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_fullscreen" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo noturno</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_nocturnal" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Vibrar</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_vibrate" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8 config"><p class="m0">Esconder Magias</p><p class="item_subtitle">(para guerreiros)</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_magic" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>

  <div class="row"><div class="container">
   <div class="w8"><p>Cor customizada</p></div>
   <div class="w2 ma ml tc"><input id="c_color" type="color" value="#b72a2b" onchange="data_array(this);config()"></div>
  </div></div>
  <div class="divider"></div>

  <div class="row"><div class="container db">
   <p>Essa ferramenta é desenvolvida de forma independente para fins recreativos apenas, ou seja, sem fins lucrativos.</p>
  </div></div>
  <div class="row"><div class="container t20box db">
   <p>Direitos referentes ao conteúdo Tormenta 20 reservados à seus criadores e à Editora Jambo.</p>
  </div></div>
  <div class="row"><div class="container db">
   <p>Direitos referentes ao código e API reservados exclusivamente ao autor.</p>
  </div></div>
  <div class="divider"></div>
  <div class="row"><div class="container db">
   <p>Seus dados são armazenados <b>apenas</b> localmente neste dispositivo, ou seja, nada é armazenado online ou em outro dispositivo.</p>
   <p class="mt">Use as opções <b>importar</b> e <b>exportar</b> para transferir seu personagem entre dispositivos.</p>
   <p class="mt">Caso deseje exluir todos os dados, por favor, utilize o botão a seguir. Eles <b>não</b> poderão ser recuperados.</p>
  </div><div class="container mw400 mt">
   <button class="delete" onclick="reset()">Excluir todos os dados</button>
  </div></div>
 </div>

</div>

<div id="dice_roller">
 <div id="drawer" onclick="openroller(this)"><div></div></div>
  <div class="hpcont">
   <div id="hpbar" class="cont_bar">
    <div class="container hpbar hp">
     <div class="fakeinput hp_input" id="hp" onclick="set_focus(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="hpmax" onclick="set_focus(this)" inner="1">0</div>
    </div>
   </div>
   <div id="mpbar" class="cont_bar">
    <div class="container hpbar mp">
     <div class="fakeinput hp_input" id="mp" onclick="set_focus(this)" inner="1">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="mpmax" onclick="set_focus(this)" inner="1">0</div>
    </div>
   </div>
  </div>
  <div id="diceholder">
   <div id="allrolls"><div id="results"><p><b>Exemplos de rolagens:</b></p></div></div>
   <div id="dice-input" class="fakeinput" onclick="set_focus(this)"></div>
  </div>
</div>

<nav>
 <div id="menu">
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon menuselicon"></div><div class="menutext menuseltext">Personagem</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Combate</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Perícias</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Poderes</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Magias</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Condições</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Equipamentos</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Anotações</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Configurações</div></div></div>
 </div>
</nav>

<div id="keyboard" class="row"><div class="container keyboard"></div></div>

</div></div>

<div id="backdrop_power" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="power_name" type="text" onkeyup="regex_inj(this);filter_powers_name(this)" autocomplete="off" required><label>Nome</label></div>
   <div class="input"><div id="power_type" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Tipo</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="power_cat" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Raça, classe, categoria</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_powers" class="container db"></div></div>
 </div>
</div>

<div id="backdrop_spell" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="spell_name" type="text" onkeyup="regex_inj(this);filter_spell_name(this)" autocomplete="off" required><label>Nome</label></div>
   <div class="input"><div id="spell_class" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Classificação</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_level" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Nível</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_school" class="fakeinput drop" onclick="show_list(this)" tabindex="3"></div><label>Escola</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_spells" class="container db"></div></div>
 </div>
</div>

</body>

<script>
const load = 1;
var title = '', chars = [], loaded = 0;
const data_ini = {
 'nível':0,hp:0,hpmax:0,mp:0,mpmax:0,'spell_hab':1,
 'hab_for_val':10,'hab_for':0,'hab_des_val':10,'hab_des':0,'hab_con_val':10,'hab_con':0,'hab_int_val':10,'hab_int':0,'hab_sab_val':10,'hab_sab':0,'hab_car_val':10,'hab_car':0,
 'magias':[],'powers':[],user_powers:[],'conditions':[[],[]],'cond_user':[],'attack':[],'equip':[],cond:structuredClone(cond),'skills':skills,'crafts':crafts,
 'defense':{'def_hab':2,'armor_bonus':0,'shield_bonus':0,'armor_penal':0,'shield_penal':0,'def_out':0,'rd':0,'Ácido':0,'Eletricidade':0,'Fogo':0,'Frio':0,'Luz':0,'Trevas':0,'Mágico':0},
 'carga':{'to':0,'ts':0,'tc':0,'carga':0,'carga_cap':10},
 'c_color':'#b72a2b','c_keyboard':0,c_dice:false,'c_fullscreen':0,'c_nocturnal':0,'c_vibrate':0
}
var data = structuredClone(data_ini);

//-------------------------DICE ROLLER FUNCTIONS------------------------//

const keyels = ['d','!','rra','rrb','eh','el','kh','kl'];
//const keylen = [3,2,2,2,2,2,2,2];
//const keypos = [0,3,5,5,7,7,7,7];

//Array.prototype.move = function(from,to,len=1){this.splice(to,0,...this.splice(from,len))}
function fix_str(str){
 let str2 = [];
 str = str.replaceAll(' ','').replaceAll('+','_+_').replaceAll('-','_-_').split('_');	//splits string into smaller strings inside arrays
 for(let i=0;i<str.length;i++){
  if(str[i]!='+'&&str[i]!='-'){
   if(isNaN(str[i][0])){str[i]=1+str[i]}	//add 1 in front of d if empty
   if(isNaN(str[i][str[i].length-1])){str[i]+='_'}	//add _ to end if no number
   for(let j=0;j<keyels.length;j++){str[i] = str[i].replaceAll(keyels[j],'_'+keyels[j]+'_')}	//places keysel in between _s
   while(str[i].includes('__')){
    let pos = str[i].indexOf('__')-1;
    let arg = (str[i][pos]=='!'||str[i][pos]=='a')?'max':1;
    str[i] = str[i].slice(0,pos+2) + arg + str[i].slice(pos+2);		//replaces __ for 1 or max
   }
   if(str[i][str[i].length-1]=="_"){str[i]=str[i].substring(0,str[i].length-1)}	//remove last _
   str[i] = str[i].split('_');	//transform string to array
   while(str[i].indexOf('max')>0){str[i][str[i].indexOf('max')] = str[i][2]}	//replaces max for number
   //while(str[i].length<9){str[i].push(undefined)}	//fill in array with undefined
   for(let j=0;j<str[i].length;j++){if(!isNaN(str[i][j])){str[i][j]=JSON.parse(str[i][j])}}	//parse numbers

   //for(let j=keyels.length-1;j==2;j--){if(str[i].includes(keyels[j])){str[i].move(str[i].indexOf(keyels[j]),keypos[j],keylen[j])}}	//change position in array

   str2[i] = {num:str[i][0]};	//builds associative object with array contents, position becomes unimportant
   for(let j=1;j<str[i].length;j+=2){str2[i][str[i][j]] = str[i][j+1]}
  }else{str2[i] = {sign:str[i][0]}}
 }
 return [str2,str.join('').replaceAll(',','').replaceAll('+',' + ').replaceAll('-',' - ')]
}

function roll_dice(num,max,exp=max+1,rra=max+1,rrb=-1){
 rrb = (rrb<exp-1)?rrb:exp-2;
 let roll = [];
 let rolled = '';
 for(k=0;k<num;k++){
  rolled = Math.floor(Math.random()*max)+1;
  roll.push(rolled);
  while(rolled>=exp||rolled>=rra||rolled<=rrb){
   rolled = Math.floor(Math.random()*max)+1;
   roll.push(rolled);
  }
 }
 return roll;
}

var soma,roll;
function diceroll(str,crit=0){
 let repeat = 1;
 if(str.includes("#")){
  repeat = str.slice(0,str.indexOf('#'));
  str = str.slice(str.indexOf('#')+1,-1);
 }

 [subarrays,str] = fix_str(str);

 for(var reroll=0;reroll<repeat;reroll++){
  soma = 0;
  roll=[];
  let dices='', sum=[], alg='+', print=' ⟵',ctp = 0;
  for(i=0;i<subarrays.length;i++){
   if(subarrays[i].d){
    roll[i] = roll_dice(subarrays[i].num,subarrays[i].d,subarrays[i]['!'],subarrays[i].rra,subarrays[i].rrb);	//rolling dices

    dices = subarrays[i].num;
    for(let j in keyels){if(subarrays[i][keyels[j]]){dices+=keyels[j]+subarrays[i][keyels[j]]}};	//joining str for printout

    crit = subarrays[i]['!']?subarrays[i]['!']:subarrays[i].d;	//determining crit (max or !)
    roll[i] = roll[i].sort(function(a,b){return b-a});  //sorting rolls

    let start=0,end=roll[i].length;		//determining with dice removals start and end points
    if(subarrays[i].rra){roll[i].forEach(function(el){if(el>=subarrays[i].rra){start++}})}
    else if(subarrays[i].rrb){roll[i].forEach(function(el){if(el<=subarrays[i].rrb){end--}})}

    if(subarrays[i].eh){start+=subarrays[i].eh}		//changing start and end based on eh, el, kh, kl
    else if(subarrays[i].el){end-=subarrays[i].el}
    else if(subarrays[i].kh){end=start+subarrays[i].kh}
    else if(subarrays[i].kl){start=end-subarrays[i].kl}

    for(j=start;j<end;j++){	//summing roll values
     if(alg=='+'){sum.push(roll[i][j])}
     if(alg=='-'){sum.push(-roll[i][j])}
    }

    for(j=0;j<roll[i].length;j++){	//marking dice rolls crits and removals
     let classe = '';
     print += j?', ':' [';
     if(j<start||j>end-1){classe+=' strike'}
     if(roll[i][j]==1){classe+=' bold rot';ctp=-1}
     if(roll[i][j]>=crit){classe+=' bold grun';ctp=1}
     print += '<span class="'+classe+'">'+roll[i][j]+'</span>';
    }
    print += '] ' + dices;

   }else if(subarrays[i].sign){alg=subarrays[i].sign;print+=' '+alg+' '}	 //+ or -, no d
    else{	//contant number, no d
    if(alg=='+'){sum.push(subarrays[i].num)}
    if(alg=='-'){sum.push(-subarrays[i].num)}
    print+=' '+subarrays[i].num+' ';
   }

  }
  if((str.match(/d/g) || []).length==1&&str.match(/d20/g)&&ctp){ctp = ctp>0?' ⟵ Acerto crítico!':' ⟵ Falha crítica!'}
  else{ctp=''}

  for(j=0;j<sum.length;j++){soma+=sum[j]}
  print = '<span class="bold">'+soma+'</span>'+print+ctp;
  print_out(print);
 }
}

function scroll_down(e){setTimeout(function(){e=document.getElementById(e);e.scroll({top:e.scrollHeight,behavior:"smooth"})},700)}
function print_out(print){
 var card = document.createElement('p');
 card.innerHTML = print;
 document.getElementById("results").appendChild(card);
 scroll_down('allrolls');
}

function startroll(e){
 value = document.getElementById(e).innerHTML;
 if(e.includes('hab')){print_out('Teste de '+habis[habs.indexOf(e.replace('hab_',''))])}
 if(e.includes('total')){print_out('Teste de '+e.slice(0,-6))}
 if(e.includes('dice')){print_out(value);diceroll(value)}
 else{diceroll('d20'+value);openroller(document.getElementById('drawer'))}
 print_out('');
}

print_out('d20+2');diceroll('d20+2');print_out('');
print_out('2d20-2');diceroll('2d20-2');print_out('');
print_out('2#d12+1');diceroll('2#d12+1');print_out('');
print_out('2d10+2d8-2');diceroll('2d10+2d8-2');print_out('');
print_out('3d8! (explosão)');diceroll('3d8!');print_out('');
print_out('3d8!5 (explosão em 5+)');diceroll('3d8!5');print_out('');
print_out('4d6kh3 (keep higher 3)');diceroll('4d6kh3');print_out('');
print_out('4d6el (eliminate lower)');diceroll('4d6el');print_out('');
print_out('5d4!kl2 (keep lower 2)');diceroll('5d4!kl2');print_out('');
print_out('5d4eh2!3 (eliminate higher 2)');diceroll('5d4eh2!3');print_out('');
print_out('5d4rra (reroll 4)');diceroll('5d4rra');print_out('');
print_out('6d6rrb2 (reroll 2-)');diceroll('6d6rrb2');print_out('');
print_out('4d8!rrb2 (explosão,reroll 2-');diceroll('4d8!rrb2');print_out('');
print_out('6d10!8rrb2el+3 (explosão 8+, reroll 2-, eliminar o menor)');diceroll('6d10!8rrb2el+3');print_out('');

/*
let xxx = ['4d3!rrb + 4d4!rra + 4d6!rrbel + 4d3!rrael + 4d4!rrbeh + 2 + 4d6!rraeh + 4d3!rrbkh + 4d4!rrakh + 4d6!rrbkl + 4d3!rrakl'];
//let xxx = ['5d6rraeh2','5d6rrael2','5d6rrakh2','5d6rrakl2','5d6rrbeh2','5d6rrbel2','5d6rrbkh2','5d6!5rrbkl2','5d6!5rraeh2','5d6!5rrael2','5d6!5rrakh2','5d6rra!5kl2','5d6rrbeh2!5','5d6rrb!5el2','5d6rrbkh2!5','5d6!5rrbkl2'];
for(let i=0;i<xxx.length;i++){print_out(xxx[i]);diceroll(xxx[i]);print_out('')}
*/

//-------------------------HP, MP and DICE KEYBOARD FUNCTIONS------------------------//

const keys = [[7,8,9,4,5,6,1,2,3,'AC',0,'dx'],['d10','d20','d100','d6','d8','d12','d2','d3','d4','AC','d','123'],[70,80,90,40,50,60,10,20,30,'AC',100,'123']];
const xkeys = ['rra','rrb','kh','kl','eh','el','#','!','+','-','backspace','enter'];
const ykeys = ['max PV','max PM',125,150,175,200,250,300];
const keyboard = document.getElementById('keyboard');

var skeys,zkeys,keysend;
function set_keyboard(){
 e = keyboard.children[0];

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<keys[0].length;i++){
  if(keys[0][i]=='dx'){content += '<div id="shiftkey" class="key skey dkey" onclick="keyshift(this)">dx</div>'}
  else if(keys[0][i]=='AC'){content += '<div class="key skey" onclick="keyac()">AC</div>'}
  else{content += '<div class="key skey" onclick="keyprint(this)">'+keys[0][i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);

 var div = document.createElement('div');
 div.setAttribute('class','keybar');
 var content = '';
 for (var i=0;i<xkeys.length;i++){
  if(xkeys[i]=='backspace'){content += '<div class="key xkey" onclick="keydel()"><div class="backspace"></div></div>'}
  else if(xkeys[i]=='enter'){content += '<div class="key xkey" onclick="key_send()"><div id="keysend" class="enter keyhide"></div></div>'}
  else if(xkeys[i]=='+'||xkeys[i]=='-'){content += '<div class="key xkey" onclick="keyprint(this)">'+xkeys[i]+'</div>'}
  else{content += '<div class="key xkey hkey" onclick="keyprint(this)">'+xkeys[i]+'</div>'}
 }
 div.innerHTML = content;
 e.appendChild(div);

 skeys = document.getElementsByClassName('skey');
 zkeys = document.getElementsByClassName('xkey');
 keysend = document.getElementById('keysend');
}

function bars(){
 document.querySelector(':root').style.setProperty('--pvw',100*JSON.parse(document.getElementById('hp').innerHTML)/JSON.parse(document.getElementById('hpmax').innerHTML)+'%');
 document.querySelector(':root').style.setProperty('--pmw',100*JSON.parse(document.getElementById('mp').innerHTML)/JSON.parse(document.getElementById('mpmax').innerHTML)+'%');
}

function keyshift(e){
 e.classList.toggle('nkey');
 var k = [[0,1],[0,2]]
 var j = focused.id=='dice-input'?0:1;
 for (var i=0;i<skeys.length;i++){skeys[i].innerHTML = keys[k[j][Number(e.classList.contains('nkey'))]][i]}
 if(j&&!Number(e.classList.contains('nkey'))){e.innerHTML='x10'}
}

function max_hp(e){
 data[e.id] = data[e.id+'max'];
 var k = data[e.id] + (e.id.includes('hp')?data.cond['Pontos de Vida']:data.cond['Pontos de Mana']);
 e.innerHTML = k;
 printed_keys=[k];
 bars()
}

var printed_keys = [];
function keyac(){focused.innerHTML = '';printed_keys = [];keysend.classList.add('keyhide')}

function keydel(){
 if(focused.innerHTML&&!printed_keys.length){for (var i=0;i<focused.innerHTML.length;i++){printed_keys.push(focused.innerHTML[i])}}
 if(printed_keys.length>0){
  var size = printed_keys[printed_keys.length-1].length;
  var text = focused.innerHTML;
  text = text.slice(0,text.length-size);
  focused.innerHTML = text;
  printed_keys.splice(printed_keys.length-1,1);
  keysend.classList.remove('keyhide')
 }
 if(!printed_keys.length){keysend.classList.add('keyhide')}
}

function keyprint(e){
 var k = e.innerHTML;
 if(k.includes('max')){
  if(k.includes('PV')){max_hp(document.getElementById('hp'))}
  if(k.includes('PM')){max_hp(document.getElementById('mp'))}
 }else{
  if(focused.innerHTML=='0'&&k!='+'&&k!='-'){focused.innerHTML='';printed_keys=[]} //user is replacing a zero with a number
  focused.innerHTML += k;
  printed_keys.push(k);
  keysend.classList.remove('keyhide');
 }
}

function calc_hp(e){
 var str = [[],[]];j = 0,math = '';
 if(printed_keys[0]=='+'||printed_keys[0]=='-'){printed_keys.unshift(0)}

 for (var i=0;i<printed_keys.length;i++){
  if(printed_keys[i]=='+'||printed_keys[i]=='-'){if(!math){math=printed_keys[i];j=1}else{str[0]=JSON.parse(str[0])+(math=='+'?1:-1)*JSON.parse(str[1]);str[1]=[];math=printed_keys[i]}}
  else{str[j] += printed_keys[i]}
 }
 if(math){str[0]=JSON.parse(str[0])+(math=='+'?1:-1)*JSON.parse(str[1])}

 if(str[0][0]){
  str = JSON.parse(str[0]);
  var bt = e.id.includes('hp')?'Pontos de Vida':'Pontos de Mana';
  if(e.id.includes('max')){
   data[e.id] = str;
   data[e.id.replace('max','')] = (str>data[e.id]+data.cond[bt])?data[e.id]+data.cond[bt]:data[e.id.replace('max','')];
   e.parentNode.children[0].innerHTML = data[e.id.replace('max','')]
  }else{
   data[e.id] = (str>data[e.id+'max']+data.cond[bt])?data[e.id+'max']+data.cond[bt]:str;
  }
  e.innerHTML = data[e.id];
  printed_keys=[data[e.id]];
  bars();
 }
}

function key_send(){
 if(!focused.innerHTML){set_focus(focused);keysend.classList.remove('keyhide')}
 var str = focused.innerHTML;
 if(focused.id=='dice-input'&&str.indexOf('d')<str.length-1){startroll('dice-input');keyac()}
 else if(focused.id!='dice-input'){calc_hp(focused)}
 keysend.classList.add('keyhide');
}

function open_key(){
 keyboard.classList.toggle('boardshow');
 document.getElementById('diceholder').classList.toggle('diceholder');
 document.querySelector(':root').style.setProperty('--drh',data.c_dice?'var(--drb)':'90%');
 document.querySelector(':root').style.setProperty('--hph',(data.c_dice&&keyboard.classList.contains('boardshow'))?'256px':'120px');
 scroll_down('allrolls');
}

function openroller(e){
 e.parentNode.classList.toggle('drew');
 keyboard.classList.remove('boardshow');
 document.querySelector(':root').style.setProperty('--hph','120px');
 document.getElementById('diceholder').classList.remove('diceholder');
 if(focused){focused.classList.remove('fakefocus')}
 focused = null;
}

var focused;
function set_focus(e){
 if(focused){calc_hp(focused);focused.classList.remove('fakefocus')}
 if(focused&&focused!=e){if(focused.id!='dice-input'&&!focused.innerHTML.includes('+')&&!focused.innerHTML.includes('-')){data[focused.id]=JSON.parse(focused.innerHTML)}}
 if(!focused){open_key(e)}
 if(!focused||focused!=e){e.classList.add('fakefocus');focused=e}
 else{focused=undefined;open_key()}
 if(focused){
  printed_keys = [];
  if(focused.innerHTML){for (var i=0;i<focused.innerHTML.length;i++){printed_keys.push(focused.innerHTML[i])}}

  document.getElementById('shiftkey').classList.remove('nkey');
  for (var i=0;i<skeys.length;i++){skeys[i].innerHTML = keys[0][i]}
  document.getElementById('shiftkey').innerHTML = (focused.id=='dice-input'?'dx':'x10');

  for (var i=0;i<ykeys.length;i++){zkeys[i].innerHTML = (!data.c_keyboard||focused.id=='dice-input')?xkeys[i]:ykeys[i]}
  if(focused.innerHTML){keysend.classList.remove('keyhide')}
  else{keysend.classList.add('keyhide')}
 }
}

//-------------------------DEFENSE FUNCTIONS------------------------//

function defense_info(e){document.getElementById(e).classList.toggle('def_hide')}
function def_set(e){e.value==''?data.defense[e.id]=0:(data.defense[e.id]=!isNaN(e.value)?JSON.parse(e.value):e.value)}

function rd_calc(){
 document.getElementById('rd').value = data.defense.rd + data.cond['RD (todas)'];
 for (var i=0;i<rd.length;i++){
  document.getElementById(rd[i]).value = data.defense[rd[i]] + data.cond[rd[i]];
 }
 save_data();
}

function def_calc(){
 document.getElementById('ac').innerHTML = 10+Math.floor(JSON.parse(data.nível)/2)+data.defense.armor_bonus+data.defense.shield_bonus+data.defense.def_out+data['hab_'+habs[data.defense.def_hab]] + (data.defense.def_hab2>0?data['hab_'+habs[data.defense.def_hab2]]:0)+data.cond['Defesa']+data.cond['Armadura (bonus)']+data.cond['Escudo (bonus)'];
 document.getElementById('def_cond').innerHTML = add_plus_sign(data.cond['Defesa']);
 document.getElementById('armor_bonus').value = add_plus_sign(data.defense.armor_bonus + data.cond['Armadura (bonus)']);
 document.getElementById('armor_penal').value = add_plus_sign(data.defense.armor_penal + data.cond['Armadura (penalidade)']);
 document.getElementById('shield_bonus').value = add_plus_sign(data.defense.shield_bonus + data.cond['Escudo (bonus)']);
 document.getElementById('shield_penal').value = add_plus_sign(data.defense.shield_penal + data.cond['Escudo (penalidade)']);
 save_data();
}

function list_rd(){
 for (var i=0;i<rd.length;i++){
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  div.innerHTML = '<div class="w3 m0a dif"><input id="'+rd[i]+'" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this);rd_calc()" autocomplete="off"></div><div class="w6 m0a dif"><p class="p_skill">'+rd[i]+'</p></div></div>';
  document.getElementById('char_rd').appendChild(div);
 }
}

var armor_list = armor_list();
function armor_list(){
 let div = document.createElement('div');
 div.setAttribute('class','dropequip');
 for(var i=armor_start;i<armor_end;i++){div.innerHTML += '<a onclick="armor_choose(this,'+i+')" tabindex="0">'+equip[i][0]+'</a>'}
 return div;
}

function armor_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[2].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode;
 e.children[0].children[0].value = equip[i][0];
 e.children[1].children[0].value = equip[i][11];
 e.children[2].children[0].value = equip[i][12];

 data.defense[e.children[0].children[0].id] = equip[i][0];
 data.defense[e.children[1].children[0].id] = equip[i][11];
 data.defense[e.children[2].children[0].id] = equip[i][12];

 calc();
}

//-------------------------ATTACK FUNCTIONS------------------------//

function weap_roll(e){
 e = e.parentNode.parentNode.parentNode;
 var attacks = document.getElementsByClassName('attack');
 var x = Array.prototype.indexOf.call(attacks,e);

 console.log(e);
 var k = base_split(e.children[0].children[1].children[0].children[1].innerHTML);
 console.log(k);

 print_out('');
 print_out('Ataque'+(k.length>1?'s':'')+' com '+data.attack[x][0]+':');

 e = e.children[0].children[0].children[1].innerHTML;
 for (var i=0;i<k.length;i++){
  if(k.length>1){print_out((i+1)+'º ataque:')}
  diceroll('d20'+(k[i]<0?'':'+')+k[i],data.attack[x][6]);

  var p = 1;
  var c = data.attack[x][6]?data.attack[x][6]:20;
  if(roll[0]>=c){p = data.attack[x][7]?JSON.parse(data.attack[x][7].replace('x','')):2}

  var q = data.attack[x][2].indexOf('d');
  q = q<1?1:JSON.parse(data.attack[x][2].slice(0,q));
  p = p*q;
  diceroll(p+e.slice(e.indexOf('d')).slice(0,e.indexOf(' ')));
 }
 print_out('');print_out('');
 openroller(document.getElementById('drawer'));
}

function attack_calc(){
 var at_skill = document.getElementsByName('at_skill');
 var attacks = document.getElementsByClassName('attack');
 for (var i=0;i<attacks.length;i++){
  attacks[i].children[0].children[0].children[0].innerHTML=data.attack[i][0]?data.attack[i][0]:'Nome do Ataque';
  attacks[i].children[1].children[5].children[0].children[0].innerHTML=add_plus_sign(data.cond.Ataques); //condition attack
  attacks[i].children[1].children[5].children[1].children[0].innerHTML=add_plus_sign(data.cond.Dano); //condition damage

  var k = (data.attack[i][3]?data['hab_'+ habs[data.attack[i][3]]]:0)+data.cond.Dano;

  var o = 0;
  if(isNaN(data.attack[i][5])){
   o = data.attack[i][5][0]=='-'?data.attack[i][5]:'+'+data.attack[i][5];
   o += (k==0?'':(k>0?'+'+k:k));
  }else{
   o = data.attack[i][5] + k;
   o = (o==0?'':(o>0?'+'+o:o));
  }

  attacks[i].children[0].children[0].children[1].innerHTML=(data.attack[i][2]?data.attack[i][2]:'d8')+o+' • '+(data.attack[i][6]&&data.attack[i][6]<20?data.attack[i][6]+'-20':20)+'/'+(data.attack[i][7]?data.attack[i][7]:'x2')+' • '+(data.attack[i][8]>0?alcance[data.attack[i][8]]:'Alcance')+' • '+(data.attack[i][9]>0?tipo_dano[data.attack[i][9]]:'Tipo de dano')+(data.attack[i][13]>1?' • '+action[data.attack[i][13]]+' para regarregar':'');

  var k = 0;
  if(data.attack[i][1]==''){k=[0]}
  else if(isNaN(data.attack[i][1])){k=base_split(data.attack[i][1])}
  else{k=[data.attack[i][1]]}

  for (var j=0;j<k.length;j++){
   k[j]=JSON.parse(k[j])+(data.attack[i][11]?JSON.parse(document.getElementById(skills[data.attack[i][11]][0]+'_total').innerHTML.replace(/[+]/g,'')):0)+(data.attack[i][4]?data.attack[i][4]:0)+data.cond.Ataques;
   k[j]=(k[j]>=0?'+':'')+k[j];
  }
  console.log(attacks[i]);
  attacks[i].children[0].children[1].children[0].children[1].innerHTML=k.join('/');
  let ac = data.attack[i][12]?action[data.attack[i][12]].replace('Ação ','').replace('de ','').toLowerCase():'';
  attacks[i].children[0].children[1].children[1].innerHTML = spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'';
 }
 save_data()
}

function base_split(str){return str.replace(/[+]/g,'').split('/')}

function attack_remove(e){
 e = e.parentNode.parentNode.parentNode;
 var attacks = document.getElementsByClassName('attack');
 var x = Array.prototype.indexOf.call(attacks,e);
 data.attack.splice(x,1);
 e.remove();
}

function attack_data(e,i){
 var attacks = document.getElementsByClassName('attack');
 var x = Array.prototype.indexOf.call(attacks,e.parentNode.parentNode.parentNode.parentNode);
 data.attack[x][i] = e.value==''?0:(isNaN(e.value)?e.value:JSON.parse(e.value.replace('+','')))
 attack_calc();
}

function attack_info(e){e.parentNode.parentNode.children[1].classList.toggle('def_hide')}

var dmg_type = '';
for(var i=0;i<tipo_dano.length;i++){dmg_type += '<option value="'+(i>0?i+'">':'" disabled selected>')+tipo_dano[i]+'</option>'}
var range = '';
for(var i=0;i<alcance.length;i++){range += '<option value="'+(i>0?i+'">':'" disabled selected>')+alcance[i]+'</option>'}
var skill_names = '<option value="" disabled selected>Perícia</option>';
for(var i=0;i<skills.length;i++){skill_names += '<option value="'+i+'">'+skills[i][0]+'</option>'}
var skill_habis = '';
for(var i=0;i<habis.length;i++){skill_habis += '<option value="'+(i>0?i+'">':'" disabled selected>')+habis[i]+'</option>'}

function attack_list(i){
 let div = document.createElement('div');
 div.setAttribute('class','w10 attack');
 div.setAttribute('attack',data.attack.length);

 let content2 = '<div class="w10 dif"><div class="w8 m0a pr dif">';
 content2 +=  '<input class="skill_input m3e" type="text" placeholder="Nome do ataque" value="'+data.attack[i][0]+'" autocomplete="off" onchange="attack_data(this,0)" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,weap_list)">';
 content2 +=  '</div><div class="w2 m0a dif" onclick="attack_remove(this)"><div class="trash"></div></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 m3e dif"><p class="item_subtitle m0a">Ataque</p></div>';
 content2 +=  '<div class="w3 m3e dif"><p class="item_subtitle m0a" style="transform:translateX(-2px)">Dano</p></div>';
 content2 +=  '<div class="w4"></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Modificador" value="'+data.attack[i][1]+'" autocomplete="off" onkeyup="regexb1(this)" onchange="attack_data(this,1)"></div>';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Dado" value="'+data.attack[i][2]+'" autocomplete="off" onkeyup="regexb2(this)" onchange="attack_data(this,2)"></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Base</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,11)" required>'+skill_names+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,3)" required>'+skill_habis+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p name="at_skname" class="p_skill">Perícia e hab.</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="+0" value="'+data.attack[i][4]+'" inputmode="numeric" autocomplete="off" onkeyup="regex(this)" onchange="attack_data(this,4)"></div>';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="+0" value="'+data.attack[i][5]+'" inputmode="numeric" autocomplete="off" onkeyup="regexo(this)" onchange="attack_data(this,5)"></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Outro</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><p class="p_skill tc">+0</p></div>';
 content2 +=  '<div class="w3 ma3 dif"><p class="p_skill tc">+0</p></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Condições</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Margem" value="'+data.attack[i][6]+'" inputmode="numeric" autocomplete="off" onkeyup="regexc1(this)" onchange="attack_data(this,6)"></div>';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Multiplicador" value="'+data.attack[i][7]+'" autocomplete="off" onkeyup="regexc2(this)" onchange="attack_data(this,7)"></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Crítico</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,8)" required>'+range+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,9)" required>'+dmg_type+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Alcance e tipo</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,12)" required>'+actions.replace('para ativar','para atacar')+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,13)" required>'+actions.replace('para ativar','para recarregar')+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Ação</p></div></div>';

 content2 +=  '<div class="w10 dif"><div class="w10 m3e dif">';
 content2 +=  '<textarea class="skill_input m3e" type="text" placeholder="Poderes aplicados, melhoramentos de arma e outros detalhes" autocomplete="off" onchange="attack_data(this,10)">'+data.attack[i][10]+'</textarea>';
 content2 +=  '</div></div></div>';

 let content = '<div class="w10 dif">';
 content += '<div class="w7 ma" onclick="attack_info(this)"><p class="item_title">Nome do Ataque</p><p class="item_subtitle"></p></div>';
 content += '<div class="w3 dfw">';
 content += '<div class="w5at dif" onclick="weap_roll(this)"><div class="dice dif">'+dices['d20']+'</div><p class="w5 item_title"></p></div>';
 content += '<div class="w5at"></div>';
 content += '</div>';


 content += '</div><div class="w10 attack_info def_hide">'+content2+'</div>';

 div.innerHTML = content;
 div.children[1].children[3].children[0].children[0].value=data.attack[i][11];
 div.children[1].children[3].children[1].children[0].value=data.attack[i][3];
 div.children[1].children[7].children[0].children[0].value=data.attack[i][8];
 div.children[1].children[7].children[1].children[0].value=data.attack[i][9];
 if(data.attack[i][12]){div.children[1].children[8].children[0].children[0].value=data.attack[i][12]}
 if(data.attack[i][13]){div.children[1].children[8].children[1].children[0].value=data.attack[i][13]}
 document.getElementById('char_attack').appendChild(div);
 attack_calc();
}

function attack_add(){
 if(data.attack.length){data.attack.push(['','','','','','','','','','','','',0,0])} //['','','','','','','','','','','','',,]
 else{data.attack.push(['Disparo Rápido • Arco Longo (exemplo)','-2/-2','d8',2,0,0,20,'x3',2,2,'As seguintes habilidades estão aplicadas nesse ataque:\n• Estilo de Disparo: +des no dano\n• Disparo Rápido: dois ataques -2/-2, ação completa',23,5,2])}
 attack_list(data.attack.length-1)
}

var weap_list = weap_list();
function weap_list(){
 let div = document.createElement('div');
 div.setAttribute('class','dropequip');
 for(var i=weap_start;i<weap_end;i++){div.innerHTML += '<a onclick="weap_choose(this,'+i+')" tabindex="0">'+equip[i][0]+'</a>'}
 return div;
}

function weap_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e.children[0].value = equip[i][0];
 e = e.parentNode.parentNode;
 e.children[2].children[0].children[0].value = equip[i][5];
 e.children[2].children[1].children[0].value = equip[i][6];
 e.children[3].children[0].children[0].value = '';
 e.children[3].children[1].children[0].value = '';
 e.children[6].children[0].children[0].value = equip[i][7];
 e.children[6].children[1].children[0].value = equip[i][8];
 e.children[7].children[0].children[0].value = equip[i][9];
 e.children[7].children[1].children[0].value = equip[i][10];
 e.children[8].children[0].children[0].value = '';
 e.children[8].children[1].children[0].value = '';
 e.children[9].children[0].children[0].innerHTML = '';

 e = e.parentNode;
 var attacks = document.getElementsByClassName('attack');
 let x = Array.prototype.indexOf.call(attacks,e);

 data.attack[x][0] = equip[i][0];
 data.attack[x][1] = equip[i][5];
 data.attack[x][2] = equip[i][6];
 data.attack[x].splice(6,4,equip[i][7],equip[i][8],equip[i][9],equip[i][10]);

 attack_calc();
}

//-------------------------SKILLS FUNCTIONS------------------------//

function skill_info(e){e.parentNode.parentNode.parentNode.children[1].classList.toggle('skill_hide')}

function train2(i,k){
 var t = data.nível;
 t = t<7?2:t<14?4:6;
 document.getElementById(data[k][i][0]+'_train').innerHTML = '+'+data[k][i][4] * t;
}

function train(e,i,k){
 data[k][i][4] = +!data[k][i][4];
 if(data[k][i][4]){e.children[0].classList.add('markedbox')}
 if(!data[k][i][4]){e.children[0].classList.remove('markedbox')}
 e = e.parentNode.parentNode.parentNode.id;
 calc_skills(k);
}

function skill_outro(e,k){
 if(e.value.indexOf('+')>-1){e.value=e.value.slice(1)}
 data[k][e.getAttribute('skill')][5]=JSON.parse(e.value);
 e.value = add_plus_sign(e.value);
}

var skill_habs = '<option disabled selected></option>';
for(var i=1;i<habs.length;i++){skill_habs += '<option value="'+i+'">'+habs[i]+'</option>'}

function skill_hab(e,k){data[k][e.getAttribute('skill')][e.getAttribute('index')]=JSON.parse(e.value)}

function list_skills(e,i,k){ //k='skills' or 'crafts'
for (var i=0;i<e.length;i++){
 var div = document.createElement('div');
 div.setAttribute('id',e[i][0]);
 div.setAttribute('index',i);
 div.setAttribute('class','row');

 var content2 = '<div class="row"><div class="skills attack_info mw400">';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><select id="'+e[i][0]+'_hab" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="1">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Habilidade</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><select id="'+e[i][0]+'_hab2" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="2">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Hab secundária</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p class="p_skill tac skill_lvl">+0</p></div><div class="w5 m0a dif"><p class="p_skill">1/2 do nível</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_train" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="4">Treinamento</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><input id="'+e[i][0]+'_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="skill_outro(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="5" autocomplete="off"></input></div><div class="w5 m0a dif"><p class="p_skill">Outro</p></div></div>';

 content2 += '<div class="w10 dif">';
 if(e[i][6]){content2 += '<div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_penal" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="6">Penalidade</p></div>'}
 content2 += '</div>';

 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_cond" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill">Condições</p></div></div>';
 content2 += '</div></div>';

 var content = '<div class="row"><div class="container skills">';
 content += '<div class="w2 dif" onclick="train(this,'+i+',\''+k+'\')"><div class="checkbox"></div></div>';
 content += '<div class="w5 dif" onclick="skill_info(this)"><p class="item_title">'+e[i][0];
 content += e[i][3]?'*':'';
 content += e[i][6]?'‡':'';
 content += '</p></div>';
 content += '<div class="w2 dif" onclick="startroll(\''+e[i][0]+'_total\')"><div class="dice dif" data-dice="d20"></div></div>';
 content += '<div class="w1 dif" onclick="startroll(\''+e[i][0]+'_total\')"><p id="'+e[i][0]+'_total" class="item_title skill_tot">+0</p></div>';
 content += '</div></div><div class="skill_info skill_hide">'+content2+'</div>';
 div.innerHTML = content;
 document.getElementById('char_'+k).appendChild(div);

 div.children[1].children[0].children[0].children[0].children[0].children[0].value = data[k][i][1];
}}

const skill_lvl = document.getElementsByClassName('skill_lvl');
function calc_skills(k){
 for(var i=0;i<skill_lvl.length;i++){skill_lvl[i].innerHTML = '+'+Math.floor(JSON.parse(data.nível)/2)}
 for(var i=0;i<data[k].length;i++){
  var e = document.getElementById(data[k][i][0]).children[0].children[0];
  if(data[k][i][3]&&!data[k][i][4]){e.children[2].classList.add('dn');e.children[3].classList.add('dn')}
  else{e.children[2].classList.remove('dn');e.children[3].classList.remove('dn')}
  var total = data['hab_'+habs[data[k][i][1]]] + (data[k][i][2]>0?data['hab_'+habs[data[k][i][2]]]:0) + Math.floor(data.nível/2) + JSON.parse(data[k][i][4])*(data.nível<7?2:data.nível<14?4:6) + JSON.parse(data[k][i][5]) + JSON.parse(data[k][i][6])*(data.defense.armor_penal + data.defense.shield_penal)+data.cond['Perícias (todas)']+data.cond[data[k][i][0]] + data.cond['Armadura (penalidade)'] + data.cond['Escudo (penalidade)'];
  document.getElementById(data[k][i][0]+'_total').innerHTML = add_plus_sign(total);
  e = e.children[0].children[0];
  if(data[k][i][4]&&!e.classList.contains('markedbox')){e.classList.add('markedbox')}
  train2(i,k);
  document.getElementById(data[k][i][0]+"_hab").value = data[k][i][1];
  document.getElementById(data[k][i][0]+"_hab2").value = data[k][i][2];
  document.getElementById(data[k][i][0]+"_out").value = add_plus_sign(data[k][i][5]);
  document.getElementById(data[k][i][0]+"_cond").innerHTML = add_plus_sign(data.cond['Perícias (todas)']+data.cond[data[k][i][0]]);
  if(data[k][i][6]){document.getElementById(data[k][i][0]+"_penal").innerHTML = add_plus_sign(data.defense.armor_penal + data.defense.shield_penal + data.cond['Armadura (penalidade)'] + data.cond['Escudo (penalidade)'])}
 }
 attack_calc();
}

//-------------------------CONDITIONS FUNCTIONS------------------------//

function cond_info(e,array){
 let j = e.classList.contains('cond_user')?1:0;
 let conds = j?'cond_user':'conditions';
 conds = document.getElementsByClassName(conds);
 let i = Array.prototype.indexOf.call(conds,e);
 cond_details(e,j,i,array,1);
}

function cond_details(e,j,i,array,k){
 var q = JSON.stringify(array[i][3]).length>2?'<b>Efeitos:</b> ':'';
 for (var key in array[i][3]){if(key!='Deslocamento'){q += key+' '+(array[i][3][key]>0?'+':'')+array[i][3][key]+' • '}}

 e.children[0].innerHTML = array[i][0];
 let p = [];
 if(array[i][1]){p.push(array[i][1])}
 if(array[i][4]){p.push(array[i][4]+' PM')}
 if(array[i][5]>1){p.push(action[array[i][5]])}
 if(array[i][6]){p.push(duration[array[i][6]])}
 e.children[1].innerHTML = p.join(' • ');
 e.children[2].innerHTML = (data.conditions[j][i]||!k)?array[i][2]:(e.children[2].innerHTML?'':array[i][2]);
 e.children[3].innerHTML = (data.conditions[j][i]||!k)?q.slice(0,-3):(e.children[3].innerHTML?'':q.slice(0,-3));

 if(j&&k){
  if(data.conditions[j][i]){e.parentNode.children[2].classList.remove('hid')}
  else{e.parentNode.children[2].classList.toggle('hid')}
  e = e.parentNode.parentNode.children[1].children[0];
  if(!e.classList.contains('def_hide')){e.classList.add('def_hide')}
 }
}

function cond_change(e,k){
 let value = isNaN(e.value)?e.value:JSON.parse(e.value);
 e = e.parentNode.parentNode.parentNode.parentNode.parentNode.children[0].children[1];

 let conds = document.getElementsByClassName('cond_user');
 let i = Array.prototype.indexOf.call(conds,e);
 data.cond_user[i][k]=value;
 cond_details(e,1,i,data.cond_user,0);
}

function cond_edit(e){e.parentNode.parentNode.children[1].children[0].classList.toggle('def_hide')}

function toggle_condition(e,array){
 const desloc = document.getElementById('deslocamento').parentNode.children[3];
 e.classList.toggle('condmarked');

 e = e.parentNode.children[1];
 let j = e.classList.contains('cond_user')?1:0;
 let conds = j?'cond_user':'conditions';
 conds = document.getElementsByClassName(conds);
 let i = Array.prototype.indexOf.call(conds,e);

 data.conditions[j][i] =! data.conditions[j][i];
 for (var key in array[i][3]){
  if(key=='Deslocamento'){
   if(data.conditions[j][i]){data.cond[key].push(array[i][3][key])}
   else{data.cond[key].splice(data.cond[key].indexOf(array[i][3][key]),1)}
   if(data.cond[key].length){desloc.innerHTML = '*'+data.cond[key][0].charAt(0).toUpperCase() + data.cond[key].join(', ').slice(1)}
   else{desloc.innerHTML = ''}
  }
  else{data.cond[key] += array[i][3][key]*(data.conditions[j][i]?1:-1)}
  if(key=='Tamanho'){document.getElementById('tamanho').value = JSON.parse(data.tamanho) + data.cond[key]}
  if(key=='Pontos de Vida'||key=='Pontos de Mana'){
   var k = key=='Pontos de Vida'?'hp':'mp';
   data[k] = data.conditions[j][i]?data[k]+array[i][3][key]:(data[k]>data[k+'max']+data.cond[key]?data[k+'max']+data.cond[key]:data[k]);
   document.getElementById(k).innerHTML = data[k];
  }
 }
 cond_info(e,array);
 calc_hab();
 calc();
}

var actions = '';
for(let i in action){actions += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+action[i]+'</option>'}

var durations = '';
for(let i in duration){durations += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+duration[i]+'</option>'}

var effects = '';
for(let key in cond){effects += '<option value="'+(cond[key]=='disabled'?'" disabled':key+'"')+(key=='Selecione um efeito'?' selected':'')+'>'+key+'</option>'}

function list_conditions(e,i,array){
 j = e=='cond_user'?'data.cond_user':'conditions';

 var div = document.createElement('div');
 div.setAttribute('class','w10 pr ma db');

 var content = '<div class="w10 dif">';
 content += '<div class="w1 condmark" onclick="toggle_condition(this,'+j+')"></div>';
 content += '<div class="w8 '+e+'" onclick="cond_info(this,'+j+')"><p class="item_title">'+array[i][0]+(array[i][1]&&e!='cond_user'?' • '+array[i][1]:'')+'</p>';

 let p = [];
 if(array[i][1]&&e=='cond_user'){p.push(array[i][1])}
 if(array[i][4]){p.push(array[i][4]+' PM')}
 if(array[i][5]>1){p.push(action[array[i][5]])}
 if(array[i][6]){p.push(duration[array[i][6]])}

 content += '<p class="item_subtitle">'+p.join(' • ')+'</p>';
 content += '<p class="item_subtitle"></p><p class="item_subtitle"></p></div>';
 if(e=='cond_user'){
  content += '<div class="w1 ma hid" onclick="cond_edit(this)"><div class="pencilbox ma"><div class="pencil"></div></div></div></div>';
  content += '<div class="w10">';
  content += '<div class="w10 attack_info def_hide cond_info"><div class="w10 dif">';
  content += '<div class="w8 ma dif"><input class="skill_input m3e" type="text" placeholder="Nome da condição" value="'+(array[i][0]=="Nome da Condição"?'':array[i][0])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="cond_change(this,0)"></div>';
  content += '<div class="w2 ma dif" onclick="cond_remove(this)"><div class="trash"></div></div>';
  content += '</div><div class="w10 dif">';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Tipo de condição" value="'+(array[i][1]=="Tipo de Condição"?'':array[i][1])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="cond_change(this,1)"></div>';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="cond_change(this,5)" required>'+actions+'</select></div>';
  content += '</div><div class="w10 dif">';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="Number" placeholder="Custo em PM" value="'+(array[i][4]=="Custo em"?'':array[i][4])+'" autocomplete="off" onkeyup="regexqte(this)" onchange="cond_change(this,4)"></div>';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="cond_change(this,6)" required>'+durations+'</select></div>';
  content += '</div>';
  content += '<div><div class="w10 m3e dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="cond_change(this,2)">'+(array[i][2]=="Descrição e detalhes"?'':array[i][2])+'</textarea></div></div>';

  content += '<div class="w10 mt tac"><div class="effect_add" onclick="effect_add(this)">+ Adicionar</div><p class="item_title">Efeitos nesta condição:</p></div><div>';
  for(let key in array[i][3]){
   content += '<div class="w10 dif">';
   content += '<div class="w4 m3e"><select class="skill_input m3e" onchange="effect_change(this)" required>'+effects+'</select></div>';
   content += '<div class="w4 m3e"><input class="skill_input m3e" placeholder="Modificador" autocomplete="off" onkeyup="regexb1(this)" onchange="effect_change(this)"></div>';
   content += '<div class="w2 ma dif" onclick="effect_remove(this)"><div class="trash"></div></div>';
   content += '</div>';
  }
  content += '</div></div></div>';
 }
 div.innerHTML = content;
 document.getElementById(e).appendChild(div);

 if(e=='cond_user'){
  e = div.children[1].children[0];
  if(array[i][5]){e.children[1].children[1].children[0].value = array[i][5]}
  if(array[i][6]){e.children[2].children[1].children[0].value = array[i][6]}
  e = e.children[5];
  var j = 0;
  for(let key in array[i][3]){
   e.children[j].children[0].children[0].value = key;
   e.children[j].children[1].children[0].value = array[i][3][key];
   j++;
 }}
}

function cond_create(){
 if(data.cond_user.length){data.cond_user.push(['Nome da Condição','Tipo de Condição','Descrição e detalhes',{},'Custo em',0,0])}
 else{data.cond_user.push(['Forma Selvagem Feroz (exemplo)','Druída','Você pode adquirir a forma de uma criatura selvagem. Você recebe Força +3, +2 na Defesa e uma arma natural que causa 1d8 pontos de dano.',{Força:3,Defesa:2},3,4,7])}
 list_conditions('cond_user',data.cond_user.length-1,data.cond_user)
}

function cond_remove(e){
 e = e.parentNode.parentNode.parentNode.parentNode.children[0].children[1];
 let conds = document.getElementsByClassName('cond_user');
 j = Array.prototype.indexOf.call(conds,e);
 if(data.conditions[1][j]){toggle_condition(e,data.cond_user)}
 data.cond_user.splice(j,1);
 e.parentNode.parentNode.remove();
}

function effect_add(e){
 var div = document.createElement('div');
 div.setAttribute('class','w10 dif');

 content = '<div class="w4 m3e"><select class="skill_input m3e" onchange="effect_change(this)" required>'+effects+'</select></div>';
 content += '<div class="w4 m3e"><input class="skill_input m3e" type="number" placeholder="Modificador" autocomplete="off" onkeyup="regexb1(this)" onchange="effect_change(this)"></div>';
 content += '<div class="w2 ma dif" onclick="effect_remove(this)"><div class="trash"></div></div>';

 div.innerHTML = content;
 e.parentNode.parentNode.children[5].appendChild(div);
}

function effect_change(e){
 e = e.parentNode.parentNode.parentNode;
 let i = e.parentNode.parentNode.parentNode.children[0].children[1];
 i = Array.prototype.indexOf.call(document.getElementsByClassName('cond_user'),i);

 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] -= data.cond_user[i][3][key]}} //remove effects from active list
 data.cond_user[i][3] = {}; //clear effects from array
 let selects = e.getElementsByTagName('select');
 for(let k=0;k<selects.length;k++){ //readd effects to array
  let value = selects[k].parentNode.parentNode.children[1].children[0];
  if(selects[k].value=='Deslocamento'){
   value.setAttribute('onkeyup','regex_inj(this)');
   value.setAttribute('type','text');
   value = value.value;
  }else{
   value.setAttribute('onkeyup','regexb1(this)');
   if(isNaN(value.value)){value.value=''}
   value.setAttribute('type','number');
   value = value.value.replace('+','');
  }
  if(value){data.cond_user[i][3][selects[k].value] = isNaN(value)?value:JSON.parse(value)}
 }
 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] += data.cond_user[i][3][key]}calc_hab();calc()} //readd effects to active list
 cond_details(e.parentNode.parentNode.parentNode.children[0].children[1],1,i,data.cond_user,0);
}

function effect_remove(e){
 e = e.parentNode;
 let key = e.children[0].children[0].value;
 let i = e.parentNode.parentNode.parentNode.parentNode.children[0].children[1];
 i = Array.prototype.indexOf.call(document.getElementsByClassName('cond_user'),i);

 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] -= data.cond_user[i][3][key]}} //remove effects from active list
 delete data.cond_user[i][3][key];
 let el = e.parentNode;
 e.remove();
 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] += data.cond_user[i][3][key]}calc_hab();calc()} //readd effects to active list
 cond_details(el.parentNode.parentNode.parentNode.children[0].children[1],1,i,data.cond_user,0);
}

//-------------------------EQUIP FUNCTIONS------------------------//

var peso = '<option value="" disabled selected>Espaço por unidade</option>';
for(var i=1;i<peso_item.length;i++){
 var str = i>1?((i<5?' de':'') + ' espaço' + (i>5?'s':'')):'';
 peso += '<option value="'+i+'">'+peso_item[i]+str+'</option>'
}

var tipo = '<option value="" disabled selected>Tipo de item</option>';
for(var i=1;i<tipo_item.length;i++){tipo += '<option value="'+i+'">'+tipo_item[i]+'</option>'}

var carga = 0;

function coins(e){
 data.carga[e.id]=JSON.parse(e.value);
 equip_calc();
}

function calc_cap_carga(){
 data.carga.carga_cap = 10 + (data.hab_for>0?2:1)*data.hab_for + (data.equip.flat().includes('Mochila de Aventureiro')?2:0) + (data.equip.flat().includes('Alforge')?10:0);
 document.getElementById('carga_cap').value = data.carga.carga_cap;
}

function calc_peso(qte,w,x){
 let p = peso_item[w];
 if(w==1){p='Não ocupa espaço'}
 if(w==2){p=1/8}
 if(w==3){p=1/4}
 if(w==4){p=1/2}
 
 var result = 'Espaços totais ocupados';
 if(!isNaN(qte*p)){result = qte*p+' espaço'+(qte*p>1?'s':'');data.equip[x][6]=qte*p}
 else{result = p;data.equip[x][6]=0}
 return result;
}

function equip_calc(){
 carga = 0;
 var equips = document.getElementsByClassName('equip');
 for(var i=0;i<data.equip.length;i++){
  e = equips[i].children[0];
  e.children[0].children[0].innerHTML = data.equip[i][1]?data.equip[i][1]:'Nome do item';
  e.children[0].children[1].innerHTML = (data.equip[i][2]?tipo_item[data.equip[i][2]]:'Tipo de item')+' • '+(data.equip[i][3]?data.equip[i][3]:'Valor do item')+' • '+calc_peso(data.equip[i][0],data.equip[i][4],i);
  carga += isNaN(data.equip[i][6])?0:data.equip[i][6];
 }
 carga += (data.carga.to + data.carga.ts + data.carga.tc)/1000;
 data.carga.carga = carga;
 document.getElementById('carga').innerHTML = carga;
 document.getElementById('to').value = data.carga.to;
 document.getElementById('ts').value = data.carga.ts;
 document.getElementById('tc').value = data.carga.tc;

 calc_cap_carga();

 let sobrecarga = document.getElementById('conditions').children[31].children[0].children[0];
 if(data.carga.carga>data.carga.carga_cap){
  document.getElementById('carga').classList.add('overloaded');
  if(!data.conditions[0][31]){toggle_condition(sobrecarga,conditions)}  //activate condition 31
 }else{
  document.getElementById('carga').classList.remove('overloaded');
  if(data.conditions[0][31]){toggle_condition(sobrecarga,conditions)}  //deactivate condition 31
 }

 if(data.carga.carga>2*data.carga.carga_cap){document.getElementById('equip_add').disabled = true}
 else{document.getElementById('equip_add').disabled = false}

 save_data()
}

function equip_data(e,i){
 var el = e.parentNode.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,el);
 data.equip[x][i]=(e.value==''?'':(!isNaN(e.value)?JSON.parse(e.value):e.value));
 equip_calc();
}

function qte_change(e,v,k){
 var el = e.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,el);

 el = el.children[0].children[1].children[2].children[0];
 v += ((el.value==''||el.value==null)?0:JSON.parse(el.value));
 if(v==0&&k){e.classList.add('dn');e.parentNode.children[0].classList.remove('dn')}
 else{e.parentNode.children[1].classList.remove('dn');e.parentNode.children[0].classList.add('dn')}
 data.equip[x][0]=v;
 el.value = v;
 equip_calc();
}

function equip_remov(e){
 e = e.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,e);
 e.remove();
 data.equip.splice(x,1);
 equip_calc();
}

function equip_add(qte,title,type,cost,weight,desc){
 var div = document.createElement('div');
 div.setAttribute('class','w10 equip');

 var content = '<div class="w10 dif">';
 content += '<div class="w7 ma" onclick="attack_info(this)"><p class="item_title">Nome do item</p><p class="item_subtitle">Tipo de item • Valor do item • Espaços totais ocupados</p></div>';
 content += '<div class="w3 equip_btns dif"><div class="third fakebtn equip_btn df m0 dn" onclick="equip_remov(this)"><div class="trash" style="transform:translateY(2px)"></div></div><button class="third equip_btn m0" onclick="qte_change(this,-1,1)">-</button><div class="third equip_btn mwu df"><input class="skill_input mwu tc" type="number" placeholder="Un." value="'+qte+'" autocomplete="off" onkeyup="regexqte(this)" onchange="equip_data(this,0)"></div><button class="third equip_btn m0" onclick="qte_change(this,1,0)">+</button></div>';
 content += '</div><div class="w10 attack_info def_hide">';
 content += '<div class="w10 dif">';
 content += '<div class="w7 ma pr df"><input class="skill_input m3e" type="text" placeholder="Nome do item" value="'+title+'" autocomplete="off" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,equip_list)" onchange="equip_data(this,1)"></div>';
 content += '<div class="w3 ma df"><input class="skill_input m3e" type="text" placeholder="Valor do item" value="'+cost+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="equip_data(this,3)"></div>';
 content += '</div>';
 content += '<div class="w10 dif">';
 content += '<div class="w5 ma df"><select class="skill_input m3e" autocomplete="off" onchange="equip_data(this,2)" required>'+tipo+'</select></div>';
 content += '<div class="w5 ma df"><select class="skill_input m3e" autocomplete="off" onchange="equip_data(this,4)" required>'+peso+'</select></div>';
 content += '</div>';
 content += '<div><div class="w10 dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="equip_data(this,5)">'+desc+'</textarea></div></div>';
 content += '</div>';

 div.innerHTML = content;
 document.getElementById('char_equip').appendChild(div);
 if(title==''){data.equip.push([qte,,,,,,])}
 else{
  div.children[1].children[1].children[0].children[0].value=type;
  div.children[1].children[1].children[1].children[0].value=weight
 }
}

function equip_kit(){
 for(var i=0;i<kit.length;i++){
  data.equip.push(equip[kit[i]].slice(0,5));
  data.equip[i].unshift(1);
  equip_add(1,data.equip[i][1],data.equip[i][2],data.equip[i][3],data.equip[i][4],data.equip[i][5]);
  equip_calc()
 }
}

var equip_list = equip_list();
function equip_list(){
 let div = document.createElement('div');
 div.setAttribute('class','dropequip');
 for(var i=0;i<equip.length;i++){div.innerHTML += '<a onclick="equip_choose(this,'+i+')" tabindex="0">'+equip[i][0]+'</a>'}
 return div;
}

function equip_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode.parentNode;
 e.children[0].children[0].children[0].value = equip[i][0];
 e.children[0].children[1].children[0].value = equip[i][2];
 e.children[1].children[0].children[0].value = equip[i][1];
 e.children[1].children[1].children[0].value = equip[i][3];
 e.children[2].children[0].children[0].innerHTML = equip[i][4];

 e = e.parentNode;
 let equips = document.getElementsByClassName('equip');
 let x = Array.prototype.indexOf.call(equips,e);
 
 data.equip[x] = equip[i].slice(0,5);
 data.equip[x].unshift(JSON.parse(e.children[0].children[1].children[2].children[0].value));

 equip_calc();
}

//-------------------------LISTS FUNCTIONS------------------------//

var prev_focus;
function list_move(e,ev,list){
 if(prev_focus!=e){
  prev_focus=e;
  e.parentNode.appendChild(list);
  let a = e.parentNode.children[1].getElementsByTagName("a");
  for(var i=0;i<a.length;i++){a[i].style.display=""}
  if(e.value){filter(e)}
 }
}

function list_remove(e,ev){
 let k = (e.id=="armor"||e.id=="shield")?2:1;
 e = e.parentNode.children[k];
 if(!ev.target.parentNode.contains(ev.relatedTarget)&&e){e.remove()}
 prev_focus = null;
}

//-------------------------CALCULATION FUNCTIONS------------------------//

function add_plus_sign(v){v=v<0?v:'+'+v;return v}
function calc_hab(){
 const hab = document.getElementsByClassName('hab');
 for (let i=0;i<hab.length;i++){
  var value = Math.floor((hab[i].value-10)/2);
  var e = hab[i].parentNode.parentNode.parentNode.children[3].children[0];
  value = value + data.cond[habis[habs.indexOf(e.id.substring(4).toLowerCase())]];
  e.innerHTML = add_plus_sign(value);
  data[e.id] = JSON.parse(value);
 }
 calc();
}
function calc_spell_res(){
 var value = 10 + Math.floor(JSON.parse(data.nível)/2) + JSON.parse(data['hab_'+habs[data.spell_hab]]) + data.cond['CD Magias'];
 document.getElementById('spell_res').innerHTML = value;
 data.spell_res=value;
 save_data()
}
function calc(){def_calc();rd_calc();calc_skills('skills');calc_skills('crafts');calc_spell_res();calc_cap_carga();save_data()}

//-------------------------USER DEFINED POWERS FUNCTIONS------------------------//

function user_power(){
 data.user_powers.push(['Nome do poder',0,'',0,'',0,0,'Descrição e detalhes'])
 list_powers('user_powers',data.user_powers.length-1,data.user_powers);
}

function edit_power(e){
 event.stopPropagation();
 e = e.parentNode.parentNode;
 if(!e.children[1].innerHTML){power_info(e,'user_powers',data.user_powers)}
 e = e.parentNode.children[1].children[0];
 e.classList.toggle('def_hide');
}

function change_power(e,i){
 let value = e.value;
 e = e.parentNode.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_powers').getElementsByClassName('user_powers'),e)
 data.user_powers[x][i] = value;
 calc_power(e,x)
}

function power_magic(e){
 e.classList.toggle('checkmarked');
 e = e.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_powers').getElementsByClassName('user_powers'),e)
 data.user_powers[x][5] = !data.user_powers[x][5];
 calc_power(e,x)
}

function calc_power(e,i){
 e.children[0].children[0].children[0].children[0].innerHTML = data.user_powers[i][0];
 e.children[0].children[0].children[0].children[1].innerHTML = data.user_powers[i][5]?magic:'';

 let p = [];
 p.push(power_typ[data.user_powers[i][1]])
 if(data.user_powers[i][2]){p.push(data.user_powers[i][2])}
 if(data.user_powers[i][4]){p.push(data.user_powers[i][4])}

 e.children[0].children[0].children[0].children[2].innerHTML = p.join(' • ');
 let ac = data.user_powers[i][3]?action[data.user_powers[i][3]].replace('Ação ','').replace('de ','').toLowerCase():'';
 e.children[0].children[0].children[1].innerHTML = spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'';
 e.children[0].children[1].children[0].innerHTML = data.user_powers[i][7];
}

var power_types = '';
for(let i in power_typ){power_types += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+power_typ[i]+'</option>'}

//-------------------------POWERS FUNCTIONS------------------------//

data.powers = [];
var powers_viz = [];

function list_powers(e,i,arr){
 var div = document.createElement('div');
 document.getElementById(e).appendChild(div);
 e = e.replace('all_','');
 let k = (e=='user_powers'?'data.':'')+e;
 div.setAttribute('class',e+' w10');

 let p = [];
 p.push(power_typ[arr[i][1]]);
 if(arr[i][2]){p.push(arr[i][2])}else{p.push('Categoria')}
 if(arr[i][4]){p.push(arr[i][4])}else{p.push('Subategoria')}

 let content = '<div class="spell_details" onclick="power_info(this,\''+e+'\','+k+')"><div class="w10 dif"><div class="w'+(e=='user_powers'?8:9)+'">';
 content += '<p class="item_title">'+arr[i][0]+'</p><div class="magic">'+(arr[i][5]?magic:'')+'</div>';
 content += '<p class="item_subtitle">'+p.join(' • ')+'</p>';
 content += arr[i][8]?'<p class="item_subtitle"><b>Pré-requisito:</b> '+arr[i][8]+'</p>':'';
 content += '</div>';
 let ac = arr[i][3]?action[arr[i][3]].replace('Ação ','').replace('de ','').toLowerCase():'';
 content += '<div class="item_action w1 ma">'+(spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'')+'</div>';
 content += e=='user_powers'?'<div class="w1 ma powe" onclick="edit_power(this)"><div class="pencilbox ma"><div class="pencil"></div></div></div>':'';
 content += '</div><div class="item_subtitle w10 pr ms"></div></div>';

 if(!e.includes('user')){div.setAttribute('index',i);powers_viz.push([1,1,1])}
 else{
  content += '<div class="w10 mt1"><div class="w10 attack_info cond_info def_hide">';
  content += '<div class="w10 dif">';
  content += '<div class="w8 ma dif"><input class="skill_input m3e" type="text" placeholder="Nome do poder" value="'+(arr[i][0]=='Nome do poder'?'':arr[i][0])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_power(this,0)"></div>';
  content += '<div class="w2 ma dif" onclick="remove_power(this,\''+e+'\')"><div class="trash"></div></div>'
  content += '</div>';

  content += '<div class="w10 dif">';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_power(this,1)" required>'+power_types+'</select></div>';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Categoria" value="'+(arr[i][2]=='Categoria'?'':arr[i][2])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_power(this,2)"></div>';
  content += '</div>';

  content += '<div class="w10 dif">';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_power(this,3)" required>'+actions+'</select></div>';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Subcategoria" value="'+(arr[i][4]=='Subcategoria'?'':arr[i][4])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_power(this,4)"></div>';
  content += '</div>';

  content += '<div><div class="w10 dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="change_power(this,7)">'+(arr[i][7]=='Descrição e detalhes'?'':arr[i][7])+'</textarea></div></div>';
  content += '<div class="w10 dif pr"><a class="checkmark a_power" onclick="power_magic(this)">Marque se essa habilidade for mágica</a></div>';

  content += '</div></div>';
 }
 div.innerHTML = content;

 if(e.includes('user')&&arr[i][0]!='Nome do poder'){
  if(arr[i][1]){div.children[1].children[0].children[1].children[0].children[0].value = arr[i][1]}
  if(arr[i][3]){div.children[1].children[0].children[2].children[0].children[0].value = arr[i][3]}
  if(arr[i][5]){div.children[1].children[0].children[4].children[0].classList.add('checkmarked')}
 }
}

function power_info(e,id,arr){
 e = e.parentNode;
 let k = id=='user_powers'?0:1;
 let i = k?e.getAttribute('index'):Array.prototype.indexOf.call(document.getElementById(id).getElementsByClassName(id),e);

 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(e.innerHTML){
  e.innerHTML = '';
  if(!k){e.parentNode.parentNode.children[1].children[0].classList.add('def_hide')}
 } else {
  var content = '<p class="nowrap">'+arr[i][7]+'</p>';
  if(k){
   content += '<p class="nowrap"><i>Publicação:</i> '+arr[i][6]+'</p><button class="spell_add" onclick="add_power(this)">Adicionar poder</button>';
   content += '<button class="delete spell_delete" onclick="remove_power(this,\''+id+'\')">Remover poder</button>';
  }
  e.innerHTML = content
 }
}

function add_power(e){
 e = e.parentNode.parentNode.parentNode.cloneNode(true);
 e.classList.remove('more_info');
 e.children[0].children[1].innerHTML = '';
 document.getElementById('powers').appendChild(e);
 data.powers.push(JSON.parse(e.getAttribute('index')));
}

function remove_power(e,id){
 e = e.parentNode.parentNode.parentNode;
 if(id=='user_powers'){e = e.parentNode}
 let pows = document.getElementById(id).getElementsByClassName(id);
 let x = Array.prototype.indexOf.call(pows,e);
 data[id].splice(x,1);
 e.remove();
}

function filter_powers(){
 let e = document.getElementById('all_powers').getElementsByClassName('powers');
 for (var i=0;i<powers.length;i++){
  if(powers_viz[i][0]&&powers_viz[i][1]&&powers_viz[i][2]){e[i].style.display=""}
  else{e[i].style.display="none"}
 }
}



function filter_powers_other(e){
 let k = e.getAttribute('tabindex');
 let filter;

  if(k==1){
   filter = e.innerHTML.split(', ');
   for(let i in filter){filter[i]=power_typ.indexOf(filter[i])}
  }else{
   filter = e.innerHTML;
  }

 if(!filter||filter[0]<0){filter=[1,2,3,4,5]+JSON.stringify(power_cat)}

 for (var i=0;i<powers.length;i++){
  if(filter.indexOf(powers[i][k])>-1){powers_viz[i][k]=1}
  else{powers_viz[i][k]=0}
 }
 filter_powers();
}

// if(!e.innerHTML){filter=[1,2,3,4,5]}
// if(!filter){filter=JSON.stringify(power_inputs[k-1])}

function filter_powers_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<powers.length;i++){
  var powername = powers[i][0].toUpperCase();
  if(powername.indexOf(filter)>-1){powers_viz[i][0]=1}
  else{powers_viz[i][0]=0}
 }
 filter_powers();
}

function clear_powers_filters(){
 let e = document.getElementById('all_powers').getElementsByClassName('more_info');
 while(e.length){
  e[0].children[0].children[1].innerHTML = '';
  e[0].classList.remove('more_info');
 }

 for (var i=0;i<powers.length;i++){powers_viz[i]=[1,1,1]}
 cpower_type=[],cpower_cat=[];

 e = document.getElementById('power_type');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('power_cat');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('power_name');e.value='';
 filter_powers_name(e);
}

//-------------------------SPELLS FUNCTIONS------------------------//

data.magias = [];
var spell_viz = [];
function list_spells(e,i){
 var div = document.createElement('div');
 document.getElementById(e).appendChild(div);
 e = e.replace('all_','');

 div.setAttribute('class',e+' w10');
 div.setAttribute('onclick','spell_info(this)');
 div.setAttribute('index',i);
 var content = '<div class="spell_details"><div class="w10 dif"><div class="w9"><p class="item_title">'+spells[i][0]+'</p><p class="item_subtitle">'+spell_pm_cost[spells[i][2]-1]+' PM • '+spells[i][1]+' • '+spells[i][3]+' '+spells[i][2]+'</p></div><div class="item_action w1 ma">';
 if(spell_action.includes(spells[i][4])){content += '<div class="ac_'+spells[i][4]+'"></div>'}
 content += '</div></div><div class="item_subtitle w10 ms"></div></div>';
 div.innerHTML = content;
 spell_viz.push([1,1,1,1]);
}

function spell_info(e){
 var i = e.getAttribute('index');
 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(e.innerHTML){e.innerHTML = ''} else {
  var content = '';

  if(spells[i][4]){content += '<p class="nowrap"><b>Ação:</b> '+spells[i][4]+'</p>'} //!spell_action.includes(spells[i][4])
  if(spells[i][5]){content += '<p class="nowrap"><b>Alcance:</b> '+spells[i][5]+'</p>'}
  if(spells[i][7]){content += '<p class="nowrap"><b>Alvo:</b> '+spells[i][7]+'</p>'}
  if(spells[i][8]){content += '<p class="nowrap"><b>Área:</b> '+spells[i][8]+'</p>'}
  if(spells[i][10]){content += '<p class="nowrap"><b>Efeito:</b> '+spells[i][10]+'</p>'}
  if(spells[i][6]){content += '<p class="nowrap"><b>Duração:</b> '+spells[i][6]+'</p>'}
  if(spells[i][9]){content += '<p class="nowrap"><b>Resistência:</b> '+spells[i][9]+'</p>'}

  content += '<p class="nowrap ms">'+spells[i][11]+'</p>';
  var length = spells[i].length;
  for (var j=13;j<length;j+=2){
   content += '<p class="nowrap ms"><b>';
   content += Number.isInteger(spells[i][j])?('+'+spells[i][j]+' PM'):spells[i][j];
   content += ': </b><span>'+spells[i][j+1]+'</span></p>';
  }
  if(spells[i][12]){content += '<p class="nowrap"><i>Publicação:</i> '+spells[i][12]+'</p>'}
  content += '<button class="spell_add" onclick="add_spell(this)">Adicionar magia</button>';
  content += '<button class="delete spell_delete" onclick="remove_spell(this)">Remover magia</button>';
  e.innerHTML = content;
 }
}

function filter_spells(){
 let e = document.getElementById('all_spells').getElementsByClassName('spells');
 for (var i=0;i<spells.length;i++){
  if(spell_viz[i][0]&&spell_viz[i][1]&&spell_viz[i][2]&&spell_viz[i][3]){e[i].style.display=""}
  else{e[i].style.display="none"}
 }
}

function filter_spell_other(e){
 var k = e.getAttribute('tabindex');
 var filter = e.innerHTML;
 if(!filter){filter=JSON.stringify(spell_inputs[k-1])}
 for (var i=0;i<spells.length;i++){
  if(filter.indexOf(spells[i][k])>-1){spell_viz[i][k]=1}
  else{spell_viz[i][k]=0}
 }
 filter_spells();
}

function filter_spell_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<spells.length;i++){
  var spellname = spells[i][0].toUpperCase();
  if(spellname.indexOf(filter)>-1){spell_viz[i][0]=1}
  else{spell_viz[i][0]=0}
 }
 filter_spells();
}

function clear_spell_filters(){
 let e = document.getElementById('all_spells').getElementsByClassName('more_info');
 while(e.length){
  e[0].children[0].children[1].innerHTML = '';
  e[0].classList.remove('more_info');
 }

 for (var i=0;i<spells.length;i++){spell_viz[i]=[1,1,1,1]}
 cspell_level=[],cspell_class=[],cspell_school=[];

 e = document.getElementById('spell_level');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_class');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_school');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_name');e.value='';
 filter_spell_name(e);
}

function add_spell(e){
 e = e.parentNode.parentNode.parentNode.cloneNode(true);
 e.removeAttribute('id');
 e.classList.remove('more_info');
 e.children[0].children[1].innerHTML = '';
 document.getElementById('char_spells').appendChild(e);
 data.magias.push(JSON.parse(e.getAttribute('index')));
}

function remove_spell(e){
 e = e.parentNode.parentNode.parentNode;
 let pows = document.getElementById('char_spells').getElementsByClassName('spells');
 let x = Array.prototype.indexOf.call(pows,e);
 data.magias.splice(x,1);
 e.remove();
}

//-------------------------CONFIG FUNCTIONS------------------------//

function invert(color){return (Number(`0x1${color}`)^0xFFFFFF).toString(16).substr(1).toUpperCase()}
function menucolor(color){
 document.querySelector('meta[name="theme-color"]').setAttribute('content',color);
 document.querySelector(':root').style.setProperty('--t20white',data.c_nocturnal?'#000':'#fff');
 document.querySelector(':root').style.setProperty('--t20weight',data.c_nocturnal?'600':'400');
 document.querySelector(':root').style.setProperty('--bright',data.c_nocturnal?'brightness(.9)':'brightness(1.1)');
 color = data.c_nocturnal?invert(color.replace('#','')):color.replace('#','');
 document.querySelector(':root').style.setProperty('--menu','#'+color);
 color = 'url(\''+backborder.replace('backborder',color)+'\') 4% repeat';
 document.querySelector(':root').style.setProperty('--backborder',color);
}

function fullscreen(e){
 if(data.c_fullscreen&&document.fullscreenElement==null){
  if(e.requestFullscreen){e.requestFullscreen()}
  else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}
  else if(e.msRequestFullscreen){e.msRequestFullscreen()}
 }
 if(!data.c_fullscreen&&document.fullscreenElement){
  if(document.exitFullscreen){document.exitFullscreen()}
  else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}
  else if(document.msExitFullscreen){document.msExitFullscreen()}
 }
}

function config(){
 const colorpicker = document.getElementById('c_color');
 data.c_keyboard?keyboard.classList.add('keyext'):keyboard.classList.remove('keyext');

 document.querySelector(':root').style.setProperty('--hph',(data.c_dice&&keyboard.classList.contains('boardshow'))?'256px':'120px');
 document.querySelector(':root').style.setProperty('--drh',data.c_dice?'var(--drb)':'90%');

 if(data.c_magic){
  allmenubtn[4].classList.add('dn');
  sections[4].classList.add('dn');
  if(menubtn.indexOf(4)>0){menubtn.splice(menubtn.indexOf(4),1)}
 }else{
  allmenubtn[4].classList.remove('dn');
  sections[4].classList.remove('dn');
  if(menubtn.indexOf(4)<0){menubtn.splice(menubtn.indexOf(5),0,4)}
 }

 if(data.c_nocturnal){
  document.documentElement.classList.add('invert');colorpicker.classList.add('invert');keyboard.classList.add('invert');
  document.getElementById('hpbar').classList.add('hpinvert');
  document.getElementById('mpbar').classList.add('hpinvert');
  document.querySelector(':root').style.setProperty('--grun','#ca56f0');
  document.querySelector(':root').style.setProperty('--rot','#10ecec');
  document.querySelector(':root').style.setProperty('--opc','0.83');
 }else{
  document.documentElement.classList.remove('invert');colorpicker.classList.remove('invert');keyboard.classList.remove('invert');
  document.getElementById('hpbar').classList.remove('hpinvert');
  document.getElementById('mpbar').classList.remove('hpinvert');
  document.querySelector(':root').style.setProperty('--grun','#35a90f');
  document.querySelector(':root').style.setProperty('--rot','#ef1313');
  document.querySelector(':root').style.setProperty('--opc','0.93');
 }

 fullscreen(document.documentElement);
 if(loaded){navig(allmenubtn[0])}else{navig(allmenubtn[allmenubtn.length-1])}
 menucolor(data.c_color);
}
keyboard.classList.add('keyext');

//-------------------------NAVIGATION FUNCTIONS------------------------//

const sections = document.getElementsByClassName('sec');
const allmenubtn = document.getElementsByClassName('menubtn');
var menubtn = [];
for(var i=0;i<allmenubtn.length;i++){menubtn.push(i)};
document.documentElement.style.setProperty("--menulen",allmenubtn.length*100+"%");

function navig(e){
 for(var i=0;i<allmenubtn.length;i++){
  allmenubtn[i].children[0].children[0].classList.remove('menuselicon');
  allmenubtn[i].children[0].children[1].classList.remove('menuseltext');
 }
 e.children[0].children[0].classList.add('menuselicon');
 e.children[0].children[1].classList.add('menuseltext');

 var x = Array.prototype.indexOf.call(allmenubtn,e);
 x = menubtn.indexOf(x);
 x = window.innerWidth>990&&x==menubtn.length-1?x-1:x;

 document.documentElement.style.setProperty("--menulen",menubtn.length*100+"%");
 document.getElementById('sections').style.transform='translate(-'+x*100/menubtn.length+'%,0)';
 window.scrollTo({top:0,behavior:'smooth'});
}

let touchstartX = 0;
let touchendX = 0;
function deltaX(){var deltaX = touchstartX-touchendX;if(deltaX>200&&x<8){navig(menubtn[x+1])}if(deltaX<-200&&x>0){navig(menubtn[x-1])}}
document.getElementById('sections').addEventListener('touchstart',e=>{touchstartX=e.changedTouches[0].screenX},{passive:true})
document.getElementById('sections').addEventListener('touchend',e=>{touchendX=e.changedTouches[0].screenX;deltaX()},{passive:true})

function hide(e,el){if(el==e.target){el.classList.toggle('invisible');if(el.id=="backdrop_spell"){clear_spell_filters()};if(el.id=="backdrop_power"){clear_powers_filters()}}}
function show(el){document.getElementById(el).classList.toggle('invisible')}

function filter(e){
 let k = (e.id=="armor"||e.id=="shield"||e.id=="char")?2:1;
 let filter = e.value.toUpperCase();
 let a = e.parentNode.children[k].getElementsByTagName("a");
 for(let i=0;i<a.length;i++){
  txtValue = a[i].textContent || a[i].innerText;
  txtValue.replaceAll('<b>','').replaceAll('</b>','');
  if(txtValue.toUpperCase().indexOf(filter)>-1){
   let result = [...txtValue.matchAll(new RegExp(filter,'gi'))].map(z => z.index);
   txtValue = txtValue.split('');
   for(let i=result.length;i>0;){i--;txtValue.splice(result[i]+filter.length,0,'</b>');txtValue.splice(result[i],0,'<b>')}
   a[i].innerHTML = txtValue.join('');
   a[i].style.display="";
  }
  else{a[i].style.display="none"}
 }
}

function show_list(e){e.focus();e = e.parentNode.children[2].classList.remove('dn')}

var cspell_level=[],cspell_class=[],cspell_school=[],cclasse=[],cdivindade=[],cdeslocamento=[],cpower_type=[],cpower_cat=[];
function set_check(e,array){
 e.classList.toggle('checkmarked');
 e.setAttribute('value',e.getAttribute('value')==1?0:1)

 if(e.getAttribute('value')==1){array.push(e.innerHTML)}else{array.splice(array.indexOf(e.innerHTML),1)}
 array.sort();

 e = e.parentNode.parentNode.children[0];
 e.innerHTML = array.join(', ');

 var c = e.parentNode.parentNode.parentNode.parentNode.parentNode.id;
 if(e.getAttribute('inner')){data_inner(e)}
 if(e.getAttribute('str')){data_str(e)}
 else if(c=="backdrop_power"){filter_powers_other(e)}
 else if(c=="backdrop_spell"){filter_spell_other(e)}
}

window.addEventListener('click',function(e){
 var el = document.getElementsByClassName('dropdown');
 for (i=0;i<el.length;i++){
  if(!el[i].parentNode.contains(e.target)){el[i].parentNode.children[2].classList.add("dn")}
 }
 window.focus();
});
document.addEventListener('touchstart',e=>{if(data.c_vibrate){navigator.vibrate(75)}})

//-------------------------CHARACTERS FUNCTIONS------------------------//

function char_create(e){
 if(e.title){
  e.parentNode.classList.add('dn');
  clear();
  title = e.title;
  chars.push(title);
  data.char=title;
  document.getElementById('char').value=title;
  document.getElementById('chardel').disabled = false;
  document.title = title + ' - T20';
  equip_kit();
  print_out('Rolagem de moedas iniciais:');diceroll('4d6');data.carga['ts']=soma;document.getElementById('ts').value=data.carga['ts'];
  document.getElementById('c_color').value = '#b72a2b';
  console.log('Character '+title+' was created');
 }
}

function char_set(el){
 if(title){save_data()}
 el.parentNode.classList.add('dn');
 clear();
 title = el.innerHTML;
 data_load();
 document.title = title + ' - T20';
 document.getElementById('chardel').disabled = false;
 data_set();
 console.log('Character '+title+' was loaded');
}

function char_remove(){
 if(title){
  console.log('Character '+title+' was removed');
  chars.splice(chars.indexOf(title),1);
  localStorage.removeItem(title+'_data');
  clear();
  document.title = 'Ficha T20 Mobile - v1.5';
  document.getElementById('chardel').disabled = true;
 }
}

function char_list(el){
 var value = el.value;
 el = el.parentNode.children[2];
 if(value||chars.length){el.classList.remove('dn')}
 if(!value&&!chars.length){el.classList.add('dn')}
 el.innerHTML = '';
 if(value&&JSON.parse(localStorage.chars).indexOf(value)){el.innerHTML = '<a onclick="char_create(this)" title="'+value+'">Clique para criar '+value+'</a>'}
 for(var i=0;i<chars.length;i++){el.innerHTML += '<a onclick="char_set(this)">'+chars[i]+'</a>'}
}

//-------------------------STARTER FUNCTIONS------------------------//

function create_select(array){
 for (j=0;j<array.length;j++){
  var div = document.createElement('option');
  if(j){div.setAttribute('value',j);div.innerHTML = array[j]}
  else{div.setAttribute('disabled','');div.setAttribute('selected','')}
  document.getElementById(array[0]).appendChild(div);
 }
}

function create_checkbox(array){
 let q = '';
 for(var j=1;j<array.length;j++){q += '<a class="'+(JSON.stringify(array[j]).includes('—')?' gray">':'checkmark" onclick="set_check(this,c'+array[0]+')" value="0">')+array[j]+'</a>'}
 document.getElementById(array[0]).parentNode.children[2].innerHTML = q;
}

function create_habs(){
 var e = document.getElementById('habilidades').children[0].children[0];
 for (var i=1;i<habs.length;i++){
  if(i>=habs.length/2){e = e.parentNode.children[1]}
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  var content = '<div class="w2 dif"><div class="hab_label">'+habs[i].toUpperCase()+'</div></div>';
  content += '<div class="w4"><div class="input"><input id="hab_'+habs[i]+'_val" class="tc hab" inputmode="numeric" onkeyup="regex2(this)" onchange="data_add(this);calc_hab()" autocomplete="off" required></div></div>';
  content += '<div class="w2 dif"'+(i==1?'id="dice1" ':'')+'onclick="startroll(\'hab_'+habs[i]+'\')"><div class="dice" data-dice="d20"></div></div>';
  content += '<div class="w2 dif"><p id="hab_'+habs[i]+'" class="ma0" sign="1">+0</p></div>';
  div.innerHTML = content;
  e.appendChild(div);
 }
}

function start_up(){
 menucolor('#b72a2b');
 create_habs();
 const menuicon = document.getElementsByClassName('menuicon');
 for (var i=0;i<menuicon.length;i++){menuicon[i].innerHTML = icons[i]}
 for (var i=0;i<inputs.length;i++){create_select(inputs[i])}
 create_checkbox(classe);
 create_checkbox(divindade);
 create_checkbox(deslocamento);
 for (var i=0;i<spell_inputs.length;i++){create_checkbox(spell_inputs[i])}
 for (var i=0;i<power_inputs.length;i++){create_checkbox(power_inputs[i])}
 for (var i=0;i<spells.length;i++){list_spells('all_spells',i)}
 for (var i=0;i<powers.length;i++){list_powers('all_powers',i,powers)}
 for (var i=0;i<conditions.length;i++){list_conditions('conditions',i,conditions)}
 list_skills(skills,i,'skills');
 list_skills(crafts,i,'crafts');
 list_rd();
 set_keyboard();
 dice = document.getElementsByClassName('dice');
 for (var i=0;i<dice.length;i++){dice[i].innerHTML = dices[dice[i].getAttribute("data-dice")]}
 if(!JSON.parse(localStorage.chars).length){hints.forEach(showhint)}
}

//-------------------------DATA MANAGEMENT FUNCTIONS------------------------//

function data_add(e){data[e.id]=JSON.parse(e.value)}
function data_array(e){data[e.id]=e.value}
function data_check(e){data[e.id]=e.checked;loaded=0}
function data_inner(e){var value = e.innerHTML.replace('+','');data[e.id]=JSON.parse(value)}
function data_str(e){data[e.id]=e.innerHTML}


function data_set(){
 for (const key in data){
  if(key=='magias'){
   for (var i=0;i<data.magias.length;i++){list_spells('char_spells',data.magias[i])}
  }else if(key=='powers'){
   for (var i=0;i<data.powers.length;i++){list_powers('powers',data.powers[i],powers)}
  }else if(key=='user_powers'){
   for (var i=0;i<data.user_powers.length;i++){list_powers('user_powers',i,data.user_powers)}
  }else if(key=='defense'){
   for (let i in data.defense){document.getElementById(i).value=data.defense[i]}
  }else if(key=='skills'||key=='crafts'||key=='cond'||key=='cond_user'){ //do nothing
  }else if(key=='conditions'){
   var conds = document.getElementById('conditions').getElementsByClassName('condmark');
   for (var i=0;i<conds.length;i++){if(data.conditions[0][i]){conds[i].classList.add('condmarked');cond_info(conds[i].parentNode.children[1],conditions)}}
   for (var i=0;i<data.cond_user.length;i++){list_conditions('cond_user',i,data.cond_user)}
   conds = document.getElementById('cond_user').getElementsByClassName('condmark');
   for (var i=0;i<conds.length;i++){if(data.conditions[1][i]){conds[i].classList.add('condmarked');cond_info(conds[i].parentNode.children[1],data.cond_user)}}
  }else if(key=='attack'){for (var i=0;i<data.attack.length;i++){attack_list(i)}
  }else if(key=='equip'){for(var i=0;i<data.equip.length;i++){equip_add(data.equip[i][0],data.equip[i][1],data.equip[i][2],data.equip[i][3],data.equip[i][4],data.equip[i][5])}equip_calc()
  }else{
   var e=document.getElementById(key);
   if(e.getAttribute('sign')){e.innerHTML=add_plus_sign(data[key])}
   else if(e.getAttribute('inner')){e.innerHTML=data[key]}
   else if(e.getAttribute('str')){e.innerHTML=data[key]}
   else if(e.type=='checkbox'){e.checked=data[key]}
   else{e.value=data[key]}
  }
 }
 title=data.char;
 document.title = title + ' - T20';
 document.getElementById('chardel').disabled = false;
 document.getElementById('sections').style.transform='';
 config();
 calc_hab();calc()
}

window.onload = function(){
 start_up();
 if(localStorage.getItem('chars')){chars = JSON.parse(localStorage.getItem('chars'))}
}

window.addEventListener('beforeunload',save_data);
function save_data(){
 localStorage.setItem('chars',JSON.stringify(chars));
 if(title){localStorage.setItem(title+'_data',JSON.stringify(data))}
}

function check_empty(){
 if(!data.magias){data.magias=[]}
 if(!data.powers){data.powers=[]}
 if(!data.user_powers){data.user_powers=[]}
 if(!data.skills){data.skills=skills}
 if(!data.crafts){data.crafts=crafts}
 if(!data.defense){data.defense=structuredClone(data_ini.defense)}
 if(!data.attack){data.attack=[]}
 if(!data.equip){data.equip=[]}
 if(!data.carga){data.carga=structuredClone(data_ini.carga)}
 if(!data.conditions){data.conditions=[[],[]]}
 if(!data.cond){data.cond=structuredClone(data_ini.cond)}
 if(!data.cond_user){data.cond_user=[]}
}

function data_load(){
 if(localStorage.getItem(title+'_data')){
  data = JSON.parse(localStorage.getItem(title+'_data'));
  check_empty();
  loaded=1;
 }
}

function clear(){
 var input = document.getElementsByTagName("input");
 for (var i=0;i<input.length;i++){input[i].value=''}
 var select = document.getElementsByTagName("select");
 for (var i=0;i<select.length;i++){option = select[i].options;option[0].selected = true}
 var fakeinput = document.getElementsByClassName('fakeinput');
 for (var i=0;i<fakeinput.length;i++){fakeinput[i].innerHTML=''}
 document.getElementById('char_spells').innerHTML = '';
 document.getElementById('powers').innerHTML = '';
 document.getElementById('user_powers').innerHTML = '';
 document.getElementById('char_attack').innerHTML = '';
 document.getElementById('char_equip').innerHTML = '';
 document.getElementById('carga').innerHTML = 0;
 document.getElementById('carga_cap').value = 10;
 document.getElementById('to').value = 0;
 document.getElementById('ts').value = 0;
 document.getElementById('tc').value = 0;
 document.getElementById('cond_user').innerHTML = '';
 document.getElementById('conditions').innerHTML = '';
 document.getElementById('deslocamento').parentNode.children[3].innerHTML = '';
 for (var i=0;i<conditions.length;i++){list_conditions('conditions',i,conditions)}
 title='';
 data = structuredClone(data_ini);
 calc();
}

function import_char(evt){
 data = structuredClone(data_ini);
 if(!window.FileReader) return; // Browser is not compatible
 var reader = new FileReader();
  reader.onload = function(evt) {
   if(evt.target.readyState!=2) return;
   if(evt.target.error){alert('Error while reading file');return}
   data = JSON.parse(evt.target.result);
   check_empty();
   chars.push(data.char);
   data_set();
   console.log('Character '+data.char+' data imported');
  };
 reader.readAsText(evt.target.files[0]);
 loaded=1;
}

function export_char(){
 var filename = title?'char_'+title:'unnamed_char' +'.txt';
 var filedata = JSON.stringify(data);
 var file = new Blob([filedata], {type:'text/plain'});
 if (window.navigator.msSaveOrOpenBlob) // IE10+
     window.navigator.msSaveOrOpenBlob(file, filename);
 else{
  var a = document.createElement("a"),url = URL.createObjectURL(file);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(function() {
   document.body.removeChild(a);
   window.URL.revokeObjectURL(url);
  }, 0);
 }
 console.log('Character '+title+' data exported');
}

function reset(){localStorage.clear();chars=[];data={};title='';location.reload()}

//-------------------------HINT FUNCTIONS------------------------//

function showhint(arr,j){
 let div = document.createElement('div');
 div.setAttribute('class','hint hint'+j);
 div.setAttribute('onclick','event.stopPropagation();this.remove()');
 div.innerHTML = arr[2];
 e = document.getElementById(arr[0])
 for(let i = 0;i<arr[1];i++){e = e.parentNode}
 e.appendChild(div);
}

const hints = [
['char',2,'Comece criando ou carregando um personagem, para isso entre com um nome de personagem e clique na opção "Cliqui para criar", quaisquer edições feitas antes disso serão perdidas.'],
['dice1',0,'Clique no dado para rolar o referido teste sempre que quiser, o rolador de dados mostrará o resultado.'],
['drawer',1,'Clique na barra cinza para abrir e fechar os marcadores de PVs e PMs, e o rolador de dados.'],
['drawer',1,'Role o menu horizontalmente para acessar as demais sessões.']
];

//-------------------------REGEX FUNCTIONS------------------------//

function regex_inj(e){e.value=/[<>\[\]\{\}\$#&]+/.test(e.value)?e.value.slice(0,-1):e.value}
function regexo(e){e.value=/^([+-]|[0-9]|[d])*$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexb1(e){e.value=/^([+-]|[0-9]|\/)*$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexb2(e){e.value=='d'?'d':e.value=/^([d]|[0-9])*$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexc1(e){e.value=/^([1-9]|1[0-9]|20)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexc2(e){e.value=='x'?'x':e.value=/^x(100|[1-9][0-9]?)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regex(e){e.value=='-'||e.value=='+'?'-':e.value=/^[-+]?(0|[1-9]\d*)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regex2(e){e.value=/^(0|[1-9]\d*)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexqte(e){e.value=/(\d)*$/.test(e.value)?e.value:e.value.slice(0,-1)}

</script>
</html>
