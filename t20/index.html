<!DOCTYPE html>
<html lang="pt-BR">
<head>
<title>Ficha T20 Mobile - v1.6.3</title>
<meta name="author" content="Marco Martins">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<meta name="theme-color" content="#b72a2b">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="manifest" href="/manifest.json">
<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<link rel="icon" type="image/png" href="src/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="src/css.css">
<link rel="stylesheet" href="src/style.css">
<script type="text/javascript" src="db/icons.js"></script>
<script type="text/javascript" src="db/equips.js"></script>
<script type="text/javascript" src="db/common.js"></script>
<script type="text/javascript" src="db/geral.js"></script>
<script type="text/javascript" src="db/spells.js"></script>
<script type="text/javascript" src="db/powers.js"></script>
<script type="text/javascript" src="db/skills.js"></script>
<script type="text/javascript" src="db/conditions.js"></script>
<script type="text/javascript" src="js/worker_list.js"></script>
<script defer type="text/javascript" src="js/dice_roller.js"></script>
<script defer type="text/javascript" src="js/keyboard.js"></script>
</head>

<body class="dn">
<div id="sections">
 <div id="sec_char" class="sec">
  <h1>Personagem</h1>
  <div class="row"><div class="container db">
   <div class="half hint0p">
    <div class="input mt0">
     <input id="char" class="drop" type="text" onclick="char_list(this)" onkeyup="regex_inj(this);char_list(this);filter(this)" autocomplete="off" required>
     <label>Personagem</label>
     <div class="dropdown dn"></div>
    </div>
   </div><div class="half">
    <div class="input mt0"><input id="jogador" type="text" onchange="data_array(this)" onkeyup="regex_inj(this)" required><label>Jogador</label></div>
   </div>
  </div></div>

  <div id="habilidades" class="row"><div class="container t20box db"><div class="half"></div><div class="half"></div></div></div>

  <div class="row"><div class="container db">
   <div class="half">
    <div class="input"><select id="raça" onchange="data_add(this)" required></select><label>Raça</label></div>
    <div class="input"><select id="origem" onchange="data_add(this)" required></select><label>Origem</label></div>
    <div class="input"><select id="tamanho" onchange="data_add(this)" required></select><label>Tamanho</label></div>
    <div class="input m0"><div id="deslocamento" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Deslocamento</label><div class="dropdown dn"></div><p class="item_subtitle m3e"></p></div>
   </div>
   <div class="half">
    <div class="row dif">
     <div class="w10 input"><div id="classe" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Classe</label><div class="dropdown dn"></div></div>
     <div class="w1"></div>
     <div class="w3 input"><select id="nível" class="tc" onchange="data_add(this);calc()" required></select><label class="tac">Nível</label></div>
    </div>
    <div class="input mt0"><input id="distincao" onchange="data_array(this)" onkeyup="regex_inj(this)" autocomplete="off" required><label>Distinção de classe</label></div>
    <div class="input mt0"><div id="divindade" class="fakeinput drop" onclick="show_list(this)" str="1"></div><label>Divindade</label><div class="dropdown dn"></div></div>
    <div class="input"><input id="xp" type="number" onchange="data_add(this)" onkeyup="regex_inj(this)" autocomplete="off" required><label>Experiência</label></div>
   </div>
  </div></div>

  <div class="divider"></div>

  <div class="row"><div class="container db mw400">
   <button onclick="printPDF()">Imprimir</button>
   <label for="file"><input id="file" type="file" onchange="import_char(event)">Importar</input></label>
   <button onclick="export_char()">Exportar</button>
   <button id="chardel" class="delete" onclick="char_remove()" disabled>Deletar</button>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma mt tc">v1.6.3</p>
  </div></div>

 </div>

 <div id="sec_combat" class="sec">
  <h1>Combate</h1>
  <div class="row t20box">
   <div class="container dif z1" onclick="defense_info('char_ac')">
    <div class="w8"><p>Defesa</p></div>
    <div class="w3"><p id="ac" class="tac">10</p></div>
   </div>
   <div id="char_ac" class="container db def_info mw400 def_hide">
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab" class="select tc" onchange="def_set(this);def_calc()">
      <option disabled=""></option><option value="1">for</option><option value="2" selected>des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Habilidade</p>
    </div></div>
    <div class="w10 dif"><div class="w3 m0a dif">
     <select id="def_hab2" class="select tc" onchange="def_set(this);def_calc()">
      <option selected></option><option value="1">for</option><option value="2">des</option><option value="3">con</option><option value="4">int</option><option value="5">sab</option><option value="6">car</option>
     </select>
     </div><div class="w6 m0a dif"><p class="p_skill">Hab secundária</p>
    </div></div>
    <div class="w10 dif">
     <div class="w3 m0a dif"><input id="def_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this);def_calc()" autocomplete="off"></div>
     <div class="w6 m0a dif"><p class="p_skill">Outro</p></div>
    </div>
    <div class="w10 dif">
     <div class="w3 m0a mh51 dif"><p id="def_cond" class="p_skill tac">+0</p></div>
     <div class="w6 m0a dif"><p class="p_skill">Condições</p></div>
    </div>
    <div class="w10 df"><div class="w8 ma mw400 df"><p class="p_skill tac">Armadura e Escudo</p></div></div>
    <div class="w10 df"><div class="w10 mw400 ma db">
     <div class="def_half pr"><input id="armor" type="text" onchange="def_set(this)" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,1)" autocomplete="off"><label>Armadura</label></div>
     <div class="def_quarter m0a pr"><input id="armor_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);def_calc()" autocomplete="off"><label class="def_label">Bônus</label></div>
     <div class="def_quarter m0a pr"><input id="armor_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc_skills('skills')" autocomplete="off"><label class="def_label">Penalidade</label></div>
    </div></div>
    <div class="w10 df"><div class="w10 mw400 ma db">
     <div class="def_half pr"><input id="shield" type="text" onchange="def_set(this)" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,5)" autocomplete="off"><label>Escudo</label></div>
     <div class="def_quarter pr"><input id="shield_bonus" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);def_calc()" autocomplete="off"><label class="def_label">Bônus</label></div>
     <div class="def_quarter pr"><input id="shield_penal" class="def_input" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);calc_skills('skills')" autocomplete="off"><label class="def_label">Penalidade</label></div>
    </div></div>
    <div id="armor_penal" sign="1" style="height:50px"></div><div id="shield_penal" sign="1"></div>
   </div>
   <div class="container dif z1">
    <div class="w8" onclick="defense_info('char_rd')"><p>Redução de Dano</p></div>
    <div class="w3"><input id="rd" class="skill_input tac" inputmode="numeric" sign="1" onkeyup="regex(this)" onchange="def_set(this);rd_calc()" autocomplete="off"></div>
   </div>
   <div id="char_rd" class="container db def_info mw400 def_hide"></div>
  </div>

  <div class="row"><div id="char_attack" class="container db z1">
  </div></div>
  <div class="row"><div class="container">
   <button onclick="attack_add()">Adicionar ataque</button>
  </div></div>
 </div>

 <div id="sec_skills" class="sec">
  <h1 style="margin-bottom:.6em">Perícias</h1>
  <div class="row"><div id="char_skills" class="db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado&#9;‡penalidade de armadura</p></div></div>
  <h1 style="margin:2em 0 .6em">Ofícios</h1>
  <div class="row"><div id="char_crafts" class="db"></div></div>
  <div class="row"><div class="container db"><p class="item_subtitle tac">*somente treinado</p></div></div>
 </div>

 <div id="sec_feat" class="sec">
  <h1>Poderes</h1>
  <div class="row"><div id="powers" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_power')">Buscar poderes</button>
  </div></div>
  <h1 style="margin:2em 0 .6em">Poderes Personalizados</h1>
  <div class="row"><div id="user_powers" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="user_power()">Adicionar poder personalizado</button>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">Dica: utilize *texto* para <b>negrito</b> e _texto_ para <i>itálico</i>.</p>
  </div></div>
 </div>

 <div id="sec_spell" class="sec">
  <h1>Magias</h1>
  <div class="row t20box">
   <div class="container">
    <div class="w8"><p>Atributo chave</p></div>
    <div class="w3"><select id="spell_hab" class="select tc" onchange="data_add(this);calc_spell_res()"></select></div>
   </div><div class="container">
    <div class="w8"><p class="tal">Teste de resistência</p></div>
    <div class="w3 dif"><p id="spell_res" class="ma" inner="1">10</p></div>
   </div>
  </div>
  <div class="row"><div id="char_spells" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="show('backdrop_spell')">Buscar magias</button>
  </div></div>

  <h1 style="margin:2em 0 .6em">Magias Personalizadas</h1>
  <div class="row"><div id="user_spells" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="user_spell()">Adicionar magia personalizada</button>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">Dica: utilize *texto* para <b>negrito</b> e _texto_ para <i>itálico</i>.</p>
  </div></div>
 </div>

 <div id="sec_condition" class="sec">
  <h1>Condições</h1>
  <div class="row"><div id="conditions" class="container dg"></div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">As condições acima encontram-se descritas na página 394 do livro <i>Tormenta 20: Jogo do Ano</i>.</p>
  </div></div>

  <h1 style="margin:2em 0 .6em">Condições Personalizadas</h1>
  <div class="row"><div id="cond_user" class="container db"></div></div>
  <div class="row"><div class="container">
   <button onclick="cond_create()">Adicionar condição</button>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">Dica: utilize *texto* para <b>negrito</b> e _texto_ para <i>itálico</i>.</p>
  </div></div>
 </div>

 <div id="sec_equip" class="sec">
  <h1>Equipamentos</h1>
  <div class="row"><div id="char_equip" class="container db"></div></div>
  <div class="row"><div class="container">
   <button id="equip_add" onclick="equip_add(1,'','','','','')">Adicionar equipamento</button>
  </div></div>


  <h1 style="margin:2em 0 .6em">Moedas</h1>
  <div class="row"><div class="container dif">
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">TO</p></div><div class="w5 dif"><input id="to" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">T$</p></div><div class="w5 dif"><input id="ts" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
   <div class="w3 dif"><div class="w5 dif"><p class="item_title ma">TC</p></div><div class="w5 dif"><input id="tc" class="skill_input mwu tc" type="number" placeholder="0" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div></div>
  </div></div>
  <div class="row"><div class="container dif">
   <p class="item_subtitle ma ms tc">Cada mil moedas, independentemente do tipo, ocupam 1 espaço.</p>
  </div></div>

  <h1 style="margin:2em 0 .6em">Capacidade de Carga</h1>
  <div class="row"><div class="container mw450 dif">
   <div class="w5 dif">
    <div class="w5 dif"><p class="item_title ma">Atual</p></div>
    <div class="w3 dif"><p id="carga" class="item_title ma" style="font-weight:300">0</p></div>
   </div>
   <div class="w5 dif">
    <div class="w5 dif"><p class="item_title ma">Máximo</p></div>
    <div class="w3 dif"><input id="carga_cap" class="skill_input mwu tc" type="number" placeholder="10" autocomplete="off" onkeyup="regex_inj(this)" onchange="coins(this)"></div>
   </div>
  </div></div>
  <div class="row"><div class="container df">
   <p class="item_subtitle ma ms tc">Você pode carregar 10 espaços +2 por ponto de Força (ou -1 por ponto de Força negativo). Se ultrapassar esse limite, fica <i>sobrecarregado</i> (veja Limites de Carga na página 141). Você não pode carregar mais do que o dobro do seu limite.</p>
  </div></div>
  <div class="row mt"><div class="container df">
   <p class="item_subtitle ma ms tc"><b>Observação:</b> ao criar um personagem você começa com um Traje do Viajante, uma Mochila, um Saco de Dormir, uma arma simples e, se tiver proficiência, uma arma marcial à sua escolha, e uma armadura leve (exceto <i>Arcanistas</i>) ou uma Brunea e/ou um escudo leve se tiver as respectivas proficiências, além de T$ 4d6 (veja Equipamento Inicial na página 140).</p>
  </div></div>
  <div class="row mt"><div class="container df">
   <p id="total_value" class="item_subtitle ma ms tc">Valor estimado de tesouro: T$ 0</p>
  </div></div>
 </div>

 <div id="sec_notes" class="sec">
  <h1>Anotações</h1>
  <div class="row"><div class="container db">
   <textarea id="anot" onchange="data_array(this)"></textarea>
  </div></div>
  <h1 style="margin:2em 0 .6em">Parceiros</h1>
  <div class="row"><div class="container db">
   <textarea id="parceiros" onchange="data_array(this)"></textarea>
  </div></div>
  <div class="row mt"><div class="container df">
   <p class="item_subtitle ma ms tc">Um parceiro é um seguidor ou um aliado que dá bônus ao personagem, podendo ser um companheiro animal, familiar ou um NPC (veja Parceiros na página 260).</p>
  </div></div>
 </div>

 <div id="sec_config" class="sec">
  <h1>Configurações</h1>

  <div class="row"><div class="container">
   <div class="w8"><p>Teclado avançado</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_keyboard" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8 config"><p class="m0">Esconder rolador de dados</p><p class="item_subtitle">(prefiro dados físicos!)</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_dice" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo tela cheia</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_fullscreen" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Modo noturno</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_nocturnal" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8"><p>Vibrar</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_vibrate" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>
  <div class="row"><div class="container">
   <div class="w8 config"><p class="m0">Esconder Magias</p><p class="item_subtitle">(para guerreiros)</p></div>
   <div class="w2 ma ml tc"><label class="switch"><input id="c_magic" type="checkbox" onclick="data_check(this);config()"><span class="slider"></span></label></div>
  </div></div>

  <div class="row"><div class="container">
   <div class="w8"><p>Cor customizada</p></div>
   <div class="w2 ma ml tc"><input id="c_color" type="color" value="#b72a2b" oninput="data_array(this);config()"></div>
  </div></div>
  <div class="divider"></div>

  <div class="row"><div class="container dif">
    <p>Você pode utilizar esse aplicativo offline, se desejar instale-o no seu celular, tablet ou computador. Veja o <a class="reset" href="https://support.google.com/chrome/answer/9658361" target="_blank">suporte Google</a> para instruções detalhadas.</p>
   </div></div>
  <div class="row"><div class="container dif">
   <p>Acesse também a ferramenta para mestres clicando <a class="reset" href="mestre.html" target="_blank">aqui</a>.</p>
  </div></div>
  <div class="divider"></div>
  <div class="row"><div class="container dif">
   <p>Esse aplicativo é desenvolvido de forma independente com fins recreativos apenas, ou seja, sem fins lucrativos.</p>
  </div></div>
  <div class="row"><div class="container t20box db">
   <p>Direitos referentes ao conteúdo Tormenta 20 reservados à seus criadores e à <a class="reset" style="color:#fff!important" href="https://jamboeditora.com.br/" target="_blank">Editora Jambô</a>.</p>
  </div></div>
  <div class="row"><div class="container db">
   <p>Direitos referentes ao código e API reservados exclusivamente ao autor.</p>
  </div></div>
  <div class="divider"></div>
  <div class="row"><div class="container db">
   <p>Seus dados são armazenados <b>apenas</b> localmente neste dispositivo, ou seja, nada é armazenado online ou em outro dispositivo.</p>
   <p class="mt">Use as opções <b>importar</b> e <b>exportar</b> para transferir seu personagem entre dispositivos.</p>
   <p class="mt">Caso deseje exluir todos os dados, por favor, utilize o botão a seguir. Eles <b>não</b> poderão ser recuperados.</p>
  </div><div class="container mw400 mt">
   <button class="delete" onclick="reset()">Excluir todos os dados</button>
  </div></div>
 </div>

</div>

<div id="dice_roller">
 <div id="drawer" onclick="openroller(this)"><div></div></div>
  <div class="hpcont">
   <div id="hpbar" class="cont_bar">
    <div class="container hpbar hp">
     <div class="fakeinput hp_input" id="hp" onfocus="fakefocus()" onblur="fakeblur(this)" inner="1" tabindex="0">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="hpmax" onfocus="fakefocus()" onblur="fakeblur(this)" inner="1" tabindex="0">0</div>
    </div>
   </div>
   <div id="mpbar" class="cont_bar">
    <div class="container hpbar mp">
     <div class="fakeinput hp_input" id="mp" onfocus="fakefocus()" onblur="fakeblur(this)" inner="1" tabindex="0">0</div>
     <div class="slash"></div>
     <div class="fakeinput hp_input" id="mpmax" onfocus="fakefocus()" onblur="fakeblur(this)" inner="1" tabindex="0">0</div>
    </div>
   </div>
  </div>
  <div id="diceholder">
   <div id="allrolls"><div id="results"><p><b>Exemplos de rolagens:</b></p></div></div>
   <div id="dice-input" class="fakeinput" onfocus="fakefocus()" onblur="fakeblur(this)" tabindex="0"></div>
  </div>
</div>

<nav>
 <div id="menu">
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon menuselicon"></div><div class="menutext menuseltext">Personagem</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Combate</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Perícias</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Poderes</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Magias</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Condições</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Equipamentos</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Anotações</div></div></div>
  <div class="menubtn" onclick="navig(this)"><div class="menubi"><div class="menuicon"></div><div class="menutext">Configurações</div></div></div>
 </div>
</nav>

<div id="keyboard" class="row"><div class="container keyboard"></div></div>

</div></div>

<div id="backdrop_power" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="power_name" type="text" onkeyup="regex_inj(this);filter_powers_name(this)" autocomplete="off" required><label>Nome</label></div>
   <div class="input"><div id="power_type" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Tipo</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="power_cat" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Raça, classe, categoria</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_powers" class="container db"></div></div>
 </div>
</div>

<div id="backdrop_spell" class="backdrop invisible" onclick="hide(event,this)">
 <div class="overlay">
  <div class="row"><div class="container t20box db">
   <h2>Buscar por...</h2>
   <div class="input"><input id="spell_name" type="text" onkeyup="regex_inj(this);filter_spell_name(this)" autocomplete="off" required><label>Nome</label></div>
   <div class="input"><div id="spell_class" class="fakeinput drop" onclick="show_list(this)" tabindex="1"></div><label>Classificação</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_level" class="fakeinput drop" onclick="show_list(this)" tabindex="2"></div><label>Nível</label><div class="dropdown dn"></div></div>
   <div class="input"><div id="spell_school" class="fakeinput drop" onclick="show_list(this)" tabindex="3"></div><label>Escola</label><div class="dropdown dn"></div></div>
  </div></div>
  <div class="row"><div id="all_spells" class="container db"></div></div>
 </div>
</div>

<script>
const load = 1;
var title = '', chars = [];
const data_ini = {
 char:'','nível':0,hp:0,hpmax:0,mp:0,mpmax:0,'spell_hab':1,
 'hab_for_val':10,'hab_for':0,'hab_des_val':10,'hab_des':0,'hab_con_val':10,'hab_con':0,'hab_int_val':10,'hab_int':0,'hab_sab_val':10,'hab_sab':0,'hab_car_val':10,'hab_car':0,
 'magias':[],'user_spells':[],'powers':[],user_powers:[],'conditions':[[],[]],'cond_user':[],'attack':[],'equip':[],cond:structuredClone(cond),'skills':skills,'crafts':crafts,
 'defense':{'def_hab':2,'armor_bonus':0,'shield_bonus':0,'armor_penal':0,'shield_penal':0,'def_out':0,'rd':0,'Ácido':0,'Eletricidade':0,'Fogo':0,'Frio':0,'Luz':0,'Trevas':0,'Mágico':0},
 'carga':{'to':0,'ts':0,'tc':0,'carga':0,'carga_cap':10},
 'c_color':'#b72a2b','c_keyboard':0,c_dice:false,'c_fullscreen':0,'c_nocturnal':0,'c_vibrate':0
}
var data = structuredClone(data_ini);

//-------------------------DEFENSE FUNCTIONS------------------------//

function defense_info(e){document.getElementById(e).classList.toggle('def_hide')}
function def_set(e){e.value==''?data.defense[e.id]=0:(data.defense[e.id]=!isNaN(e.value)?JSON.parse(e.value):e.value);save_data()}

function rd_calc(){
 document.getElementById('rd').value = data.defense.rd + data.cond['RD (todas)'];
 for (var i=0;i<rd.length;i++){
  document.getElementById(rd[i]).value = data.defense[rd[i]] + data.cond[rd[i]];
 }
 //save_data();
}

function def_calc(){
 document.getElementById('ac').innerHTML = 10+data.defense.armor_bonus+data.defense.shield_bonus+data.defense.def_out+data['hab_'+habs[data.defense.def_hab]] + (data.defense.def_hab2>0?data['hab_'+habs[data.defense.def_hab2]]:0)+data.cond['Defesa']+data.cond['Armadura (bonus)']+data.cond['Escudo (bonus)'];
 document.getElementById('def_cond').innerHTML = add_plus_sign(data.cond['Defesa']);
 document.getElementById('armor_bonus').value = add_plus_sign(data.defense.armor_bonus + data.cond['Armadura (bonus)']);
 document.getElementById('armor_penal').value = add_plus_sign(data.defense.armor_penal + data.cond['Armadura (penalidade)']);
 document.getElementById('shield_bonus').value = add_plus_sign(data.defense.shield_bonus + data.cond['Escudo (bonus)']);
 document.getElementById('shield_penal').value = add_plus_sign(data.defense.shield_penal + data.cond['Escudo (penalidade)']);
 //save_data();
}

function list_rd(){
 for (var i=0;i<rd.length;i++){
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  div.innerHTML = '<div class="w3 m0a dif"><input id="'+rd[i]+'" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="def_set(this);rd_calc()" autocomplete="off"></div><div class="w6 m0a dif"><p class="p_skill">'+rd[i]+'</p></div></div>';
  document.getElementById('char_rd').appendChild(div);
 }
}

function armor_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[2].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode;
 e.children[0].children[0].value = equip[i][0];
 e.children[1].children[0].value = equip[i][11];
 e.children[2].children[0].value = equip[i][12];

 data.defense[e.children[0].children[0].id] = equip[i][0];
 data.defense[e.children[1].children[0].id] = equip[i][11];
 data.defense[e.children[2].children[0].id] = equip[i][12];

 def_calc();calc_skills('skills');save_data();
}

//-------------------------ATTACK FUNCTIONS------------------------//

function base_split(str){
 if(str.search(/[#drabekl]/g)>-1){
  let n = str.includes('#')?str.slice(0,str.indexOf('#')):1;
  n = n?n:1;
  let s = str.match(/[+-]/g) || 0;
  let m = (s?str.slice(str.indexOf(s)):'0').replace('+','');
  let k = [];
  for (let i=0;i<n;i++){k.push([m])}
  return k;
 }
 else{return str.replace(/[+]/g,'').split('/')}
}

function weap_roll(e){
 let k = base_split(e.children[1].innerHTML);

 e = e.parentNode.parentNode.parentNode;
 let attacks = document.getElementsByClassName('attack');
 let x = Array.prototype.indexOf.call(attacks,e);

 let n;
 if(isNaN(data.attack[x][1])&&data.attack[x][1].search(/[#drabekl]/g)>-1){
  let str = data.attack[x][1];
  n = str.includes('#')?str.slice(0,str.indexOf('#')):1;
  n = n?n:1;
  str = str.slice(str.indexOf('#')+1);

  let p = 0;
  if(str.search(/[+-]/g)>-1){
   let q = str.indexOf('+')>0?str.indexOf('+'):(str.indexOf('-'));
   p = JSON.parse(str.slice(q).replace('+',''));
   str = str.slice(0,q);
  }
  p += (data.attack[x][11]?JSON.parse(document.getElementById(skills[data.attack[x][11]][0]+'_total').innerHTML.replace(/[+]/g,'')):0)+(data.attack[x][4]?data.attack[x][4]:0)+data.cond.Ataques;
  if(p){str += p>0?'+'+p:p}
  k = [];
  for(let i=0;i<n;i++){k.push(str)}
 }else{n = k.length}

 print_out('');
 print_out('Ataque'+(n>1?'s':'')+' com '+data.attack[x][0]+':');

 e = e.children[0].children[0].children[1].innerHTML;
 for (var i=0;i<n;i++){
  let c = data.attack[x][6]?data.attack[x][6]:20;
  if(n>1){print_out((i+1)+'º ataque:')}
  if(k[i].search(/[drabekl]/g)<0){diceroll('d20'+(k[i]<0?'':'+')+k[i],c)}
  else{diceroll(k[i],c)}

  let p = 1;
  if(roll[0]>=c){p = data.attack[x][7]?JSON.parse(data.attack[x][7].replace('x','')):2}

  var q = data.attack[x][2].indexOf('d');
  q = q<1?1:JSON.parse(data.attack[x][2].slice(0,q));
  p = p*q;
  diceroll(p+e.slice(e.indexOf('d')).slice(0,e.indexOf(' ')));
 }
 print_out('');print_out('');
 openroller(document.getElementById('drawer'));
}

function attack_calc(){
 let at_skill = document.getElementsByName('at_skill');
 let attacks = document.getElementsByClassName('attack');
 for (let i=0;i<attacks.length;i++){
  attacks[i].children[0].children[0].children[0].innerHTML=data.attack[i][0]?data.attack[i][0]:'Nome do Ataque';
  attacks[i].children[1].children[5].children[0].children[0].innerHTML=add_plus_sign(data.cond.Ataques); //condition attack
  attacks[i].children[1].children[5].children[1].children[0].innerHTML=add_plus_sign(data.cond.Dano); //condition damage

  let k = (data.attack[i][3]?data['hab_'+ habs[data.attack[i][3]]]:0)+data.cond.Dano;

  let o = 0;
  if(isNaN(data.attack[i][5])){
   o = data.attack[i][5][0]=='-'?data.attack[i][5]:'+'+data.attack[i][5];
   o += (k==0?'':(k>0?'+'+k:k));
  }else{
   o = data.attack[i][5] + k;
   o = (o==0?'':(o>0?'+'+o:o));
  }

  let p = data.attack[i][13]>1?'</br>'+action[data.attack[i][12]].replace('para ativar','')+' para atacar • '+action[data.attack[i][13]]+' para regarregar':' • '+action[data.attack[i][12]].replace('para ativar','para atacar');
  attacks[i].children[0].children[0].children[1].innerHTML=(data.attack[i][2]?data.attack[i][2]:'d8')+o+' • '+(data.attack[i][6]&&data.attack[i][6]<20?data.attack[i][6]+'-20':20)+'/'+(data.attack[i][7]?data.attack[i][7]:'x2')+' • '+(data.attack[i][8]>0?alcance[data.attack[i][8]]:'Alcance')+' • '+(data.attack[i][9]>0?tipo_dano[data.attack[i][9]]:'Tipo de dano')+p;
  data.attack[i][15] = (data.attack[i][2]?data.attack[i][2]:'d8')+o;

  k = 0;
  if(data.attack[i][1]==''){k=[0]}
  else if(!isNaN(data.attack[i][1])){k=[data.attack[i][1]]}
  else{k=base_split(data.attack[i][1])}

  for (var j=0;j<k.length;j++){
   k[j]=JSON.parse(k[j])+(data.attack[i][11]?JSON.parse(document.getElementById(skills[data.attack[i][11]][0]+'_total').innerHTML.replace(/[+]/g,'')):0)+(data.attack[i][4]?data.attack[i][4]:0)+data.cond.Ataques;
   k[j]=(k[j]>=0?'+':'')+k[j];
  }
  attacks[i].children[0].children[1].children[0].children[1].innerHTML=k.join('/');
  data.attack[i][14] = k.join('/');

  let ac = data.attack[i][12]?action[data.attack[i][12]].replace('Ação ','').replace('de ','').toLowerCase():'';
  attacks[i].children[0].children[1].children[1].innerHTML = spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'';
 }
 //save_data();
}

function attack_remove(e){
 e = e.parentNode.parentNode.parentNode;
 var attacks = document.getElementsByClassName('attack');
 var x = Array.prototype.indexOf.call(attacks,e);
 data.attack.splice(x,1);
 e.remove();
 save_data();
}

function attack_data(e,i){
 var attacks = document.getElementsByClassName('attack');
 var x = Array.prototype.indexOf.call(attacks,e.parentNode.parentNode.parentNode.parentNode);
 data.attack[x][i] = e.value==''?0:(isNaN(e.value)?e.value:JSON.parse(e.value.replace('+','')))
 attack_calc();
 save_data();
}

function attack_info(e){e.parentNode.parentNode.children[1].classList.toggle('def_hide')}

var dmg_type = '';
for(var i=0;i<tipo_dano.length;i++){dmg_type += '<option value="'+(i>0?i+'">':'" disabled selected>')+tipo_dano[i]+'</option>'}
var range = '';
for(var i=0;i<alcance.length;i++){range += '<option value="'+(i>0?i+'">':'" disabled selected>')+alcance[i]+'</option>'}
var skill_names = '<option value="" disabled selected>Perícia</option>';
for(var i=0;i<skills.length;i++){skill_names += '<option value="'+i+'">'+skills[i][0]+'</option>'}
var skill_habis = '';
for(var i=0;i<habis.length;i++){skill_habis += '<option value="'+(i>0?i+'">':'" disabled selected>')+habis[i]+'</option>'}

function attack_list(i){
 let div = document.createElement('div');
 div.setAttribute('class','w10 attack');
 div.setAttribute('attack',data.attack.length);

 let content2 = '<div class="w10 dif"><div class="w8 m0a pr dif">';
 content2 +=  '<input class="skill_input m3e" type="text" placeholder="Nome do ataque" value="'+data.attack[i][0]+'" autocomplete="off" onchange="attack_data(this,0)" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,2)">';
 content2 +=  '</div><div class="w2 m0a dif" onclick="attack_remove(this)"><div class="trash"></div></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 m3e dif"><p class="item_subtitle m0a">Ataque</p></div>';
 content2 +=  '<div class="w3 m3e dif"><p class="item_subtitle m0a" style="transform:translateX(-2px)">Dano</p></div>';
 content2 +=  '<div class="w4"></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><div class="fakeinput skill_input tc" placeholder="Dados" onfocus="fakefocus()" onblur="fakeblur(this,1)" tabindex="1">'+data.attack[i][1]+'</div></div>';
 content2 +=  '<div class="w3 ma3 dif"><div class="fakeinput skill_input tc" placeholder="Dados" onfocus="fakefocus()" onblur="fakeblur(this,2)" tabindex="2">'+data.attack[i][2]+'</div></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Base</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,11)" required>'+skill_names+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,3)" required>'+skill_habis+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p name="at_skname" class="p_skill">Perícia e hab.</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="+0" value="'+data.attack[i][4]+'" inputmode="numeric" autocomplete="off" onkeyup="regex(this)" onchange="attack_data(this,4)"></div>';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="+0" value="'+data.attack[i][5]+'" inputmode="numeric" autocomplete="off" onkeyup="regexo(this)" onchange="attack_data(this,5)"></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Outro bônus</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><p class="p_skill tc">+0</p></div>';
 content2 +=  '<div class="w3 ma3 dif"><p class="p_skill tc">+0</p></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Condições</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Margem" value="'+data.attack[i][6]+'" inputmode="numeric" autocomplete="off" onkeyup="regexc1(this)" onchange="attack_data(this,6)"></div>';
 content2 +=  '<div class="w3 ma3 dif"><input class="skill_input tc" type="text" placeholder="Multiplicador" value="'+data.attack[i][7]+'" autocomplete="off" onkeyup="regexc2(this)" onchange="attack_data(this,7)"></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Crítico</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,8)" required>'+range+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,9)" required>'+dmg_type+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Alcance e tipo</p></div></div>';

 content2 +=  '<div class="w10 dif">';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,12)" required>'+actions.replace('para ativar','para atacar')+'</select></div>';
 content2 +=  '<div class="w3 ma3 dif"><select class="select skill_input tc" onchange="attack_data(this,13)" required>'+actions.replace('para ativar','para recarregar')+'</select></div>';
 content2 +=  '<div class="w4 ma3 dif"><p class="p_skill">Ação</p></div></div>';

 content2 +=  '<div class="w10 dif"><div class="w10 m3e dif">';
 content2 +=  '<textarea class="skill_input m3e" type="text" placeholder="Poderes aplicados, melhoramentos de arma e outros detalhes" autocomplete="off" onchange="attack_data(this,10)">'+data.attack[i][10]+'</textarea>';
 content2 +=  '</div></div></div>';

 let content = '<div class="w10 dif">';
 content += '<div class="w7 ma" onclick="attack_info(this)"><p class="item_title">Nome do Ataque</p><p class="item_subtitle mt4"></p></div>';
 content += '<div class="w3 dfw">';
 content += '<div class="w5at dif" onclick="weap_roll(this)"><div class="dice dif">'+dices['d20']+'</div><p class="w5 item_title"></p></div>';
 content += '<div class="w5at"></div>';
 content += '</div>';

 content += '</div><div class="w10 attack_info def_hide">'+content2+'</div>';

 div.innerHTML = content;
 div.children[1].children[3].children[0].children[0].value=data.attack[i][11];
 div.children[1].children[3].children[1].children[0].value=data.attack[i][3];
 div.children[1].children[7].children[0].children[0].value=data.attack[i][8];
 div.children[1].children[7].children[1].children[0].value=data.attack[i][9];
 if(data.attack[i][12]){div.children[1].children[8].children[0].children[0].value=data.attack[i][12]}
 if(data.attack[i][13]){div.children[1].children[8].children[1].children[0].value=data.attack[i][13]}
 document.getElementById('char_attack').appendChild(div);
 attack_calc();
}

function attack_add(){
 data.attack.push(['','','','','','','','','','','','',0,0]);
 attack_list(data.attack.length-1);
 save_data();
}

function attack_add_start(){
 data.attack.push(['Espada Montante • Ataque Extra (exemplo)','+0/+0','2d6',1,0,0,19,'x2',1,1,"A seguinte habilidade foi aplicada neste ataque:\n• Ataque Extra (2 PMs): uma ataque adicional por rodada\n\nAs bases de ataque e de dano podem ser escritas de forma simples como '+0' ou '+0/+0' para dois ataques e '2d6', ou, conforme o próximo exemplo de ataque, de forma complexa como '2#2d20kh' para dois ataques rolando dois dados cada e mantendo o maior e '2d6rrb2' para rerolar resultados 1 e 2.",18,4,1]);
 attack_list(data.attack.length-1);
 data.attack.push(['Esp. Montante • Extra Preciso Destruidor (exemplo)','2#2d20kh','2d6rrb2',1,0,0,19,'x2',1,1,"As seguintes habilidades foram aplicadas neste ataque:\n• Ataque Extra (2 PMs): uma ataque adicional por rodada\n• Preciso (1 PM): rola dois dados no ataque e usa o melhor\n• Destruidor: pode rolar novamente quaisquer resultados 1 e 2 na rolagem de dano\n\nAs bases de ataque e de dano podem ser escritas de forma simples como '+0' ou '+0/+0' para dois ataques e '2d6' conforme o exemplo anterior, ou, conforme este exemplo de ataque, de forma complexa como '2#2d20kh' para dois ataques rolando dois dados cada e mantendo o maior e '2d6rrb2' para rerolar resultados 1 e 2.",18,4,1]);
 attack_list(data.attack.length-1);
}

function weap_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e.children[0].value = equip[i][0];
 e = e.parentNode.parentNode;
 e.children[2].children[0].children[0].innerHTML = equip[i][5];
 e.children[2].children[1].children[0].innerHTML = equip[i][6];
 e.children[3].children[0].children[0].value = '';
 e.children[3].children[1].children[0].value = '';
 e.children[6].children[0].children[0].value = equip[i][7];
 e.children[6].children[1].children[0].value = equip[i][8];
 e.children[7].children[0].children[0].value = equip[i][9];
 e.children[7].children[1].children[0].value = equip[i][10];
 e.children[8].children[0].children[0].value = '';
 e.children[8].children[1].children[0].value = '';
 e.children[9].children[0].children[0].value = equip[i][4];

 e = e.parentNode;
 var attacks = document.getElementsByClassName('attack');
 let x = Array.prototype.indexOf.call(attacks,e);

 data.attack[x][0] = equip[i][0];
 data.attack[x][1] = equip[i][5];
 data.attack[x][2] = equip[i][6];
 data.attack[x].splice(6,4,equip[i][7],equip[i][8],equip[i][9],equip[i][10]);

 attack_calc();
 save_data();
}

//-------------------------SKILLS FUNCTIONS------------------------//

function skill_info(e){e.parentNode.parentNode.parentNode.children[1].classList.toggle('skill_hide')}

function train2(i,k){
 var t = data.nível;
 t = t<7?2:t<14?4:6;
 document.getElementById(data[k][i][0]+'_train').innerHTML = '+'+data[k][i][4] * t;
}

function train(e,i,k){
 data[k][i][4] = +!data[k][i][4];
 if(data[k][i][4]){e.children[0].classList.add('markedbox')}
 if(!data[k][i][4]){e.children[0].classList.remove('markedbox')}
 e = e.parentNode.parentNode.parentNode.id;
 calc_skills(k);
 save_data();
}

function skill_outro(e,k){
 if(e.value.indexOf('+')>-1){e.value=e.value.slice(1)}
 data[k][e.getAttribute('skill')][5]=JSON.parse(e.value);
 e.value = add_plus_sign(e.value);
 save_data();
}

var skill_habs = '<option disabled selected></option>';
for(var i=1;i<habs.length;i++){skill_habs += '<option value="'+i+'">'+habs[i]+'</option>'}

function skill_hab(e,k){data[k][e.getAttribute('skill')][e.getAttribute('index')]=JSON.parse(e.value);save_data()}

function list_skills(e,i,k){ //k='skills' or 'crafts'
for (var i=0;i<e.length;i++){
 var div = document.createElement('div');
 div.setAttribute('id',e[i][0]);
 div.setAttribute('index',i);
 div.setAttribute('class','row');

 var content2 = '<div class="row"><div class="skills attack_info mw400">';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><select id="'+e[i][0]+'_hab" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="1">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Habilidade</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><select id="'+e[i][0]+'_hab2" class="select tc" onchange="skill_hab(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="2">'+skill_habs+'</select></div><div class="w5 m0a dif"><p class="p_skill">Hab secundária</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p class="p_skill tac skill_lvl">+0</p></div><div class="w5 m0a dif"><p class="p_skill">1/2 do nível</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_train" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="4">Treinamento</p></div></div>';
 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><input id="'+e[i][0]+'_out" class="skill_input tac" inputmode="numeric" onkeyup="regex(this)" onchange="skill_outro(this,\''+k+'\');calc_skills(\''+k+'\')" skill="'+i+'" index="5" autocomplete="off"></input></div><div class="w5 m0a dif"><p class="p_skill">Outro</p></div></div>';

 content2 += '<div class="w10 dif">';
 if(e[i][6]){content2 += '<div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_penal" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill" index="6">Penalidade</p></div>'}
 content2 += '</div>';

 content2 += '<div class="w10 dif"><div class="w3 m0a mh51 dif"><p id="'+e[i][0]+'_cond" class="p_skill tac">+0</p></div><div class="w5 m0a dif"><p class="p_skill">Condições</p></div></div>';
 content2 += '</div></div>';

 var content = '<div class="row"><div class="container skills">';
 content += '<div class="w2 dif" onclick="train(this,'+i+',\''+k+'\')"><div class="checkbox"></div></div>';
 content += '<div class="w5 dif" onclick="skill_info(this)"><p class="item_title">'+e[i][0];
 content += e[i][3]?'*':'';
 content += e[i][6]?'‡':'';
 content += '</p></div>';
 content += '<div class="w2 dif" onclick="startroll(\''+e[i][0]+'_total\')"><div class="dice dif" data-dice="d20"></div></div>';
 content += '<div class="w1 dif" onclick="startroll(\''+e[i][0]+'_total\')"><p id="'+e[i][0]+'_total" class="item_title skill_tot">+0</p></div>';
 content += '</div></div><div class="skill_info skill_hide">'+content2+'</div>';
 div.innerHTML = content;
 document.getElementById('char_'+k).appendChild(div);

 div.children[1].children[0].children[0].children[0].children[0].children[0].value = data[k][i][1];
}}

const skill_lvl = document.getElementsByClassName('skill_lvl');
function calc_skills(k){
 for(var i=0;i<skill_lvl.length;i++){skill_lvl[i].innerHTML = '+'+Math.floor(JSON.parse(data.nível)/2)}
 for(var i=0;i<data[k].length;i++){
  var e = document.getElementById(data[k][i][0]).children[0].children[0];
  if(data[k][i][3]&&!data[k][i][4]){e.children[2].classList.add('dn');e.children[3].classList.add('dn')}
  else{e.children[2].classList.remove('dn');e.children[3].classList.remove('dn')}
  var total = data['hab_'+habs[data[k][i][1]]] + (data[k][i][2]>0?data['hab_'+habs[data[k][i][2]]]:0) + Math.floor(data.nível/2) + JSON.parse(data[k][i][4])*(data.nível<7?2:data.nível<14?4:6) + JSON.parse(data[k][i][5]) + JSON.parse(data[k][i][6])*(data.defense.armor_penal + data.defense.shield_penal)+data.cond['Perícias (todas)']+data.cond[data[k][i][0]] + data.cond['Armadura (penalidade)'] + data.cond['Escudo (penalidade)'];
  document.getElementById(data[k][i][0]+'_total').innerHTML = add_plus_sign(total);
  e = e.children[0].children[0];
  if(data[k][i][4]&&!e.classList.contains('markedbox')){e.classList.add('markedbox')}
  train2(i,k);
  document.getElementById(data[k][i][0]+"_hab").value = data[k][i][1];
  document.getElementById(data[k][i][0]+"_hab2").value = data[k][i][2];
  document.getElementById(data[k][i][0]+"_out").value = add_plus_sign(data[k][i][5]);
  document.getElementById(data[k][i][0]+"_cond").innerHTML = add_plus_sign(data.cond['Perícias (todas)']+data.cond[data[k][i][0]]);
  if(data[k][i][6]){document.getElementById(data[k][i][0]+"_penal").innerHTML = add_plus_sign(data.defense.armor_penal + data.defense.shield_penal + data.cond['Armadura (penalidade)'] + data.cond['Escudo (penalidade)'])}
 }
 attack_calc();
}

//-------------------------CONDITIONS FUNCTIONS------------------------//

function cond_info(e,array){
 let j = e.classList.contains('cond_user')?1:0;
 let conds = j?'cond_user':'conditions';
 conds = document.getElementsByClassName(conds);
 let i = Array.prototype.indexOf.call(conds,e);
 cond_details(e,j,i,array,1);
}

function cond_details(e,j,i,array,k){
 var q = JSON.stringify(array[i][3]).length>2?'<b>Efeitos:</b> ':'';
 for (var key in array[i][3]){q += key+' '+(array[i][3][key]>0?'+':'')+array[i][3][key]+' • '}

 e.children[0].innerHTML = array[i][0] + (j?'':(array[i][1]?' • '+array[i][1]:''));
 let p = [];
 if(j&&array[i][1]){p.push(array[i][1])}
 if(array[i][4]){p.push(array[i][4]+' PM')}
 if(array[i][5]>1){p.push(action[array[i][5]])}
 if(array[i][6]){p.push(duration[array[i][6]])}
 e.children[1].innerHTML = p.join(' • ');
 e.children[2].innerHTML = (data.conditions[j][i]||!k)?array[i][2]:(e.children[2].innerHTML?'':array[i][2]);
 e.children[3].innerHTML = (data.conditions[j][i]||!k)?q.slice(0,-3):(e.children[3].innerHTML?'':q.slice(0,-3));

 if(j&&k){
  //if(data.conditions[j][i]){e.parentNode.children[2].classList.remove('hid')}
  //else{e.parentNode.children[2].classList.toggle('hid')}
  e = e.parentNode.parentNode.children[1].children[0];
  if(!e.classList.contains('def_hide')){e.classList.add('def_hide')}
 }
}

function cond_change(e,k){
 let value = isNaN(e.value)?boldify(e.value):JSON.parse(e.value);
 e = e.parentNode.parentNode.parentNode.parentNode.parentNode.children[0].children[1];

 let conds = document.getElementsByClassName('cond_user');
 let i = Array.prototype.indexOf.call(conds,e);
 data.cond_user[i][k]=value;
 cond_details(e,1,i,data.cond_user,0);
 save_data();
}

function cond_edit(e){e.parentNode.parentNode.children[1].children[0].classList.toggle('def_hide')}

function toggle_condition(e,array){
 const desloc = document.getElementById('deslocamento').parentNode.children[3];
 e.classList.toggle('condmarked');

 e = e.parentNode.children[1];
 let j = e.classList.contains('cond_user')?1:0;
 let conds = j?'cond_user':'conditions';
 conds = document.getElementsByClassName(conds);
 let i = Array.prototype.indexOf.call(conds,e);

 data.conditions[j][i] =! data.conditions[j][i];
 for (var key in array[i][3]){
  if(key=='Deslocamento'){
   if(data.conditions[j][i]){data.cond[key].push(array[i][3][key])}
   else{data.cond[key].splice(data.cond[key].indexOf(array[i][3][key]),1)}
   if(data.cond[key].length){desloc.innerHTML = '*'+data.cond[key][0].charAt(0).toUpperCase() + data.cond[key].join(', ').slice(1)}
   else{desloc.innerHTML = ''}
  }
  else{data.cond[key] += array[i][3][key]*(data.conditions[j][i]?1:-1)}
  if(key=='Tamanho'){document.getElementById('tamanho').value = JSON.parse(data.tamanho) + data.cond[key]}
  if(key=='Pontos de Vida'||key=='Pontos de Mana'){
   var k = key=='Pontos de Vida'?'hp':'mp';
   data[k] = data.conditions[j][i]?data[k]+array[i][3][key]:(data[k]>data[k+'max']+data.cond[key]?data[k+'max']+data.cond[key]:data[k]);
   document.getElementById(k).innerHTML = data[k];
  }
 }
 cond_info(e,array);
 calc_hab();
}

var actions = '';
for(let i in action){actions += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+action[i]+'</option>'}
var durations = '';
for(let i in duration){durations += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+duration[i]+'</option>'}
var effects = '';
for(let key in cond){effects += '<option value="'+(cond[key]=='disabled'?'" disabled':key+'"')+(key=='Selecione um efeito'?' selected':'')+'>'+key+'</option>'}

function list_conditions(e,i,array){
 j = e=='cond_user'?'data.cond_user':'conditions';

 var div = document.createElement('div');
 div.setAttribute('class','w10 pr ma db');

 var content = '<div class="w10 dif">';
 content += '<div class="w1 condmark" onclick="toggle_condition(this,'+j+')"></div>';
 content += '<div class="w8 '+e+'" onclick="cond_info(this,'+j+')"><p class="item_title">'+array[i][0]+(array[i][1]&&e!='cond_user'?' • '+array[i][1]:'')+'</p>';

 let p = [];
 if(array[i][1]&&e=='cond_user'){p.push(array[i][1])}
 if(array[i][4]){p.push(array[i][4]+' PM')}
 if(array[i][5]>1){p.push(action[array[i][5]])}
 if(array[i][6]){p.push(duration[array[i][6]])}

 content += '<p class="item_subtitle">'+p.join(' • ')+'</p>';
 content += '<p class="item_subtitle"></p><p class="item_subtitle"></p></div>';
 if(e=='cond_user'){
  content += '<div class="w1 ma" onclick="cond_edit(this)"><div class="pencilbox ma"><div class="pencil"></div></div></div></div>';
  content += '<div class="w10">';
  content += '<div class="w10 attack_info def_hide cond_info"><div class="w10 dif">';
  content += '<div class="w8 ma dif"><input class="skill_input m3e" type="text" placeholder="Nome da condição" value="'+(array[i][0]=="Nome da Condição"?'':array[i][0])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="cond_change(this,0)"></div>';
  content += '<div class="w2 ma dif" onclick="cond_remove(this)"><div class="trash"></div></div>';
  content += '</div><div class="w10 dif">';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Tipo de condição" value="'+(array[i][1]=="Tipo de Condição"?'':array[i][1])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="cond_change(this,1)"></div>';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="cond_change(this,5)" required>'+actions+'</select></div>';
  content += '</div><div class="w10 dif">';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="Number" placeholder="Custo em PM" value="'+(array[i][4]=="Custo em"?'':array[i][4])+'" autocomplete="off" onkeyup="regexqte(this)" onchange="cond_change(this,4)"></div>';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="cond_change(this,6)" required>'+durations+'</select></div>';
  content += '</div>';
  content += '<div><div class="w10 m3e dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="cond_change(this,2)">'+(array[i][2]=="Descrição e detalhes"?'':array[i][2])+'</textarea></div></div>';

  content += '<div class="w10 mt tac"><div class="effect_add" onclick="effect_add(this)">+ Adicionar</div><p class="item_title">Efeitos nesta condição:</p></div><div>';
  for(let key in array[i][3]){
   content += '<div class="w10 dif">';
   content += '<div class="w4 m3e"><select class="skill_input m3e" onchange="effect_change(this)" required>'+effects+'</select></div>';
   content += '<div class="w4 m3e"><input class="skill_input m3e" type="number" placeholder="Modificador" autocomplete="off" onkeydown="regexe(event)" onchange="effect_change(this)"></div>';
   content += '<div class="w2 ma dif" onclick="effect_remove(this)"><div class="trash"></div></div>';
   content += '</div>';
  }
  content += '</div></div></div>';
 }
 div.innerHTML = content;
 document.getElementById(e).appendChild(div);

 if(e=='cond_user'){
  e = div.children[1].children[0];
  if(array[i][5]){e.children[1].children[1].children[0].value = array[i][5]}
  if(array[i][6]){e.children[2].children[1].children[0].value = array[i][6]}
  e = e.children[5];
  var j = 0;
  for(let key in array[i][3]){
   e.children[j].children[0].children[0].value = key;
   e.children[j].children[1].children[0].value = array[i][3][key];
   j++;
 }}
}

function cond_create(){
 if(data.cond_user.length){data.cond_user.push(['Nome da Condição','Tipo de Condição','Descrição e detalhes',{},'Custo em',0,0])}
 else{data.cond_user.push(['Forma Selvagem Feroz (exemplo)','Druída','Você pode adquirir a forma de uma criatura selvagem. Você recebe Força +3, Defesa  +2 e uma arma natural que causa 1d8 pontos de dano.',{Força:3,Defesa:2},3,4,7])}
 list_conditions('cond_user',data.cond_user.length-1,data.cond_user);
 save_data();
}

function cond_remove(e){
 e = e.parentNode.parentNode.parentNode.parentNode.children[0].children[1];
 let conds = document.getElementsByClassName('cond_user');
 j = Array.prototype.indexOf.call(conds,e);
 if(data.conditions[1][j]){toggle_condition(e,data.cond_user)}
 data.cond_user.splice(j,1);
 e.parentNode.parentNode.remove();
}

function effect_add(e){
 var div = document.createElement('div');
 div.setAttribute('class','w10 dif');

 content = '<div class="w4 m3e"><select class="skill_input m3e" onchange="effect_change(this)" required>'+effects+'</select></div>';
 content += '<div class="w4 m3e"><input class="skill_input m3e" type="number" placeholder="Modificador" autocomplete="off" onkeydown="regexe(event)" onchange="effect_change(this)"></div>';
 content += '<div class="w2 ma dif" onclick="effect_remove(this)"><div class="trash"></div></div>';

 div.innerHTML = content;
 e.parentNode.parentNode.children[5].appendChild(div);
}

function effect_change(e){
 e = e.parentNode.parentNode.parentNode;
 let i = e.parentNode.parentNode.parentNode.children[0].children[1];
 i = Array.prototype.indexOf.call(document.getElementsByClassName('cond_user'),i);

 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] -= data.cond_user[i][3][key]}} //remove effects from active list
 data.cond_user[i][3] = {}; //clear effects from array
 let selects = e.getElementsByTagName('select');
 for(let k=0;k<selects.length;k++){ //readd effects to array
  let value = selects[k].parentNode.parentNode.children[1].children[0];
  if(selects[k].value=='Deslocamento'){
   value.setAttribute('onkeydown','regex_inj(this)');
   value.setAttribute('type','text');
   value = value.value;
  }else{
   value.setAttribute('onkeydown','regexe(event)');
   if(isNaN(value.value)){value.value=''}
   value.setAttribute('type','number');
   value = value.value.replace('+','');
  }
  if(value){data.cond_user[i][3][selects[k].value] = isNaN(value)?value:JSON.parse(value)}
 }
 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] += data.cond_user[i][3][key]}calc_hab()} //readd effects to active list
 cond_details(e.parentNode.parentNode.parentNode.children[0].children[1],1,i,data.cond_user,0);
}

function effect_remove(e){
 e = e.parentNode;
 let key = e.children[0].children[0].value;
 let i = e.parentNode.parentNode.parentNode.parentNode.children[0].children[1];
 i = Array.prototype.indexOf.call(document.getElementsByClassName('cond_user'),i);

 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] -= data.cond_user[i][3][key]}} //remove effects from active list
 delete data.cond_user[i][3][key];
 let el = e.parentNode;
 e.remove();
 if(data.conditions[1][i]){for(let key in data.cond_user[i][3]){data.cond[key] += data.cond_user[i][3][key]}calc_hab()} //readd effects to active list
 cond_details(el.parentNode.parentNode.parentNode.children[0].children[1],1,i,data.cond_user,0);
}

//-------------------------EQUIP FUNCTIONS------------------------//

var tipo = '<option value="" disabled selected>Tipo de item</option>';
for(var i=0;i<tipo_item.length;i++){tipo += '<option value="'+i+'">'+tipo_item[i]+'</option>'}

var peso = '<option value="" disabled selected>Espaço por unidade</option>';
for(var i=1;i<peso_item.length;i++){
 var str = i>1?((i<5?' de':'') + ' espaço' + (i>5?'s':'')):'';
 peso += '<option value="'+i+'">'+peso_item[i]+str+'</option>'
}

var carga = 0;

function coins(e){
 data.carga[e.id]=JSON.parse(e.value);
 equip_calc();
}

function calc_cap_carga(){
 data.carga.carga_cap = 10 + (data.hab_for>0?2:1)*data.hab_for + (data.equip.flat().includes('Mochila de Aventureiro')?2:0) + (data.equip.flat().includes('Alforge')?10:0);
 document.getElementById('carga_cap').value = data.carga.carga_cap;
 total_value();
}

function total_value(){
 let total = 0;
 data.equip.forEach(function(e){
  let valor = e[3];
  if(isNaN(valor)){
   valor = valor.replaceAll(' ','');

   if(valor.lastIndexOf('.')+3==valor.length){valor = valor.replaceAll(',','')}					//10000.00 	10,000.00
   else if(valor.lastIndexOf(',')+3==valor.length){valor = valor.replaceAll(".","").replaceAll(",",".")}	//10000,00 	10.000,00
   else{valor = valor.replaceAll(".","").replaceAll(",","")}							//10.000 	10,000

   if(valor.includes('TO')){valor = valor.replaceAll('TO','')*10}
   else if(valor.includes('TC')){valor = valor.replaceAll('TC','')/10}
   else{valor = valor.replaceAll('T$','')}
  }
  valor = JSON.parse(valor);
  total += valor * e[0];
 });
 total += data.carga.to*10 + data.carga.ts + data.carga.tc/10;
 document.getElementById('total_value').innerHTML = 'Valor total estimado de tesouro e moedas: T$ '+total.toLocaleString('pt-BR');
}

function calc_peso(qte,w,x){
 let p = peso_item[w];
 if(w==1){p='Não ocupa espaço'}
 if(w==2){p=1/8}
 if(w==3){p=1/4}
 if(w==4){p=1/2}
 
 var result = 'Espaços totais ocupados';
 if(!isNaN(qte*p)){result = qte*p+' espaço'+(qte*p>1?'s':'');data.equip[x][6]=qte*p}
 else{result = p;data.equip[x][6]=0}

 return result;
}

function equip_calc(){
 carga = 0;
 var equips = document.getElementsByClassName('equip');
 for(var i=0;i<data.equip.length;i++){
  e = equips[i].children[0];
  e.children[0].children[0].innerHTML = data.equip[i][1]?data.equip[i][1]:'Nome do item';
  e.children[0].children[1].innerHTML = (data.equip[i][2]>=0?tipo_item[data.equip[i][2]]:'Tipo de item')+' • '+(data.equip[i][3]?data.equip[i][3]:'Valor do item')+' • '+(data.equip[i][4]?calc_peso(data.equip[i][0],data.equip[i][4],i):'Espaços totais ocupados');
  carga += isNaN(data.equip[i][6])?0:data.equip[i][6];
 }
 carga += (data.carga.to + data.carga.ts + data.carga.tc)/1000;
 data.carga.carga = carga;
 document.getElementById('carga').innerHTML = carga.toLocaleString('pt-BR');
 document.getElementById('to').value = data.carga.to;
 document.getElementById('ts').value = data.carga.ts;
 document.getElementById('tc').value = data.carga.tc;

 calc_cap_carga();

 let sobrecarga = document.getElementById('conditions').children[31].children[0].children[0];
 if(data.carga.carga>data.carga.carga_cap){
  document.getElementById('carga').classList.add('overloaded');
  if(!data.conditions[0][31]){toggle_condition(sobrecarga,conditions)}  //activate condition 31
 }else{
  document.getElementById('carga').classList.remove('overloaded');
  if(data.conditions[0][31]){toggle_condition(sobrecarga,conditions)}  //deactivate condition 31
 }

 if(data.carga.carga>2*data.carga.carga_cap){document.getElementById('equip_add').disabled = true}
 else{document.getElementById('equip_add').disabled = false}

 save_data()
}

function equip_data(e,i){
 var el = e.parentNode.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,el);
 data.equip[x][i]=(e.value==''?'':(!isNaN(e.value)?JSON.parse(e.value):e.value));
 equip_calc();
}

function qte_change(e,v,k){
 var el = e.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,el);

 el = el.children[0].children[1].children[2].children[0];
 v += ((el.value==''||el.value==null)?0:JSON.parse(el.value));
 if(v==0&&k){e.classList.add('dn');e.parentNode.children[0].classList.remove('dn')}
 else{e.parentNode.children[1].classList.remove('dn');e.parentNode.children[0].classList.add('dn')}
 data.equip[x][0]=v;
 el.value = v;
 equip_calc();
}

function equip_remov(e){
 e = e.parentNode.parentNode.parentNode;
 var equips = document.getElementsByClassName('equip');
 var x = Array.prototype.indexOf.call(equips,e);
 e.remove();
 data.equip.splice(x,1);
 equip_calc();
}

function equip_add(qte,title,type,cost,weight,desc){
 var div = document.createElement('div');
 div.setAttribute('class','w10 equip');

 var content = '<div class="w10 dif">';
 content += '<div class="w7 ma" onclick="attack_info(this)"><p class="item_title">Nome do item</p><p class="item_subtitle">Tipo de item • Valor do item • Espaços totais ocupados</p></div>';
 content += '<div class="w3 equip_btns dif"><div class="third fakebtn equip_btn df m0 dn" onclick="equip_remov(this)"><div class="trash" style="transform:translateY(2px)"></div></div><button class="third equip_btn m0" onclick="qte_change(this,-1,1)">-</button><div class="third equip_btn mwu df"><input class="skill_input mwu tc" type="number" placeholder="Un." value="'+qte+'" autocomplete="off" onkeyup="regexqte(this)" onchange="equip_data(this,0)"></div><button class="third equip_btn m0" onclick="qte_change(this,1,0)">+</button></div>';
 content += '</div><div class="w10 attack_info def_hide">';
 content += '<div class="w10 dif">';
 content += '<div class="w7 ma pr df"><input class="skill_input m3e" type="text" placeholder="Nome do item" value="'+title+'" autocomplete="off" onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,0)" onchange="equip_data(this,1)"></div>';
 content += '<div class="w3 ma df"><input class="skill_input m3e" type="text" placeholder="Valor do item" value="'+cost+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="equip_data(this,3)"></div>';
 content += '</div>';
 content += '<div class="w10 dif">';
 content += '<div class="w5 ma df"><select class="skill_input m3e" autocomplete="off" onchange="equip_data(this,2)" required>'+tipo+'</select></div>';
 content += '<div class="w5 ma df"><select class="skill_input m3e" autocomplete="off" onchange="equip_data(this,4)" required>'+peso+'</select></div>';
 content += '</div>';
 content += '<div><div class="w10 dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="equip_data(this,5)">'+desc+'</textarea></div></div>';
 content += '</div>';

 div.innerHTML = content;
 document.getElementById('char_equip').appendChild(div);
 if(title==''){data.equip.push([qte,,,,,,])}
 else{
  div.children[1].children[1].children[0].children[0].value=type;
  div.children[1].children[1].children[1].children[0].value=weight
 }
}

function equip_kit(){
 for(var i=0;i<kit.length;i++){
  data.equip.push(equip[kit[i]].slice(0,5));
  data.equip[i].unshift(1);
  equip_add(1,data.equip[i][1],data.equip[i][2],data.equip[i][3],data.equip[i][4],data.equip[i][5]);
  equip_calc()
 }
 print_out('Rolagem de moedas (T$) iniciais:');data.carga['ts']=diceroll('4d6');document.getElementById('ts').value=data.carga['ts'];
}

function equip_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode.parentNode;
 e.children[0].children[0].children[0].value = equip[i][0];
 e.children[0].children[1].children[0].value = equip[i][2];
 e.children[1].children[0].children[0].value = equip[i][1];
 e.children[1].children[1].children[0].value = equip[i][3];
 e.children[2].children[0].children[0].innerHTML = equip[i][4];

 e = e.parentNode;
 let equips = document.getElementsByClassName('equip');
 let x = Array.prototype.indexOf.call(equips,e);
 
 data.equip[x] = equip[i].slice(0,5);
 data.equip[x].unshift(JSON.parse(e.children[0].children[1].children[2].children[0].value));

 equip_calc();
}

//-------------------------WEB WORKER FUNCTIONS------------------------//

function testWorker(){
 try{
  let url = '/js/worker_tester.js';
  let worker = new Worker(url);
  worker.terminate();
  URL.revokeObjectURL(url);
  return true;
 }
 catch(e){return false}
}

function populate(sup){
 if(sup&&window.Worker&&typeof(Worker)!=="undefined"){
  console.log('Web worker: populating all powers and spells');
  let powwok = new Worker("./js/worker_power.js");
  powwok.postMessage([powers,power_typ,magic,action,spell_action]);
  powwok.addEventListener('message',(ev) => {
   document.getElementById('all_powers').innerHTML = ev.data[0];
   powers_viz = ev.data[1];
  });
  let spewok = new Worker("./js/worker_spell.js");
  spewok.postMessage([spells,spell_pm_cost,spell_action]);
  spewok.addEventListener('message',(ev) => {
   document.getElementById('all_spells').innerHTML = ev.data[0];
   spell_viz = ev.data[1];
  });
 }else{
  console.log('Main thread: populating all powers and spells');
  for (var i=0;i<powers.length;i++){list_powers('all_powers',i,powers)}
  for (var i=0;i<spells.length;i++){list_spells('all_spells',i)}
 }
}

var list = [];
function create_lists(sup){
 if(sup&&window.Worker&&typeof(Worker)!=="undefined"){
  console.log("Web worker: creating lists");
  let worker = new Worker("./js/worker_list.js");
  worker.postMessage([[equip,equip,equip,powers,spells,equip],[0,armor_start,weap_start,0,0,shield_start],[equip.length,armor_end,weap_end,powers.length,spells.length,shield_end]]);
  worker.addEventListener('message',(ev) => {
   for(let j=0;j<ev.data.length;j++){
    list[j] = document.createElement('div');
    list[j].setAttribute('class','dropequip');
    list[j].innerHTML = ev.data[j];
   }
  });
 }else{
  console.log("Main thread: creating lists");
  list = worker_list([equip,equip,equip,powers,spells],[0,armor_start,weap_start,0,0],[equip.length,armor_end,weap_end,powers.length,spells.length]);
  for(let j=0;j<list.length;j++){
   let div = document.createElement('div');
   div.setAttribute('class','dropequip');
   div.innerHTML = list[j];
   list[j] = div;
  }
 }
}


//-------------------------RICH TEXT FUNCTIONS------------------------//

function boldify(str){
 let indexes = [...str.matchAll(/_/g)].map(match => match.index);
 for(let i=indexes.length-1;i>-1;i--){
  if(i%2==0){str = str.substring(0,indexes[i]) + '<i>' + str.substring(indexes[i]+1)}
  else{str = str.substring(0,indexes[i]) + '</i>' + str.substring(indexes[i]+1)}
 }
 indexes = [...str.matchAll(/\*/g)].map(match => match.index);
 for(let i=indexes.length-1;i>-1;i--){
  if(i%2==0){str = str.substring(0,indexes[i]) + '<b>' + str.substring(indexes[i]+1)}
  else{str = str.substring(0,indexes[i]) + '</b>' + str.substring(indexes[i]+1)}
 }
 return str.replaceAll('</table>\n','</table><p class="nowrap ms">').replaceAll('\n','<br>');
}
function unboldify(str){return isNaN(str)?str.replaceAll(/<br>|<\/br>/gi,'\n').replaceAll(/<i>|<\/i>/gi,'_').replaceAll(/<b>|<\/b>/gi,'*').replaceAll(/<\/?p[^>]*>/gi,'\n'):str}


//-------------------------LISTS FUNCTIONS------------------------//

var prev_focus;
function list_move(e,ev,i){
 if(prev_focus!=e){
  prev_focus=e;
  e.parentNode.appendChild(list[i]);
  let a = e.parentNode.children[1].getElementsByTagName("a");
  for(var i=0;i<a.length;i++){a[i].style.display=""}
  filter(e);
 }
}

function list_remove(e,ev){
 let k = (e.id=="armor"||e.id=="shield")?2:1;
 e = e.parentNode.children[k];
 if(!ev.target.parentNode.contains(ev.relatedTarget)&&e){e.remove()}
 prev_focus = null;
}


async function filter(e){
 let k = (e.id=="armor"||e.id=="shield"||e.id=="char")?2:1;
 let filter = e.value.toUpperCase();
 let a = e.parentNode.children[k].getElementsByTagName("a");
 for(let i=0;i<a.length;i++){
  txtValue = a[i].textContent || a[i].innerText;
  txtValue.replaceAll('<b>','').replaceAll('</b>','');
  if(txtValue.toUpperCase().indexOf(filter)>-1){
   let result = [...txtValue.matchAll(new RegExp(filter,'gi'))].map(z => z.index);
   txtValue = txtValue.split('');
   let j=result.length;
   for(;j>0;){j--;txtValue.splice(result[j]+filter.length,0,'</b>');txtValue.splice(result[j],0,'<b>')}
   a[i].innerHTML = txtValue.join('');
   a[i].style.display="";
  }
  else{a[i].style.display="none"}
 }
}

//-------------------------CALCULATION FUNCTIONS------------------------//

function add_plus_sign(v){v=v<0?v:'+'+v;return v}
function calc_hab(){
 const hab = document.getElementsByClassName('hab');
 for (let i=0;i<hab.length;i++){
  var value = Math.floor((hab[i].value-10)/2);
  var e = hab[i].parentNode.parentNode.parentNode.children[3].children[0];
  value = value + data.cond[habis[habs.indexOf(e.id.substring(4).toLowerCase())]];
  e.innerHTML = add_plus_sign(value);
  data[e.id] = JSON.parse(value);
 }
 calc();
}
function calc_spell_res(){
 var value = 10 + Math.floor(JSON.parse(data.nível)/2) + JSON.parse(data['hab_'+habs[data.spell_hab]]) + data.cond['CD Magias'];
 document.getElementById('spell_res').innerHTML = value;
 data.spell_res=value;
 save_data()
}
function calc(){def_calc();rd_calc();calc_skills('skills');calc_skills('crafts');calc_spell_res();calc_cap_carga()}	//

//-------------------------USER DEFINED POWERS FUNCTIONS------------------------//

function user_power(){
 data.user_powers.push(['Nome do poder',0,'',0,'',0,0,'Descrição e detalhes'])
 list_powers('user_powers',data.user_powers.length-1,data.user_powers);
 save_data();
}

function edit_power(e){
 event.stopPropagation();
 e = e.parentNode.parentNode;
 if(!e.children[1].innerHTML){power_info(e,'user_powers',data.user_powers)}
 e = e.parentNode.children[1].children[0];
 e.classList.toggle('def_hide');
}

function change_power(e,i){
 let value = e.value;
 e = e.parentNode.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_powers').getElementsByClassName('user_powers'),e)
 data.user_powers[x][i] = boldify(value);
 calc_power(e,x)
}

function power_magic(e){
 e.classList.toggle('checkmarked');
 e = e.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_powers').getElementsByClassName('user_powers'),e)
 data.user_powers[x][5] = !data.user_powers[x][5];
 calc_power(e,x)
}

function calc_power(e,i){
 e.children[0].children[0].children[0].children[0].innerHTML = data.user_powers[i][0];
 e.children[0].children[0].children[0].children[1].innerHTML = data.user_powers[i][5]?magic:'';

 let p = [];
 p.push(power_typ[data.user_powers[i][1]])
 if(data.user_powers[i][2]){p.push(data.user_powers[i][2])}
 if(data.user_powers[i][4]){p.push(data.user_powers[i][4])}

 e.children[0].children[0].children[0].children[2].innerHTML = p.join(' • ');
 let ac = data.user_powers[i][3]?action[data.user_powers[i][3]].replace('Ação ','').replace('de ','').toLowerCase():'';
 e.children[0].children[0].children[1].innerHTML = spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'';
 e.children[0].children[1].children[0].innerHTML = data.user_powers[i][7];
 save_data();
}

function feat_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode.parentNode;
 e.children[0].children[0].children[0].value = unboldify(powers[i][0]);		//nome
 e.children[1].children[0].children[0].value = powers[i][1];			//tipo (select)
 e.children[1].children[1].children[0].value = unboldify(powers[i][2]);		//categoria
 e.children[2].children[0].children[0].value = powers[i][3]?powers[i][3]+1:1;	//ação (select)
 e.children[2].children[1].children[0].value = unboldify(powers[i][4]);		//subcategoria
 e.children[3].children[0].children[0].value = unboldify(powers[i][7]);		//desc (text area)
 if(powers[i][5]){e.children[4].children[0].classList.add('checkmarked')}	//magic?
 else{e.children[4].children[0].classList.remove('checkmarked')}

 e = e.parentNode.parentNode;
 let user_powers = document.getElementsByClassName('user_powers');
 let x = Array.prototype.indexOf.call(user_powers,e);
 
 data.user_powers[x] = powers[i];
 data.user_powers[x][6] = 'Editado de '+data.user_powers[x][6];
 calc_power(e,x);
}

var power_types = '';
for(let i in power_typ){power_types += '<option value="'+(i>0?i+'"':'" disabled selected')+'>'+power_typ[i]+'</option>'}

//-------------------------POWERS FUNCTIONS------------------------//

data.powers = [];
var powers_viz = [];

function list_powers(e,i,arr){
 var div = document.createElement('div');
 document.getElementById(e).appendChild(div);
 e = e.replace('all_','');
 let k = (e=='user_powers'?'data.':'')+e;
 div.setAttribute('class',e+' w10');

 let p = [];
 p.push(power_typ[arr[i][1]]);
 if(arr[i][2]){p.push(arr[i][2])}else if(e=='user_powers'){p.push('Categoria')}
 if(arr[i][4]){p.push(arr[i][4])}else if(e=='user_powers'){p.push('Subcategoria')}

 let content = '<div class="spell_details" onclick="power_info(this,\''+e+'\','+k+')"><div class="w10 dif"><div class="w'+(e=='user_powers'?8:9)+'">';
 content += '<p class="item_title">'+arr[i][0]+'</p><div class="magic">'+(arr[i][5]?magic:'')+'</div>';
 content += '<p class="item_subtitle">'+p.join(' • ')+'</p>';
 content += arr[i][8]?'<p class="item_subtitle"><b>Pré-requisito:</b> '+arr[i][8]+'</p>':'';
 content += '</div>';
 let ac = arr[i][3]?action[arr[i][3]].replace('Ação ','').replace('de ','').toLowerCase():'';
 content += '<div class="item_action w1 ma">'+(spell_action.includes(ac)?'<div class="ac_'+ac+'"></div>':'')+'</div>';
 content += e=='user_powers'?'<div class="w1 ma powe" onclick="edit_power(this)"><div class="pencilbox ma"><div class="pencil"></div></div></div>':'';
 content += '</div><div class="item_subtitle w10 pr ms"></div></div>';

 if(!e.includes('user')){div.setAttribute('index',i);powers_viz.push([1,1,1])}
 else{
  content += '<div class="w10 mt1"><div class="w10 attack_info cond_info def_hide">';
  content += '<div class="w10 dif">';
  content += '<div class="w8 pr ma dif"><input class="skill_input m3e" type="text" placeholder="Nome do poder" value="'+(arr[i][0]=='Nome do poder'?'':arr[i][0])+'" autocomplete="off"  onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,3)" onchange="change_power(this,0)"></div>';
  content += '<div class="w2 ma dif" onclick="remove_power(this,\''+e+'\')"><div class="trash"></div></div>'
  content += '</div>';

  content += '<div class="w10 dif">';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_power(this,1)" required>'+power_types+'</select></div>';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Categoria" value="'+(arr[i][2]=='Categoria'?'':arr[i][2])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_power(this,2)"></div>';
  content += '</div>';

  content += '<div class="w10 dif">';
  content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_power(this,3)" required>'+actions+'</select></div>';
  content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Subcategoria" value="'+(arr[i][4]=='Subcategoria'?'':arr[i][4])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_power(this,4)"></div>';
  content += '</div>';

  content += '<div><div class="w10 dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="change_power(this,7)">'+(arr[i][7]=='Descrição e detalhes'?'':arr[i][7])+'</textarea></div></div>';
  content += '<div class="w10 dif pr"><a class="checkmark a_power" onclick="power_magic(this)">Marque se essa habilidade for mágica</a></div>';

  content += '</div></div>';
 }
 div.innerHTML = content;

 if(e.includes('user')&&arr[i][0]!='Nome do poder'){
  if(arr[i][1]){div.children[1].children[0].children[1].children[0].children[0].value = arr[i][1]}
  if(arr[i][3]){div.children[1].children[0].children[2].children[0].children[0].value = arr[i][3]}
  if(arr[i][5]){div.children[1].children[0].children[4].children[0].classList.add('checkmarked')}
 }
}

function power_info(e,id,arr){
 e = e.parentNode;
 let k = id=='user_powers'?0:1;
 let i = k?e.getAttribute('index'):Array.prototype.indexOf.call(document.getElementById(id).getElementsByClassName(id),e);

 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(e.innerHTML){
  e.innerHTML = '';
  if(!k){e.parentNode.parentNode.children[1].children[0].classList.add('def_hide')}
 } else {
  var content = '<p class="nowrap">'+arr[i][7]+'</p>';
  if(k){
   content += '<p class="nowrap"><i>Publicação:</i> '+arr[i][6]+'</p><button class="spell_add" onclick="add_power(this)">Adicionar poder</button>';
   content += '<button class="delete spell_delete" onclick="remove_power(this,\''+id+'\')">Remover poder</button>';
  }
  e.innerHTML = content
 }
}

function add_power(e){
 e = e.parentNode.parentNode.parentNode.cloneNode(true);
 e.classList.remove('more_info');
 e.children[0].children[1].innerHTML = '';
 document.getElementById('powers').appendChild(e);
 data.powers.push(JSON.parse(e.getAttribute('index')));
 save_data();
}

function remove_power(e,id){
 e = e.parentNode.parentNode.parentNode;
 if(id=='user_powers'){e = e.parentNode}
 let pows = document.getElementById(id).getElementsByClassName(id);
 let x = Array.prototype.indexOf.call(pows,e);
 data[id].splice(x,1);
 e.remove();
 save_data();
}

function filter_powers(){
 let e = document.getElementById('all_powers').getElementsByClassName('powers');
 for (var i=0;i<powers.length;i++){
  if(powers_viz[i][0]&&powers_viz[i][1]&&powers_viz[i][2]){e[i].style.display=""}
  else{e[i].style.display="none"}
 }
}

function filter_powers_other(e){
 let k = e.getAttribute('tabindex');
 let filter;

 if(k==1){
  filter = e.innerHTML.split(', ');
  for(let i in filter){filter[i]=power_typ.indexOf(filter[i])}
 }else{
  filter = e.innerHTML;
 }

 if(!filter||filter[0]<0){filter=[1,2,3,4,5]+JSON.stringify(power_cat)}

 for (var i=0;i<powers.length;i++){
  if(filter.indexOf(powers[i][k])>-1){powers_viz[i][k]=1}
  else{powers_viz[i][k]=0}
 }
 filter_powers();
}

function filter_powers_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<powers.length;i++){
  var powername = powers[i][0].toUpperCase();
  if(powername.indexOf(filter)>-1){powers_viz[i][0]=1}
  else{powers_viz[i][0]=0}
 }
 filter_powers();
}

function clear_powers_filters(){
 let e = document.getElementById('all_powers').getElementsByClassName('more_info');
 while(e.length){
  e[0].children[0].children[1].innerHTML = '';
  e[0].classList.remove('more_info');
 }

 for (var i=0;i<powers.length;i++){powers_viz[i]=[1,1,1]}
 cpower_type=[],cpower_cat=[];

 e = document.getElementById('power_type');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('power_cat');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('power_name');e.value='';
 filter_powers_name(e);
}

//-------------------------USERS SPELLS FUNCTIONS------------------------//

function user_spell(e){
 data.user_spells.push(['Nome da magia','Classificação','Nível','Escola','Ação para lançar','Alcance','Duração','Alvo','Área','Resistência','Efeito','Descrição','','Truque','Truque Desc',0,'+0 PM desc',1,'+1 PM desc']); //+add,mod
 list_user_spell(data.user_spells.length-1);
 save_data();
}

function user_spell_info(e){
 e = e.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_spells').getElementsByClassName('spells'),e);
 db_spell_info(e,x,data.user_spells,0);
}

let spell_classs = '<option value="" disabled selected>Classificação</option>';
for(let i=1;i<spell_class.length;i++){spell_classs += '<option value="'+spell_class[i]+'">'+spell_class[i]+'</option>'}
let spell_schools = '<option value="" disabled selected>Escola</option>';
for(let i=1;i<spell_school.length;i++){spell_schools += '<option value="'+spell_school[i]+'">'+spell_school[i]+'</option>'}
let spell_levels = '<option value="" disabled selected>Nível</option>';
for(let i=1;i<spell_level.length;i++){spell_levels += '<option value="'+spell_level[i]+'">Nível '+spell_level[i]+'</option>'}
let pm_add = '<option value="" disabled selected>Modificador</option><option value="Truque">Truque</option>';
for(let i=0;i<16;i++){pm_add += '<option value="'+i+'">+'+i+' PM'+(i>1?'s':'')+'</option>'}
let spell_actions = '';
for(let i in action){spell_actions += '<option value="'+(i>0?action[i].replace('Ação ','').replace('de ','').toLowerCase()+'"':'" disabled selected')+'>'+action[i]+'</option>'}
spell_actions += '<option value="Outro">Outro (escrever)</option>';
spell_actions = spell_actions.replaceAll('ativar','lançar');

function list_user_spell(i){
 let div = document.createElement('div');
 document.getElementById('user_spells').appendChild(div);

 div.setAttribute('class','spells w10');
 var content = '<div class="spell_details" onclick="user_spell_info(this)"><div class="w10 dif"><div class="w8"><p class="item_title">'+data.user_spells[i][0]+'</p><p class="item_subtitle">'+(data.user_spells[i][2]!='Nível'?spell_pm_cost[data.user_spells[i][2]-1]:'Custo em')+' PM • '+data.user_spells[i][1]+' • '+data.user_spells[i][3]+' '+data.user_spells[i][2]+'</p></div><div class="item_action w1 ma">';
 if(spell_action.includes(data.user_spells[i][4])){content += '<div class="ac_'+data.user_spells[i][4]+'"></div>'}
 content += '</div>';
 content += '<div class="w1 ma powe" onclick="edit_spell(this)"><div class="pencilbox ma"><div class="pencil"></div></div></div>';
 content += '</div><div class="item_subtitle w10 ms"></div>';
 content += '</div>';

 content += '<div class="w10 mt1"><div class="w10 attack_info cond_info def_hide">';
 content += '<div class="w10 dif">';
 content += '<div class="w8 pr ma dif"><input class="skill_input m3e" type="text" placeholder="Nome da magia" value="'+(data.user_spells[i][0]=='Nome da magia'?'':data.user_spells[i][0])+'" autocomplete="off"  onkeyup="regex_inj(this);filter(this)" onblur="list_remove(this,event)" onfocus="list_move(this,event,4)" onchange="change_spell(this,0)"></div>';
 content += '<div class="w2 ma dif" onclick="remove_spell(this,\''+e+'\')"><div class="trash"></div></div>'
 content += '</div>';

 content += '<div class="w10 dif">';
 content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_spell(this,1)" required>'+spell_classs+'</select></div>';
 content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_spell(this,2)" required>'+spell_levels+'</select></div>';
 content += '</div>';

 content += '<div class="w10 dif">';
 content += '<div class="w5 ma dif"><select class="skill_input m3e" onchange="change_spell(this,3)" required>'+spell_schools+'</select></div>';
 content += '<div class="w5 ma dif">';
 content += '<select class="skill_input m3e" onchange="spell_mod_outro(this);change_spell(this,4)" required>'+spell_actions+'</select>';
 content += '<input class="skill_input m3e dn" type="text" placeholder="Outro (escreva \'voltar\' para voltar)" value="'+(data.user_spells[i][4]=='Ação para lançar'?'':data.user_spells[i][4])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="spell_mod_outro(this);change_spell(this,4)">';
 content += '</div></div>';

 content += '<div class="w10 dif">';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Alvo" value="'+(data.user_spells[i][7]=='Alvo'?'':data.user_spells[i][7])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,7)"></div>';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Alcance" value="'+(data.user_spells[i][5]=='Alcance'?'':data.user_spells[i][5])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,5)"></div>';
 content += '</div>';

 content += '<div class="w10 dif">';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Área" value="'+(data.user_spells[i][8]=='Área'?'':data.user_spells[i][8])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,8)"></div>';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Efeito" value="'+(data.user_spells[i][10]=='Efeito'?'':data.user_spells[i][10])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,10)"></div>';
 content += '</div>';

 content += '<div class="w10 dif">';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Duração" value="'+(data.user_spells[i][6]=='Duração'?'':data.user_spells[i][6])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,6)"></div>';
 content += '<div class="w5 ma dif"><input class="skill_input m3e" type="text" placeholder="Resistência" value="'+(data.user_spells[i][9]=='Resistência'?'':data.user_spells[i][9])+'" autocomplete="off" onkeyup="regex_inj(this)" onchange="change_spell(this,9)"></div>';
 content += '</div>';

 content += '<div><div class="w10 dif"><textarea class="skill_input m3e" type="text" placeholder="Descrição e detalhes" autocomplete="off" onchange="change_spell(this,11)">'+(data.user_spells[i][11]=='Descrição'?'':data.user_spells[i][11])+'</textarea></div></div>';

 content += '<div class="w10 mt tac"><div class="effect_add" onclick="spell_mod_add(this)">+ Adicionar</div><p class="item_title">Aprimoramentos nesta magia:</p></div><div>';

 for(let j=13;j<data.user_spells[i].length;j+=2){
  content += '<div class="w10 dif">';
  content += '<div class="w2 m3e"><select class="skill_input m3e" onchange="spell_mod_change(this)" required>'+pm_add+'</select></div>';
  content += '<div class="w7 m3e"><textarea class="skill_input m3e" type="text" placeholder="Descrição do aprimoramento" autocomplete="off" onkeydown="regex_inj(event)" onchange="spell_mod_change(this)">'+data.user_spells[i][j+1]+'</textarea></div>';
  content += '<div class="w1 ma dif" onclick="spell_mod_remove(this)"><div class="trash"></div></div>';
  content += '</div>';
 }

 content += '</div></div>';
 div.innerHTML = content;

 let selects = div.getElementsByTagName('select');
 if(data.user_spells[i][1]!='Classificação'){selects[0].value = data.user_spells[i][1]}
 if(data.user_spells[i][2]!='Nível'){selects[1].value = data.user_spells[i][2]}
 if(data.user_spells[i][3]!='Escola'){selects[2].value = data.user_spells[i][3]}
 if(data.user_spells[i][4]!='Ação para lançar'){selects[3].value = data.user_spells[i][4]}
 let k = 13;
 for(let j=4;j<selects.length;j++){
  if(data.user_spells[i][k]!='Modificador'){selects[j].value = data.user_spells[i][k]}
  k+=2;
 }
}

function spell_mod_outro(e){
 if(e.value=='Outro'){
  e.classList.add('dn');
  e.parentNode.children[1].classList.remove('dn');
 }
 if(e.value=="Voltar"||e.value=="voltar"){
  e.value = 'nenhuma ação';
  e.classList.add('dn');
  e.parentNode.children[0].classList.remove('dn');
 }
}

function spell_mod_add(e,i=0,j=0){
 let content = '<div class="w10 dif">';
 content += '<div class="w2 m3e"><select class="skill_input m3e" onchange="spell_mod_change(this)" required>'+pm_add+'</select></div>';
 content += '<div class="w7 m3e"><textarea class="skill_input m3e" type="text" placeholder="Descrição do aprimoramento" autocomplete="off" onkeydown="regex_inj(event)" onchange="spell_mod_change(this)">'+(j?spells[i][j+1]:'')+'</textarea></div>';
 content += '<div class="w1 ma dif" onclick="spell_mod_remove(this)"><div class="trash"></div></div>';
 content += '</div>';
 let div = document.createElement('div');
 div.innerHTML = content;
 if(j){div.children[0].children[0].children[0].value = spells[i][j]}
 e.parentNode.parentNode.appendChild(div);
}

function spell_mod_change(e){
 let el = e.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_spells').getElementsByClassName('spells'),el);
 let inputs = el.querySelectorAll('input,select,textarea');
 let j = [...inputs].indexOf(e);
 data.user_spells[x][j] = boldify(e.value);
 calc_spell(el,x);
}

function spell_mod_remove(e){
 let el = e.parentNode.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_spells').getElementsByClassName('spells'),el);
 let inputs = el.querySelectorAll('input,select,textarea');
 let j = [...inputs].indexOf(e.parentNode.children[0].children[0]);
 data.user_spells[x].splice(j,1);
 data.user_spells[x].splice(j,1);
 e.parentNode.remove();
 save_data();
}

let spell_indexes = [0,1,2,3,4,4,7,5,8,10,6,9,11];
function spell_choose(e,i){
 e = e.parentNode.parentNode;
 e.children[1].remove(); //remove dropdown
 prev_focus = null;

 e = e.parentNode.parentNode;
 while(e.children[8]){e.children[8].remove()}

 let inputs = e.querySelectorAll('input,select,textarea');
 for(let j=0;j<13;j++){inputs[j].value = unboldify(spells[i][spell_indexes[j]])}
 for(let j=13;j<spells[i].length;j+=2){spell_mod_add(e.children[7].children[0],i,j)}

 e = e.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_spells').getElementsByClassName('spells'),e);

 data.user_spells[x] = spells[i];
 data.user_spells[x][12] = 'Editado de '+spells[x][12];
 calc_spell(e,x);
}

function edit_spell(e){
 event.stopPropagation();
 e = e.parentNode.parentNode;
 if(!e.children[1].innerHTML){user_spell_info(e)}
 e = e.parentNode.children[1].children[0];
 e.classList.toggle('def_hide');
}

function change_spell(e,i){
 let value = e.value;
 e = e.parentNode.parentNode.parentNode.parentNode.parentNode;
 let x = Array.prototype.indexOf.call(document.getElementById('user_spells').getElementsByClassName('spells'),e)
 data.user_spells[x][i] = boldify(value);
 calc_spell(e,x)
}

function calc_spell(e,i){
 e = e.children[0];
 e.children[0].children[0].children[0].innerHTML = data.user_spells[i][0];
 let p = [];
 if(data.user_spells[i][2]){p.push(data.user_spells[i][2]=='Nível'?'Custo em PM':spell_pm_cost[data.user_spells[i][2]-1]+' PM')}
 if(data.user_spells[i][1]){p.push(data.user_spells[i][1])}
 if(data.user_spells[i][2]||data.user_spells[i][3]){p.push(data.user_spells[i][3]+' '+data.user_spells[i][2])}
 e.children[0].children[0].children[1].innerHTML = p.join(' • ');

 e.children[0].children[1].innerHTML = spell_action.includes(data.user_spells[i][4])?'<div class="ac_'+data.user_spells[i][4]+'"></div>':'';

 e.children[1].innerHTML = spell_details(i,data.user_spells);
 save_data();
}


//-------------------------SPELLS FUNCTIONS------------------------//

data.magias = [];
var spell_viz = [];
function list_spells(e,i){
 var div = document.createElement('div');
 document.getElementById(e).appendChild(div);
 e = e.replace('all_','');

 div.setAttribute('class',e+' w10');
 div.setAttribute('onclick','spell_info(this)');
 div.setAttribute('index',i);
 var content = '<div class="spell_details"><div class="w10 dif"><div class="w9"><p class="item_title">'+spells[i][0]+'</p><p class="item_subtitle">'+spell_pm_cost[spells[i][2]-1]+' PM • '+spells[i][1]+' • '+spells[i][3]+' '+spells[i][2]+'</p></div><div class="item_action w1 ma">';
 if(spell_action.includes(spells[i][4])){content += '<div class="ac_'+spells[i][4]+'"></div>'}
 content += '</div></div><div class="item_subtitle w10 ms"></div></div>';
 div.innerHTML = content;
 spell_viz.push([1,1,1,1]);
}

function spell_info(e){db_spell_info(e,e.getAttribute('index'),spells,1)}

function spell_details(i,arr){
 let content = '';
 if(arr[i][4]){content += '<p class="nowrap"><b>Ação:</b> '+arr[i][4]+'</p>'} //!spell_action.includes(arr[i][4])
 if(arr[i][5]){content += '<p class="nowrap"><b>Alcance:</b> '+arr[i][5]+'</p>'}
 if(arr[i][7]){content += '<p class="nowrap"><b>Alvo:</b> '+arr[i][7]+'</p>'}
 if(arr[i][8]){content += '<p class="nowrap"><b>Área:</b> '+arr[i][8]+'</p>'}
 if(arr[i][10]){content += '<p class="nowrap"><b>Efeito:</b> '+arr[i][10]+'</p>'}
 if(arr[i][6]){content += '<p class="nowrap"><b>Duração:</b> '+arr[i][6]+'</p>'}
 if(arr[i][9]){content += '<p class="nowrap"><b>Resistência:</b> '+arr[i][9]+'</p>'}

 content += '<p class="nowrap ms">'+arr[i][11]+'</p>';
 var length = arr[i].length;
 for (var j=13;j<length;j+=2){
  content += '<p class="nowrap ms"><b>';
  content += isNaN(arr[i][j])?arr[i][j]:('+'+arr[i][j]+' PM');
  content += ': </b><span>'+arr[i][j+1]+'</span></p>';
 }
 return content;
}

function db_spell_info(e,i,arr,k){
 e.classList.toggle('more_info');
 e = e.children[0].children[1];

 if(e.innerHTML){
  e.innerHTML = '';
  if(!k){e.parentNode.parentNode.children[1].children[0].classList.add('def_hide')}
 }else{
  let content = spell_details(i,arr);
  if(arr[i][12]){content += '<p class="nowrap"><i>Publicação:</i> '+arr[i][12]+'</p>'}
  if(k){
   content += '<button class="spell_add" onclick="add_spell(this)">Adicionar magia</button>';
   content += '<button class="delete spell_delete" onclick="remove_spell(this)">Remover magia</button>';
  }
  e.innerHTML = content;
 }
}

function filter_spells(){
 let e = document.getElementById('all_spells').getElementsByClassName('spells');
 for (var i=0;i<spells.length;i++){
  if(spell_viz[i][0]&&spell_viz[i][1]&&spell_viz[i][2]&&spell_viz[i][3]){e[i].style.display=""}
  else{e[i].style.display="none"}
 }
}

function filter_spell_other(e){
 var k = e.getAttribute('tabindex');
 var filter = e.innerHTML;
 if(!filter){filter=JSON.stringify(spell_inputs[k-1])}
 for (var i=0;i<spells.length;i++){
  if(filter.indexOf(spells[i][k])>-1){spell_viz[i][k]=1}
  else{spell_viz[i][k]=0}
 }
 filter_spells();
}

function filter_spell_name(el){
 var filter = el.value.toUpperCase();
 for (var i=0;i<spells.length;i++){
  var spellname = spells[i][0].toUpperCase();
  if(spellname.indexOf(filter)>-1){spell_viz[i][0]=1}
  else{spell_viz[i][0]=0}
 }
 filter_spells();
}

function clear_spell_filters(){
 let e = document.getElementById('all_spells').getElementsByClassName('more_info');
 while(e.length){
  e[0].children[0].children[1].innerHTML = '';
  e[0].classList.remove('more_info');
 }

 for (var i=0;i<spells.length;i++){spell_viz[i]=[1,1,1,1]}
 cspell_level=[],cspell_class=[],cspell_school=[];

 e = document.getElementById('spell_level');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_class');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_school');e.innerHTML='';
 var d = e.parentNode.children[2].getElementsByClassName('checkmark');
 for(var i=0;i<d.length;i++){d[i].classList.remove("checkmarked");d[i].setAttribute('value',0)}

 e = document.getElementById('spell_name');e.value='';
 filter_spell_name(e);
}

function add_spell(e){
 e = e.parentNode.parentNode.parentNode.cloneNode(true);
 e.removeAttribute('id');
 e.classList.remove('more_info');
 e.children[0].children[1].innerHTML = '';
 document.getElementById('char_spells').appendChild(e);
 data.magias.push(JSON.parse(e.getAttribute('index')));
 save_data();
}

function remove_spell(e){
 e = e.parentNode.parentNode.parentNode;
 let pows = document.getElementById('char_spells').getElementsByClassName('spells');
 let x = Array.prototype.indexOf.call(pows,e);
 data.magias.splice(x,1);
 e.remove();
 save_data();
}

//-------------------------CONFIG FUNCTIONS------------------------//

function invert(color){return (Number(`0x1${color}`)^0xFFFFFF).toString(16).substr(1).toUpperCase()}
function menucolor(color){
 document.querySelector('meta[name="theme-color"]').setAttribute('content',color);
 document.querySelector(':root').style.setProperty('--t20white',data.c_nocturnal?'#000':'#fff');
 document.querySelector(':root').style.setProperty('--t20weight',data.c_nocturnal?'600':'400');
 document.querySelector(':root').style.setProperty('--bright',data.c_nocturnal?'brightness(.9)':'brightness(1.1)');
 color = data.c_nocturnal?invert(color.replace('#','')):color.replace('#','');
 document.querySelector(':root').style.setProperty('--menu','#'+color);
 color = 'url(\''+backborder.replace('backborder',color)+'\') 4% repeat';
 document.querySelector(':root').style.setProperty('--backborder',color);
}

function fullscreen(e){
 if(data.c_fullscreen&&document.fullscreenElement==null){
  if(e.requestFullscreen){e.requestFullscreen()}
  else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}
  else if(e.msRequestFullscreen){e.msRequestFullscreen()}
 }
 if(!data.c_fullscreen&&document.fullscreenElement){
  if(document.exitFullscreen){document.exitFullscreen()}
  else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}
  else if(document.msExitFullscreen){document.msExitFullscreen()}
 }
}

function config(){
 const colorpicker = document.getElementById('c_color');
 data.c_keyboard?keyboard.classList.add('keyext'):keyboard.classList.remove('keyext');

 document.querySelector(':root').style.setProperty('--hph',(data.c_dice&&keyboard.classList.contains('boardshow'))?'256px':'120px');
 document.querySelector(':root').style.setProperty('--drh',data.c_dice?'var(--drb)':'90%');

 if(data.c_magic){
  allmenubtn[4].classList.add('dn');
  sections[4].classList.add('dn');
  if(menubtn.indexOf(4)>0){menubtn.splice(menubtn.indexOf(4),1)}
 }else{
  allmenubtn[4].classList.remove('dn');
  sections[4].classList.remove('dn');
  if(menubtn.indexOf(4)<0){menubtn.splice(menubtn.indexOf(5),0,4)}
 }

 if(data.c_nocturnal){
  document.documentElement.classList.add('invert');colorpicker.classList.add('invert');keyboard.classList.add('invert');
  document.getElementById('hpbar').classList.add('hpinvert');
  document.getElementById('mpbar').classList.add('hpinvert');
  document.querySelector(':root').style.setProperty('--grun','#ca56f0');
  document.querySelector(':root').style.setProperty('--rot','#10ecec');
  document.querySelector(':root').style.setProperty('--opc','0.83');
 }else{
  document.documentElement.classList.remove('invert');colorpicker.classList.remove('invert');keyboard.classList.remove('invert');
  document.getElementById('hpbar').classList.remove('hpinvert');
  document.getElementById('mpbar').classList.remove('hpinvert');
  document.querySelector(':root').style.setProperty('--grun','#35a90f');
  document.querySelector(':root').style.setProperty('--rot','#ef1313');
  document.querySelector(':root').style.setProperty('--opc','0.93');
 }

 fullscreen(document.documentElement);
 menucolor(data.c_color);
}

//-------------------------NAVIGATION FUNCTIONS------------------------//

const sections = document.getElementsByClassName('sec');
const allmenubtn = document.getElementsByClassName('menubtn');
var menubtn = [];
for(var i=0;i<allmenubtn.length;i++){menubtn.push(i)};
document.documentElement.style.setProperty("--menulen",allmenubtn.length*100+"%");

function navig(e){
 for(var i=0;i<allmenubtn.length;i++){
  allmenubtn[i].children[0].children[0].classList.remove('menuselicon');
  allmenubtn[i].children[0].children[1].classList.remove('menuseltext');
 }
 e.children[0].children[0].classList.add('menuselicon');
 e.children[0].children[1].classList.add('menuseltext');

 var x = Array.prototype.indexOf.call(allmenubtn,e);
 x = menubtn.indexOf(x);
 x = window.innerWidth>990&&x==menubtn.length-1?x-1:x;

 document.documentElement.style.setProperty("--menulen",menubtn.length*100+"%");
 document.getElementById('sections').style.transform='translate(-'+x*100/menubtn.length+'%,0)';
 window.scrollTo({top:0,behavior:'smooth'});
}

let touchstartX = 0;
let touchendX = 0;
function deltaX(){var deltaX = touchstartX-touchendX;if(deltaX>200&&x<8){navig(menubtn[x+1])}if(deltaX<-200&&x>0){navig(menubtn[x-1])}}
document.getElementById('sections').addEventListener('touchstart',e=>{touchstartX=e.changedTouches[0].screenX},{passive:true})
document.getElementById('sections').addEventListener('touchend',e=>{touchendX=e.changedTouches[0].screenX;deltaX()},{passive:true})

function hide(e,el){if(el==e.target){el.classList.toggle('invisible');if(el.id=="backdrop_spell"){clear_spell_filters()};if(el.id=="backdrop_power"){clear_powers_filters()}}}
function show(el){document.getElementById(el).classList.toggle('invisible')}
function show_list(e){e.focus();e = e.parentNode.children[2].classList.remove('dn')}

var cspell_level=[],cspell_class=[],cspell_school=[],cclasse=[],cdivindade=[],cdeslocamento=[],cpower_type=[],cpower_cat=[];
function set_check(e,array){
 e.classList.toggle('checkmarked');
 e.setAttribute('value',e.getAttribute('value')==1?0:1)

 if(e.getAttribute('value')==1){array.push(e.innerHTML)}else{array.splice(array.indexOf(e.innerHTML),1)}
 array.sort();

 e = e.parentNode.parentNode.children[0];
 e.innerHTML = array.join(', ');

 var c = e.parentNode.parentNode.parentNode.parentNode.parentNode.id;
 if(e.getAttribute('inner')){data_inner(e)}
 if(e.getAttribute('str')){data_str(e)}
 else if(c=="backdrop_power"){filter_powers_other(e)}
 else if(c=="backdrop_spell"){filter_spell_other(e)}
}

window.addEventListener('click',function(e){
 var el = document.getElementsByClassName('dropdown');
 for (i=0;i<el.length;i++){
  if(!el[i].parentNode.contains(e.target)){el[i].parentNode.children[2].classList.add("dn")}
 }
 window.focus();
});
document.addEventListener('touchstart',e=>{if(data.c_vibrate){navigator.vibrate(75)}})

//-------------------------CHARACTERS FUNCTIONS------------------------//

function char_create(e){
 if(e.title){
  e.parentNode.classList.add('dn');
  clear();
  title = e.title;
  chars.push(title);
  data.char=title;
  document.getElementById('char').value=title;
  document.getElementById('chardel').disabled = false;
  document.title = title + ' - T20';
  attack_add_start();
  equip_kit();
  document.getElementById('c_color').value = '#b72a2b';
  console.log('Character '+title+' was created');
  save_data();
 }
}

function char_set(el){
 if(title){save_data()}
 clear();
 title = el.innerHTML;
 el.parentNode.classList.add('dn');
 data_load();
 document.title = title + ' - T20';
 document.getElementById('chardel').disabled = false;
 data_set();
 console.log('Character '+title+' was loaded');
}

function char_remove(){
 if(title){
  chars.splice(chars.indexOf(title),1);
  localStorage.T20chars = chars;
  localStorage.removeItem('T20data_'+title);
  console.log('Character '+title+' was removed');
  clear();
  document.title = 'Ficha T20 Mobile - v1.6.3';
  document.getElementById('chardel').disabled = true;
 }
}

function char_list(el){
 var value = el.value;
 el = el.parentNode.children[2];
 if(value||chars.length){el.classList.remove('dn')}
 if(!value&&!chars.length){el.classList.add('dn')}
 el.innerHTML = '';
 if(value&&chars.indexOf(value)){el.innerHTML = '<a onclick="char_create(this)" title="'+value+'">Clique para criar '+value+'</a>'}
 for(var i=0;i<chars.length;i++){el.innerHTML += '<a onclick="char_set(this)">'+chars[i]+'</a>'}
}

//-------------------------STARTER FUNCTIONS------------------------//

function create_select(array){
 for (j=0;j<array.length;j++){
  var div = document.createElement('option');
  if(j){div.setAttribute('value',j);div.innerHTML = array[j]}
  else{div.setAttribute('disabled','');div.setAttribute('selected','')}
  document.getElementById(array[0]).appendChild(div);
 }
}

function create_checkbox(array){
 let q = '';
 for(var j=1;j<array.length;j++){q += '<a class="'+(JSON.stringify(array[j]).includes('—')?' gray">':'checkmark" onclick="set_check(this,c'+array[0]+')" value="0">')+array[j]+'</a>'}
 document.getElementById(array[0]).parentNode.children[2].innerHTML = q;
}

function create_habs(){
 var e = document.getElementById('habilidades').children[0].children[0];
 for (var i=1;i<habs.length;i++){
  if(i>=habs.length/2){e = e.parentNode.children[1]}
  var div = document.createElement('div');
  div.setAttribute('class','w10 dif');
  var content = '<div class="w2 dif"><div class="hab_label">'+habs[i].toUpperCase()+'</div></div>';
  content += '<div class="w4"><div class="input"><input id="hab_'+habs[i]+'_val" class="tc hab" inputmode="numeric" onkeyup="regex2(this)" onchange="data_add(this);calc_hab()" autocomplete="off" required></div></div>';
  content += '<div class="w2 dif" onclick="startroll(\'hab_'+habs[i]+'\')"><div class="dice" data-dice="d20"></div></div>';
  content += '<div class="w2 dif"><p id="hab_'+habs[i]+'" class="ma0" sign="1">+0</p></div>';
  div.innerHTML = content;
  e.appendChild(div);
 }
}

function start_up(){
 menucolor('#b72a2b');
 create_habs();
 const menuicon = document.getElementsByClassName('menuicon');
 for (var i=0;i<menuicon.length;i++){menuicon[i].innerHTML = icons[i]}
 for (var i=0;i<inputs.length;i++){create_select(inputs[i])}
 create_checkbox(classe);
 create_checkbox(divindade);
 create_checkbox(deslocamento);
 for (var i=0;i<spell_inputs.length;i++){create_checkbox(spell_inputs[i])}
 for (var i=0;i<power_inputs.length;i++){create_checkbox(power_inputs[i])}
 let supported = testWorker();
 populate(supported);
 create_lists(supported);
 for (var i=0;i<conditions.length;i++){list_conditions('conditions',i,conditions)}
 list_skills(skills,i,'skills');
 list_skills(crafts,i,'crafts');
 list_rd();
 set_keyboard();
 dice = document.getElementsByClassName('dice');
 for (var i=0;i<dice.length;i++){dice[i].innerHTML = dices[dice[i].getAttribute("data-dice")]}
 chars = localStorage.T20chars?JSON.parse(localStorage.T20chars):[];
 if(!chars.length){hints.forEach(showhint)}
 document.body.classList.remove('dn');
}

//-------------------------DATA MANAGEMENT FUNCTIONS------------------------//

function data_add(e){data[e.id]=JSON.parse(e.value);save_data()}
function data_array(e){data[e.id]=e.value;save_data()}
function data_check(e){data[e.id]=e.checked;save_data()}
function data_inner(e){var value = e.innerHTML.replace('+','');data[e.id]=JSON.parse(value);save_data()}
function data_str(e){data[e.id]=e.innerHTML;save_data()}

function data_set(){
 for (const key in data){
  if(key=='magias'){
   for (var i=0;i<data.magias.length;i++){list_spells('char_spells',data.magias[i])}
  }else if(key=='user_spells'){
   for (var i=0;i<data.user_spells.length;i++){list_user_spell(i)}
  }else if(key=='powers'){
   for (var i=0;i<data.powers.length;i++){list_powers('powers',data.powers[i],powers)}
  }else if(key=='user_powers'){
   for (var i=0;i<data.user_powers.length;i++){list_powers('user_powers',i,data.user_powers)}
  }else if(key=='defense'){
   for (let i in data.defense){document.getElementById(i).value=data.defense[i]}
  }else if(key=='skills'||key=='crafts'||key=='cond'||key=='cond_user'){ //do nothing
  }else if(key=='conditions'){
   var conds = document.getElementById('conditions').getElementsByClassName('condmark');
   for (var i=0;i<conds.length;i++){if(data.conditions[0][i]){conds[i].classList.add('condmarked');cond_info(conds[i].parentNode.children[1],conditions)}}
   for (var i=0;i<data.cond_user.length;i++){list_conditions('cond_user',i,data.cond_user)}
   conds = document.getElementById('cond_user').getElementsByClassName('condmark');
   for (var i=0;i<conds.length;i++){if(data.conditions[1][i]){conds[i].classList.add('condmarked');cond_info(conds[i].parentNode.children[1],data.cond_user)}}
  }else if(key=='attack'){for (var i=0;i<data.attack.length;i++){attack_list(i)}
  }else if(key=='equip'){for(var i=0;i<data.equip.length;i++){equip_add(data.equip[i][0],data.equip[i][1],data.equip[i][2],data.equip[i][3],data.equip[i][4],data.equip[i][5])}equip_calc()
  }else{
   var e=document.getElementById(key);
   if(e.getAttribute('sign')){e.innerHTML=add_plus_sign(data[key])}
   else if(e.getAttribute('inner')){e.innerHTML=data[key]}
   else if(e.getAttribute('str')){e.innerHTML=data[key]}
   else if(e.type=='checkbox'){e.checked=data[key]}
   else{e.value=data[key]}
  }
 }
 title=data.char;
 document.title = title + ' - T20';
 document.getElementById('c_color').value = data.c_color?data.c_color:'#b72a2b';
 document.getElementById('chardel').disabled = false;
 document.getElementById('sections').style.transform='';
 config();
 calc_hab();
 bars()
}

window.onload = function(){
 start_up();
 if(localStorage.T20chars){chars = JSON.parse(localStorage.T20chars)}
}

window.addEventListener('beforeunload',save_data);
function save_data(){
 if(chars.length){localStorage.setItem('T20chars',JSON.stringify(chars))}
 if(title){localStorage.setItem('T20data_'+title,JSON.stringify(data))}
 console.log('Saved data in local storage');
}

function check_empty(){		//backwards compatibility
 if(!data.magias){data.magias=[]}
 if(!data.user_spells){data.user_spells=[]}
 if(!data.powers){data.powers=[]}
 if(!data.user_powers){data.user_powers=[]}
 if(!data.skills){data.skills=skills}
 if(!data.crafts){data.crafts=crafts}
 if(!data.defense){data.defense=structuredClone(data_ini.defense)}
 if(!data.attack){data.attack=[]}
 if(!data.equip){data.equip=[]}
 if(!data.carga){data.carga=structuredClone(data_ini.carga)}
 if(!data.conditions){data.conditions=[[],[]]}
 if(!data.cond){data.cond=structuredClone(data_ini.cond)}
 if(!data.cond_user){data.cond_user=[]}
}

function data_load(){
 if(localStorage.getItem('T20data_'+title)){
  data = JSON.parse(localStorage.getItem('T20data_'+title));
  check_empty();
 }
}

function clear(){
 title='';

 let inner = ['char_spells','user_spells','powers','user_powers','char_attack','char_equip','anot','cond_user','conditions','char_skills','char_crafts'];
 inner.forEach(function(i){document.getElementById(i).innerHTML = ''});

 let check = ['c_keyboard','c_dice','c_fullscreen','c_nocturnal','c_vibrate'];
 check.forEach(function(i){document.getElementById(i).checked = false});

 let val = ['to','ts','tc'];
 val.forEach(function(i){document.getElementById(i).value = 0});

 document.getElementById('carga').innerHTML = 0;
 document.getElementById('carga_cap').value = 10;
 document.getElementById('deslocamento').parentNode.children[3].innerHTML = '';

 list_skills(skills,i,'skills');
 list_skills(crafts,i,'crafts');
 for (var i=0;i<conditions.length;i++){list_conditions('conditions',i,conditions)}

 let input = document.getElementsByTagName("input");
 for(let e of input){if(e.id!='file'){e.value=(e.id=="c_color"?'#b72a2b':'')}}
 menucolor('#b72a2b');

 let select = document.getElementsByTagName("select");
 for(let e of select){option = e.options;option[0].selected = true}

 let fakeinput = document.getElementsByClassName('fakeinput');
 for(let e of fakeinput){e.innerHTML=(e.id.includes('hp')||e.id.includes('mp'))?0:''}

 data = structuredClone(data_ini);
}

function import_char(e){
 clear();
 if(!window.FileReader) return; //Browser is not compatible
 let reader = new FileReader();
 reader.onload = function(e){
  console.log('File loaded successfully');
  data = JSON.parse(e.target.result);
  check_empty();
  chars.push(data.char);
  data_set();
  console.log('Character '+data.char+' data imported');
 };
 reader.onerror = function(){alert('Error reading file, please try again')}
 reader.readAsText(e.target.files[0]);
}

function export_char(){
 var filename = (title?'char_'+title:'unnamed_char') +'.txt';
 var filedata = JSON.stringify(data);
 var file = new Blob([filedata], {type:'text/plain'});
 if (window.navigator.msSaveOrOpenBlob) // IE10+
     window.navigator.msSaveOrOpenBlob(file, filename);
 else{
  var a = document.createElement("a"),url = URL.createObjectURL(file);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(function() {
   document.body.removeChild(a);
   window.URL.revokeObjectURL(url);
  }, 0);
 }
 console.log('Character '+title+' data exported');
}

function reset(){
 for(let i in chars){localStorage.removeItem('T20data_'+chars[i])}
 localStorage.removeItem('T20chars');
 chars=[];data={};title='';location.reload()
}

//-------------------------HINT FUNCTIONS------------------------//

function showhint(arr,j){
 let div = document.createElement('div');
 div.setAttribute('class','hint hint'+j);
 div.setAttribute('onclick','event.stopPropagation();this.remove()');
 div.innerHTML = arr[2];
 e = document.getElementById(arr[0])
 for(let i = 0;i<arr[1];i++){e = e.parentNode}
 e.appendChild(div);
}

const hints = [
['char',2,'Comece criando ou carregando um personagem, para isso entre com um nome de personagem e clique na opção "Cliqui para criar", quaisquer edições feitas antes disso serão perdidas.'],
['drawer',1,'Clique na barra cinza para abrir e fechar os marcadores de PVs e PMs, e o rolador de dados.'],
['drawer',1,'Role o menu horizontalmente para acessar as demais sessões.']
//['dice1',2,'Clique no dado para rolar o referido teste sempre que quiser, o rolador de dados mostrará o resultado.']
];

//-------------------------PRINT PDF FUNCTIONS------------------------//

function printPDF(){
 if(data.char){
  console.log('Sending character '+data.char+' to print environment');
  //https://marmarx.github.io/t20web;
  window.open('./print.html?char='+data.char);
 }
}

//-------------------------REGEX FUNCTIONS------------------------//

function regexe(e){['e','E'].includes(e.key)&&e.preventDefault()}
function regex_inj(e){e.value=/[<>\[\]\{\}\#&]+/.test(e.value)?e.value.slice(0,-1):e.value}
function regexo(e){e.value=/^([+-]|[0-9]|[d])*$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexb2(e){e.value=='d'?'d':e.value=/^([d]|[0-9])*$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexc1(e){e.value=/^([1-9]|1[0-9]|20)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexc2(e){e.value=='x'?'x':e.value=/^x(100|[1-9][0-9]?)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regex(e){e.value = (e.value=='-'?'-':(e.value=='+'?'+':(/^[-+]?(0|[1-9]\d*)$/.test(e.value)?e.value:e.value.slice(0,-1))))}
function regex2(e){e.value=/^(0|[1-9]\d*)$/.test(e.value)?e.value:e.value.slice(0,-1)}
function regexqte(e){e.value=/(\d)*$/.test(e.value)?e.value:e.value.slice(0,-1)}

if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js',{ scope:'/'})}
</script>
</body>
</html>
